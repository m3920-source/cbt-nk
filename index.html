<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT SD IT Nurul Kautsar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .timer-warning { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .question-nav-btn { transition: all 0.3s ease; }
        .question-nav-btn.answered { background-color: #10b981; color: white; }
        .question-nav-btn.current { background-color: #3b82f6; color: white; }
        .question-nav-btn.unanswered { background-color: #e5e7eb; color: #374151; }
        .question-nav-btn:hover { transform: scale(1.05); }
        .modal-backdrop { backdrop-filter: blur(4px); }
        .login-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .login-box {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container flex items-center justify-center p-4">
        <div class="login-box bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="bg-blue-600 text-white py-4 px-6 rounded-xl mb-6">
                    <h1 class="text-2xl font-bold">SD IT NURUL KAUTSAR</h1>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Selamat Datang</h2>
            </div>
            
            <!-- Login Form -->
            <form id="loginForm" class="space-y-6">
                <div id="loginError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                
                <div>
                    <input type="text" id="username" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" 
                           placeholder="Username">
                </div>
                
                <div class="relative">
                    <input type="password" id="password" required 
                           class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" 
                           placeholder="Password">
                    <button type="button" id="togglePasswordVisibility" class="absolute inset-y-0 right-0 flex items-center px-4 text-gray-600">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 font-semibold text-lg">
                    Login
                </button>
            </form>
            

        </div>
    </div>

    <!-- Dashboard Interface -->
    <div id="dashboardInterface" class="hidden min-h-screen bg-gray-100">
        <!-- Header -->
        <header class="bg-blue-600 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <div class="bg-white rounded-full w-10 h-10 flex items-center justify-center mr-3">
                            <i class="fas fa-graduation-cap text-blue-600"></i>
                        </div>
                        <h1 class="text-xl font-bold">SD IT NURUL KAUTSAR</h1>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-sm font-medium" id="dashboardUserInfo">Nama User</p>
                            <p class="text-xs text-blue-200" id="dashboardUserRole">Role</p>
                        </div>
                        <button id="dashboardLogoutBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200">
                            <i class="fas fa-sign-out-alt mr-2"></i>Keluar
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Menu -->
        <nav class="bg-blue-700 text-white">
            <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
                <div class="flex flex-wrap space-x-8" id="dashboardNav">
                    <!-- Navigation items will be populated by JavaScript -->
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="w-full px-2 sm:px-6 lg:px-8 lg:max-w-7xl lg:mx-auto py-8">
            <div id="dashboardContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </main>
    </div>

    <!-- Exam Interface -->
    <div id="examInterface" class="hidden min-h-screen bg-gray-100">
        <!-- Header -->
        <header class="bg-blue-600 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <div class="bg-white rounded-full w-10 h-10 flex items-center justify-center mr-3">
                            <i class="fas fa-graduation-cap text-blue-600"></i>
                        </div>
                        <h1 class="text-xl font-bold">SD IT NURUL KAUTSAR</h1>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-sm font-medium" id="examUserInfo">Nama Siswa</p>
                            <p class="text-xs text-blue-200">Ujian Berlangsung</p>
                        </div>
                        <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200">
                            <i class="fas fa-sign-out-alt mr-2"></i>Keluar
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Timer and Controls -->
        <div class="bg-white border-b shadow-sm">
            <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8 py-4">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div class="flex items-center space-x-4">
                        <div class="bg-red-500 text-white px-4 py-2 rounded-lg font-bold timer-warning">
                            <i class="fas fa-clock mr-2"></i>
                            <span id="examTimer">01:00:00</span>
                        </div>
                        <button id="questionListBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-list mr-2"></i>Daftar Soal
                        </button>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-600 font-medium">Soal <span id="currentQuestionNum">1</span> dari <span id="totalQuestions">25</span></span>
                        <button id="submitExamBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                            <i class="fas fa-paper-plane mr-2"></i>Selesai
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Question Content -->
        <div class="w-full px-2 sm:px-4 lg:px-8 lg:max-w-5xl lg:mx-auto py-8">
            <div class="bg-white rounded-xl shadow-lg p-4 sm:p-8">
                <div id="questionContent">
                    <!-- Question content will be populated by JavaScript -->
                </div>
                
                <!-- Navigation Buttons -->
                <div class="flex flex-col sm:flex-row sm:justify-between items-center mt-8 pt-6 border-t border-gray-200 space-y-4 sm:space-y-0">
                    <button id="prevQuestionBtn" class="w-full sm:w-auto bg-gray-600 text-white px-8 py-3 rounded-lg hover:bg-gray-700 transition duration-200 font-medium">
                        <i class="fas fa-chevron-left mr-2"></i>Soal Sebelumnya
                    </button>
                    
                    <div class="text-center hidden sm:block">
                        <div class="text-sm text-gray-500 mb-2">Progress</div>
                        <div class="w-48 bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 4%"></div>
                        </div>
                    </div>
                    
                    <button id="nextQuestionBtn" class="w-full sm:w-auto bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                        Soal Selanjutnya<i class="fas fa-chevron-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Question List Modal -->
    <div id="questionListModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-bold text-gray-800">Daftar Soal</h3>
                <button id="closeQuestionListBtn" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <div id="questionNavigation" class="grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 gap-4 mb-6">
                    <!-- Question navigation buttons will be populated by JavaScript -->
                </div>
                <div class="flex items-center justify-center space-x-8 text-sm">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-green-500 rounded-full mr-2"></div>
                        <span class="text-gray-700">Sudah dijawab</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-blue-500 rounded-full mr-2"></div>
                        <span class="text-gray-700">Sedang dikerjakan</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-gray-300 rounded-full mr-2"></div>
                        <span class="text-gray-700">Belum dijawab</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Management Modal -->
    <div id="managementModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-bold text-gray-800" id="modalTitle">Modal Title</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6" id="modalContent">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="bg-red-100 rounded-full p-3 mr-4">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800" id="confirmTitle">Konfirmasi</h3>
                </div>
                <p class="text-gray-600 mb-6" id="confirmMessage">Apakah Anda yakin?</p>
                <div class="flex justify-end space-x-3">
                    <button id="confirmCancelBtn" class="px-4 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Batal
                    </button>
                    <button id="confirmOkBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        Ya, Lanjutkan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // FIREBASE CONFIGURATION
        // =================================================================
        // PASTE KONFIGURASI FIREBASE ANDA DI SINI
        const firebaseConfig = {
            apiKey: "AIzaSyB8C9Y_i02CRiroLqwkImf9hw49_4Kxx-A",
            authDomain: "cbt-nurul-kautsar.firebaseapp.com",
            projectId: "cbt-nurul-kautsar",
            storageBucket: "cbt-nurul-kautsar.firebasestorage.app",
            messagingSenderId: "862806304239",
            appId: "1:862806304239:web:d2a11dc542450e9b22021a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth(); // Firebase Auth instance

        // =================================================================
        // APPLICATION STATE
        // =================================================================
        const AppState = {
            currentUser: null,
            currentQuestion: 0,
            examAnswers: {},
            examTimer: null,
            examTimeLeft: 3600, // 60 minutes in seconds
            questions: [], // This will be populated from Firestore for the current exam
            currentView: 'login',
            selectedExamCode: null,
            lastQuestionData: {}, // To store last used question data for teacher
            filters: {
                questions: { kelas: '', mataPelajaran: '', kode: '' },
                results: { kodesoal: '', mataPelajaran: '', kelas: '', namaLengkap: '' },
                grades: { kodeSoal: '', mataPelajaran: '', kelas: '', namaSiswa: '' }
            },
            currentlyDisplayed: {
                questions: [],
                results: [],
                grades: []
            },
            // Users are now fetched from Google Script
            users: [],
            // Classes and Subjects remain local
            classes: [
                { id: 1, nama: '4A', deskripsi: 'Kelas 4A' }, { id: 2, nama: '4B', deskripsi: 'Kelas 4B' },
                { id: 3, nama: '4C', deskripsi: 'Kelas 4C' }, { id: 4, nama: '4D', deskripsi: 'Kelas 4D' },
                { id: 5, nama: '5A', deskripsi: 'Kelas 5A' }, { id: 6, nama: '5B', deskripsi: 'Kelas 5B' },
                { id: 9, nama: '6A', deskripsi: 'Kelas 6A' }, { id: 10, nama: '6B', deskripsi: 'Kelas 6B' }
            ],
            subjects: [
                { id: 1, nama: 'Bahasa Indonesia', deskripsi: 'Mata pelajaran Bahasa Indonesia' },
                { id: 2, nama: 'Matematika', deskripsi: 'Mata pelajaran Matematika' },
                { id: 3, nama: 'Bahasa Inggris', deskripsi: 'Mata pelajaran Bahasa Inggris' },
                { id: 4, nama: 'Pend. Pancasila', deskripsi: 'Mata pelajaran Pend. Pancasila' },
                { id: 5, nama: 'IPAS', deskripsi: 'Mata pelajaran IPAS' },
                { id: 6, nama: 'Seni Rupa', deskripsi: 'Mata pelajaran Seni Rupa' },
                { id: 7, nama: 'Tauhid', deskripsi: 'Mata pelajaran Tauhid' },
                { id: 8, nama: 'Bahasa Arab', deskripsi: 'Mata pelajaran Bahasa Arab' },
                { id: 9, nama: 'Fikih', deskripsi: 'Mata pelajaran Fikih' },
                { id: 10, nama: 'Siroh', deskripsi: 'Mata pelajaran Siroh' },
                { id: 11, nama: 'Akhlak', deskripsi: 'Mata pelajaran Akhlak' },
                { id: 12, nama: 'Hadits', deskripsi: 'Mata pelajaran Hadits' },
                { id: 13, nama: 'Khot', deskripsi: 'Mata pelajaran Khot' },
                { id: 14, nama: 'PJOK', deskripsi: 'Mata pelajaran PJOK' }
            ]
        };
        
        // =================================================================
        // DATA FETCHING
        // =================================================================
        async function fetchUsersFromGoogleScript() {
            const url = 'https://script.google.com/macros/s/AKfycbzRK2tuR7Q5y4wtERhXRs0ekRRZ0y3_1zMEd5LlYwZdg9_2rUGRCAukw73926LWggwZ/exec';
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                if (result.status === 'success' && Array.isArray(result.data)) {
                    // Add a unique local ID to each user for easier management
                    AppState.users = result.data.map((user, index) => ({
                        ...user,
                        id: `gs-user-${index}`
                    }));
                    console.log('User data loaded successfully from Google Script.');
                    return true;
                } else {
                    throw new Error('Invalid data format received from Google Script.');
                }
            } catch (error) {
                console.error('Failed to fetch user data:', error);
                const loginError = document.getElementById('loginError');
                loginError.textContent = 'Gagal memuat data pengguna. Silakan muat ulang halaman.';
                loginError.classList.remove('hidden');
                return false;
            }
        }


        // =================================================================
        // MANAGEMENT SYSTEM (with Firebase Integration)
        // =================================================================
        const Management = {
            generateId() {
                return 'id-' + Date.now() + Math.random().toString(36).substr(2, 9);
            },

            // User, Class, Subject management remain local as requested
            showAddUserModal() {
                const content = `
                    <form id="addUserForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input type="text" name="username" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input type="password" name="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" name="nama" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                <select name="role" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="this.value === 'siswa' ? document.getElementById('kelasField').classList.remove('hidden') : document.getElementById('kelasField').classList.add('hidden')">
                                    <option value="">Pilih Role</option>
                                    <option value="admin">Admin</option>
                                    <option value="guru">Guru</option>
                                    <option value="siswa">Siswa</option>
                                </select>
                            </div>
                        </div>
                        <div id="kelasField" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                            <select name="kelas" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Pilih Kelas</option>
                                ${AppState.classes.map(c => `<option value="${c.nama}">${c.nama}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan</button>
                        </div>
                    </form>
                `;
                UI.showModal('Tambah Pengguna', content);
                
                document.getElementById('addUserForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const userData = Object.fromEntries(formData);
                    
                    if (userData.role !== 'siswa') {
                        userData.kelas = '';
                    }
                    
                    AppState.users.push({
                        id: this.generateId(),
                        ...userData
                    });
                    
                    UI.hideModal();
                    UI.showUserManagement();
                    UI.showNotification('Pengguna berhasil ditambahkan! Perubahan hanya bersifat lokal.', 'success');
                });
            },

            viewUser(id) {
                const user = AppState.users.find(u => u.id == id);
                const content = `
                    <div class="space-y-4">
                        <div><strong>Username:</strong> ${user.username}</div>
                        <div><strong>Nama:</strong> ${user.nama}</div>
                        <div><strong>Role:</strong> ${user.role}</div>
                        <div><strong>Kelas:</strong> ${user.kelas || '-'}</div>
                    </div>
                    <div class="flex justify-end pt-4">
                        <button onclick="UI.hideModal()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Tutup</button>
                    </div>
                `;
                UI.showModal('Detail Pengguna', content);
            },

            editUser(id) {
                const user = AppState.users.find(u => u.id == id);
                const content = `
                    <form id="editUserForm" class="space-y-4">
                        <input type="hidden" name="id" value="${user.id}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input type="text" name="username" value="${user.username}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input type="password" name="password" value="${user.password}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" name="nama" value="${user.nama}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                <select name="role" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="this.value === 'siswa' ? document.getElementById('editKelasField').classList.remove('hidden') : document.getElementById('editKelasField').classList.add('hidden')">
                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                    <option value="guru" ${user.role === 'guru' ? 'selected' : ''}>Guru</option>
                                    <option value="siswa" ${user.role === 'siswa' ? 'selected' : ''}>Siswa</option>
                                </select>
                            </div>
                        </div>
                        <div id="editKelasField" class="${user.role === 'siswa' ? '' : 'hidden'}">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                            <select name="kelas" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Pilih Kelas</option>
                                ${AppState.classes.map(c => `<option value="${c.nama}" ${user.kelas === c.nama ? 'selected' : ''}>${c.nama}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update</button>
                        </div>
                    </form>
                `;
                UI.showModal('Edit Pengguna', content);
                
                document.getElementById('editUserForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const userData = Object.fromEntries(formData);
                    
                    if (userData.role !== 'siswa') {
                        userData.kelas = '';
                    }
                    
                    const index = AppState.users.findIndex(u => u.id == userData.id);
                    if (index !== -1) {
                        AppState.users[index] = { ...AppState.users[index], ...userData };
                        UI.hideModal();
                        UI.showUserManagement();
                        UI.showNotification('Pengguna berhasil diupdate! Perubahan hanya bersifat lokal.', 'success');
                    }
                });
            },

            deleteUser(id) {
                UI.showConfirmModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus pengguna ini? Perubahan hanya bersifat lokal.', () => {
                    AppState.users = AppState.users.filter(u => u.id != id);
                    UI.showUserManagement();
                    UI.showNotification('Pengguna berhasil dihapus secara lokal!', 'success');
                });
            },

            showAddClassModal() {
                const content = `
                    <form id="addClassForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kelas</label>
                            <input type="text" name="nama" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: 1A">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                            <textarea name="deskripsi" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Deskripsi kelas"></textarea>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan</button>
                        </div>
                    </form>
                `;
                UI.showModal('Tambah Kelas', content);
                
                document.getElementById('addClassForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const classData = Object.fromEntries(formData);
                    
                    AppState.classes.push({
                        id: this.generateId(),
                        ...classData
                    });
                    
                    UI.hideModal();
                    UI.showClassManagement();
                    UI.showNotification('Kelas berhasil ditambahkan!', 'success');
                });
            },

            editClass(id) {
                const cls = AppState.classes.find(c => c.id == id);
                const content = `
                    <form id="editClassForm" class="space-y-4">
                        <input type="hidden" name="id" value="${cls.id}">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kelas</label>
                            <input type="text" name="nama" value="${cls.nama}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                            <textarea name="deskripsi" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${cls.deskripsi}</textarea>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update</button>
                        </div>
                    </form>
                `;
                UI.showModal('Edit Kelas', content);
                
                document.getElementById('editClassForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const classData = Object.fromEntries(formData);
                    
                    const index = AppState.classes.findIndex(c => c.id == classData.id);
                    if (index !== -1) {
                        AppState.classes[index] = { ...AppState.classes[index], ...classData };
                        UI.hideModal();
                        UI.showClassManagement();
                        UI.showNotification('Kelas berhasil diupdate!', 'success');
                    }
                });
            },

            deleteClass(id) {
                UI.showConfirmModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus kelas ini?', () => {
                    AppState.classes = AppState.classes.filter(c => c.id != id);
                    UI.showClassManagement();
                    UI.showNotification('Kelas berhasil dihapus!', 'success');
                });
            },

            showAddSubjectModal() {
                const content = `
                    <form id="addSubjectForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Mata Pelajaran</label>
                            <input type="text" name="nama" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Matematika">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                            <textarea name="deskripsi" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Deskripsi mata pelajaran"></textarea>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan</button>
                        </div>
                    </form>
                `;
                UI.showModal('Tambah Mata Pelajaran', content);
                
                document.getElementById('addSubjectForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const subjectData = Object.fromEntries(formData);
                    
                    AppState.subjects.push({
                        id: this.generateId(),
                        ...subjectData
                    });
                    
                    UI.hideModal();
                    UI.showSubjectManagement();
                    UI.showNotification('Mata pelajaran berhasil ditambahkan!', 'success');
                });
            },

            editSubject(id) {
                const subject = AppState.subjects.find(s => s.id == id);
                const content = `
                    <form id="editSubjectForm" class="space-y-4">
                        <input type="hidden" name="id" value="${subject.id}">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Mata Pelajaran</label>
                            <input type="text" name="nama" value="${subject.nama}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                            <textarea name="deskripsi" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${subject.deskripsi}</textarea>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update</button>
                        </div>
                    </form>
                `;
                UI.showModal('Edit Mata Pelajaran', content);
                
                document.getElementById('editSubjectForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const subjectData = Object.fromEntries(formData);
                    
                    const index = AppState.subjects.findIndex(s => s.id == subjectData.id);
                    if (index !== -1) {
                        AppState.subjects[index] = { ...AppState.subjects[index], ...subjectData };
                        UI.hideModal();
                        UI.showSubjectManagement();
                        UI.showNotification('Mata pelajaran berhasil diupdate!', 'success');
                    }
                });
            },

            deleteSubject(id) {
                UI.showConfirmModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus mata pelajaran ini?', () => {
                    AppState.subjects = AppState.subjects.filter(s => s.id != id);
                    UI.showSubjectManagement();
                    UI.showNotification('Mata pelajaran berhasil dihapus!', 'success');
                });
            },

            // =================================================================
            // Question Management (Firebase Integration)
            // =================================================================
            showAddQuestionModal() {
                const lastData = AppState.lastQuestionData;
                let classOptions = '';
                if (AppState.currentUser.role === 'guru' && AppState.currentUser.kelas) {
                    const teacherGrade = AppState.currentUser.kelas.charAt(0);
                    const availableClasses = AppState.classes.filter(c => c.nama.startsWith(teacherGrade));
                    classOptions = availableClasses.map(c => `<option value="${c.nama}" ${lastData.kelas === c.nama ? 'selected' : ''}>${c.nama}</option>`).join('');
                } else { // Admin sees all classes
                    classOptions = AppState.classes.map(c => `<option value="${c.nama}" ${lastData.kelas === c.nama ? 'selected' : ''}>${c.nama}</option>`).join('');
                }

                const content = `
                    <form id="addQuestionForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kode Soal</label>
                                <input type="text" name="kode" value="${lastData.kode || ''}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: PAI001">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select name="kelas" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Kelas</option>
                                    ${classOptions}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <select name="mataPelajaran" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Mata Pelajaran</option>
                                    ${AppState.subjects.map(s => `<option value="${s.nama}" ${lastData.mataPelajaran === s.nama ? 'selected' : ''}>${s.nama}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipe Soal</label>
                            <select id="questionTypeSelect" name="tipe" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="this.value === 'pilihan_ganda' ? document.getElementById('pilihanField').classList.remove('hidden') : document.getElementById('pilihanField').classList.add('hidden')">
                                <option value="">Pilih Tipe Soal</option>
                                <option value="pilihan_ganda" ${lastData.tipe === 'pilihan_ganda' ? 'selected' : ''}>Pilihan Ganda</option>
                                <option value="isian" ${lastData.tipe === 'isian' ? 'selected' : ''}>Isian</option>
                                <option value="uraian" ${lastData.tipe === 'uraian' ? 'selected' : ''}>Uraian</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pertanyaan</label>
                            <textarea name="pertanyaan" rows="4" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan pertanyaan"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Upload Gambar (Opsional)</label>
                            <input type="file" id="gambarInput" name="gambar" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Ukuran gambar maksimal 10cm x 10cm</p>
                        </div>
                        <div id="pilihanField" class="${lastData.tipe === 'pilihan_ganda' ? '' : 'hidden'} space-y-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pilihan Jawaban</label>
                            <input type="text" name="pilihan1" placeholder="Pilihan A" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" name="pilihan2" placeholder="Pilihan B" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" name="pilihan3" placeholder="Pilihan C" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" name="pilihan4" placeholder="Pilihan D" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <select name="jawabanBenar" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Pilih Jawaban Benar</option>
                                <option value="0">A</option>
                                <option value="1">B</option>
                                <option value="2">C</option>
                                <option value="3">D</option>
                            </select>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan</button>
                        </div>
                    </form>
                `;
                UI.showModal('Tambah Soal', content);
                
                document.getElementById('addQuestionForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const submitButton = form.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...';

                    const formData = new FormData(form);
                    const questionData = Object.fromEntries(formData);
                    
                    const fileInput = document.getElementById('gambarInput');
                    if (fileInput.files[0]) {
                        questionData.gambar = await UI.toBase64(fileInput.files[0]);
                    } else {
                        questionData.gambar = null;
                    }

                    if (questionData.tipe === 'pilihan_ganda') {
                        questionData.pilihan = [
                            questionData.pilihan1,
                            questionData.pilihan2,
                            questionData.pilihan3,
                            questionData.pilihan4
                        ].filter(p => p);
                        questionData.correct = parseInt(questionData.jawabanBenar);
                        delete questionData.pilihan1;
                        delete questionData.pilihan2;
                        delete questionData.pilihan3;
                        delete questionData.pilihan4;
                        delete questionData.jawabanBenar;
                    }
                    
                    try {
                        // Add timestamp for ordering
                        questionData.createdAt = firebase.firestore.FieldValue.serverTimestamp(); 
                        
                        // Firebase Integration: Add question to Firestore
                        await db.collection('examQuestions').add(questionData);
                        AppState.lastQuestionData = {
                            kode: questionData.kode,
                            kelas: questionData.kelas,
                            mataPelajaran: questionData.mataPelajaran,
                            tipe: questionData.tipe
                        };
                        UI.hideModal();
                        UI.showNotification('Soal berhasil ditambahkan', 'success');
                    } catch (error) {
                        console.error("Error adding document: ", error);
                        UI.showNotification('Gagal menambahkan soal!', 'error');
                    } finally {
                         submitButton.disabled = false;
                         submitButton.innerHTML = 'Simpan';
                    }
                });
            },

            async editQuestion(id) {
                try {
                    // Firebase Integration: Get question from Firestore
                    const doc = await db.collection('examQuestions').doc(id).get();
                    if (!doc.exists) {
                        UI.showNotification('Soal tidak ditemukan', 'error');
                        return;
                    }
                    const question = { id: doc.id, ...doc.data() };
                    
                    let classOptions = '';
                    if (AppState.currentUser.role === 'guru' && AppState.currentUser.kelas) {
                        const teacherGrade = AppState.currentUser.kelas.charAt(0);
                        const availableClasses = AppState.classes.filter(c => c.nama.startsWith(teacherGrade));
                        classOptions = availableClasses.map(c => `<option value="${c.nama}" ${question.kelas === c.nama ? 'selected' : ''}>${c.nama}</option>`).join('');
                    } else { // Admin sees all classes
                        classOptions = AppState.classes.map(c => `<option value="${c.nama}" ${question.kelas === c.nama ? 'selected' : ''}>${c.nama}</option>`).join('');
                    }

                    const content = `
                        <form id="editQuestionForm" class="space-y-4">
                            <input type="hidden" name="id" value="${question.id}">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kode Soal</label>
                                    <input type="text" name="kode" value="${question.kode || ''}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                    <select name="kelas" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Pilih Kelas</option>
                                        ${classOptions}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                    <select name="mataPelajaran" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Pilih Mata Pelajaran</option>
                                        ${AppState.subjects.map(s => `<option value="${s.nama}" ${question.mataPelajaran === s.nama ? 'selected' : ''}>${s.nama}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipe Soal</label>
                                <select name="tipe" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="this.value === 'pilihan_ganda' ? document.getElementById('editPilihanField').classList.remove('hidden') : document.getElementById('editPilihanField').classList.add('hidden')">
                                    <option value="pilihan_ganda" ${question.tipe === 'pilihan_ganda' ? 'selected' : ''}>Pilihan Ganda</option>
                                    <option value="isian" ${question.tipe === 'isian' ? 'selected' : ''}>Isian</option>
                                    <option value="uraian" ${question.tipe === 'uraian' ? 'selected' : ''}>Uraian</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pertanyaan</label>
                                <textarea name="pertanyaan" rows="4" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${question.pertanyaan || question.question || ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Gambar (Opsional)</label>
                                <input type="file" id="editGambarInput" name="gambar" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-gray-500 mt-1">Pilih gambar baru untuk mengganti yang lama. Ukuran maksimal 10cm x 10cm.</p>
                                <div id="editImagePreview" class="mt-2">
                                    ${question.gambar ? `<img src="${question.gambar}" class="w-full max-w-sm mx-auto rounded-lg shadow-sm">` : ''}
                                </div>
                            </div>
                            <div id="editPilihanField" class="${question.tipe === 'pilihan_ganda' ? '' : 'hidden'} space-y-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pilihan Jawaban</label>
                                <input type="text" name="pilihan1" value="${question.pilihan ? question.pilihan[0] || '' : ''}" placeholder="Pilihan A" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <input type="text" name="pilihan2" value="${question.pilihan ? question.pilihan[1] || '' : ''}" placeholder="Pilihan B" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <input type="text" name="pilihan3" value="${question.pilihan ? question.pilihan[2] || '' : ''}" placeholder="Pilihan C" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <input type="text" name="pilihan4" value="${question.pilihan ? question.pilihan[3] || '' : ''}" placeholder="Pilihan D" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <select name="jawabanBenar" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Jawaban Benar</option>
                                    <option value="0" ${question.correct === 0 ? 'selected' : ''}>A</option>
                                    <option value="1" ${question.correct === 1 ? 'selected' : ''}>B</option>
                                    <option value="2" ${question.correct === 2 ? 'selected' : ''}>C</option>
                                    <option value="3" ${question.correct === 3 ? 'selected' : ''}>D</option>
                                </select>
                            </div>
                            <div class="flex justify-end space-x-2 pt-4">
                                <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update</button>
                            </div>
                        </form>
                    `;
                    UI.showModal('Edit Soal', content);
                    
                    document.getElementById('editQuestionForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const form = e.target;
                        const submitButton = form.querySelector('button[type="submit"]');
                        submitButton.disabled = true;
                        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Mengupdate...';

                        const formData = new FormData(form);
                        const questionData = Object.fromEntries(formData);
                        
                        const fileInput = document.getElementById('editGambarInput');
                        if (fileInput.files[0]) {
                            questionData.gambar = await UI.toBase64(fileInput.files[0]);
                        } else {
                            questionData.gambar = question.gambar;
                        }
                        
                        if (questionData.tipe === 'pilihan_ganda') {
                            questionData.pilihan = [
                                questionData.pilihan1, questionData.pilihan2, questionData.pilihan3, questionData.pilihan4
                            ].filter(p => p);
                            questionData.correct = parseInt(questionData.jawabanBenar);
                            delete questionData.pilihan1;
                            delete questionData.pilihan2;
                            delete questionData.pilihan3;
                            delete questionData.pilihan4;
                            delete questionData.jawabanBenar;
                        }
                        
                        try {
                            // Firebase Integration: Update question in Firestore
                            await db.collection('examQuestions').doc(question.id).set(questionData, { merge: true });
                            UI.hideModal();
                            UI.showNotification('Soal berhasil diupdate!', 'success');
                        } catch (error) {
                            console.error("Error updating document: ", error);
                            UI.showNotification('Gagal mengupdate soal!', 'error');
                        } finally {
                            submitButton.disabled = false;
                            submitButton.innerHTML = 'Update';
                        }
                    });

                } catch (error) {
                    console.error("Error getting document:", error);
                }
            },

            deleteQuestion(id) {
                UI.showConfirmModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus soal ini dari Firebase?', async () => {
                    try {
                        // Firebase Integration: Delete question from Firestore
                        await db.collection('examQuestions').doc(id).delete();
                        UI.showNotification('Soal berhasil dihapus!', 'success');
                    } catch (error) {
                        console.error("Error removing document: ", error);
                        UI.showNotification('Gagal menghapus soal!', 'error');
                    }
                });
            },

            renderFilteredQuestions(questions) {
                AppState.currentlyDisplayed.questions = questions; // Store for bulk delete
                const questionsList = document.getElementById('questionsList');
                if (!questionsList) return;

                const typeOrder = { 'pilihan_ganda': 1, 'isian': 2, 'uraian': 3 };
                questions.sort((a, b) => {
                    const typeA = typeOrder[a.tipe] || 99;
                    const typeB = typeOrder[b.tipe] || 99;
                    if (typeA !== typeB) {
                        return typeA - typeB;
                    }
                    const timeA = a.createdAt ? a.createdAt.toMillis() : 0;
                    const timeB = b.createdAt ? b.createdAt.toMillis() : 0;
                    return timeA - timeB;
                });

                questionsList.innerHTML = questions.length === 0 ?
                    '<div class="bg-white rounded-lg shadow p-6 text-center text-gray-500">Tidak ada soal yang sesuai dengan filter</div>' :
                    questions.map((question, index) => `
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-2 flex-wrap">
                                        <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">${question.kelas}</span>
                                        <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">${question.mataPelajaran}</span>
                                        <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">${question.tipe}</span>
                                        <span class="text-xs text-gray-500">Kode: ${question.kode}</span>
                                    </div>
                                    <h4 class="font-medium text-gray-900 mb-2">Soal No. ${index + 1}</h4>
                                    <p class="text-gray-700 mb-3">${(question.pertanyaan || '').length > 100 ? (question.pertanyaan || '').substring(0, 100) + '...' : (question.pertanyaan || '')}</p>
                                </div>
                                <div class="flex space-x-2 ml-4">
                                    <button onclick="Management.editQuestion('${question.id}')" class="text-green-600 hover:text-green-900">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="Management.deleteQuestion('${question.id}')" class="text-red-600 hover:text-red-900">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
            },

            // =================================================================
            // Result Management (Firebase Integration)
            // =================================================================
            async viewResult(id) {
                try {
                    const doc = await db.collection('examResults').doc(id).get();
                    if (!doc.exists) return;
                    const result = { id: doc.id, ...doc.data() };
                    const content = `
                        <div class="space-y-3 text-sm">
                            <p><strong>Nama Siswa:</strong> ${result.namaLengkap}</p>
                            <p><strong>Kelas:</strong> ${result.kelas}</p>
                            <p><strong>Kode Soal:</strong> ${result.kodesoal}</p>
                            <hr>
                            <p><strong>No. Soal:</strong> ${result.noSoal}</p>
                            <p><strong>Pertanyaan:</strong> ${result.pertanyaan}</p>
                            <p><strong>Jawaban Siswa:</strong> ${result.jawabanSiswa}</p>
                            <p><strong>Status:</strong> <span class="${result.status === 'benar' ? 'text-green-600' : result.status === 'salah' ? 'text-red-600' : 'text-yellow-600'} font-semibold">${result.status.toUpperCase()}</span></p>
                            <p><strong>Nilai Poin:</strong> ${result.nilai}</p>
                        </div>
                        <div class="flex justify-end pt-4 mt-4 border-t">
                            <button onclick="UI.hideModal()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Tutup</button>
                        </div>
                    `;
                    UI.showModal('Detail Hasil Jawaban', content);
                } catch(e) { console.error(e) }
            },

            async editResult(id) {
                const doc = await db.collection('examResults').doc(id).get();
                if (!doc.exists) return;
                const result = { id: doc.id, ...doc.data() };

                const content = `
                    <form id="editResultForm" class="space-y-4">
                        <input type="hidden" name="id" value="${result.id}">
                        <p class="text-sm"><strong>Siswa:</strong> ${result.namaLengkap}</p>
                        <p class="text-sm"><strong>Soal No:</strong> ${result.noSoal}</p>
                        <p class="text-sm"><strong>Pertanyaan:</strong> ${result.pertanyaan}</p>
                        <p class="text-sm"><strong>Jawaban:</strong> ${result.jawabanSiswa}</p>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nilai (0-100)</label>
                            <input type="number" name="nilai" value="${result.nilai}" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan Nilai</button>
                        </div>
                    </form>
                `;
                UI.showModal('Edit Nilai Soal', content);

                document.getElementById('editResultForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newNilai = parseInt(e.target.nilai.value);
                    const newStatus = newNilai > 0 ? 'benar' : 'salah';
                    
                    try {
                        // Firebase Integration: Update the individual result
                        await db.collection('examResults').doc(id).update({
                            nilai: newNilai,
                            status: newStatus
                        });

                        // Firebase Integration: Recalculate final grade
                        const studentResultsSnapshot = await db.collection('examResults')
                            .where('namaLengkap', '==', result.namaLengkap)
                            .where('kodesoal', '==', result.kodesoal)
                            .get();
                        
                        const studentResults = studentResultsSnapshot.docs.map(doc => doc.data());
                        const totalScore = studentResults.reduce((sum, r) => sum + r.nilai, 0);
                        const finalScore = Math.round(totalScore / studentResults.length);
                        const grade = finalScore >= 90 ? 'A' : finalScore >= 80 ? 'B' : finalScore >= 70 ? 'C' : finalScore >= 60 ? 'D' : 'E';
                        
                        // Firebase Integration: Find and update the summary grade
                        const gradeQuery = await db.collection('grades')
                            .where('namaSiswa', '==', result.namaLengkap)
                            .where('kodeSoal', '==', result.kodesoal)
                            .limit(1).get();

                        if (!gradeQuery.empty) {
                            const gradeDocId = gradeQuery.docs[0].id;
                            await db.collection('grades').doc(gradeDocId).update({
                                nilai: finalScore,
                                grade: grade,
                                keterangan: finalScore >= 70 ? 'Lulus' : 'Tidak Lulus'
                            });
                        }
                        
                        UI.hideModal();
                        UI.showNotification('Nilai berhasil diperbarui!', 'success');
                    } catch (error) {
                        console.error("Error updating grade: ", error);
                        UI.showNotification('Gagal memperbarui nilai!', 'error');
                    }
                });
            },

            deleteResult(id) {
                UI.showConfirmModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus detail hasil ini?', async () => {
                    try {
                        // Firebase Integration: Delete result
                        await db.collection('examResults').doc(id).delete();
                        UI.showNotification('Hasil ujian berhasil dihapus!', 'success');
                    } catch (error) {
                        UI.showNotification('Gagal menghapus hasil!', 'error');
                    }
                });
            },

            renderFilteredResults(results) {
                AppState.currentlyDisplayed.results = results; // Store for bulk delete
                const resultsTableBody = document.getElementById('resultsTableBody');
                if (!resultsTableBody) return;
                
                // Sort results by question number
                results.sort((a, b) => a.noSoal - b.noSoal);

                resultsTableBody.innerHTML = results.length === 0 ?
                    '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500">Tidak ada hasil ujian yang sesuai dengan filter</td></tr>' :
                    results.map((result, index) => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.kelas}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.kodesoal}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.namaLengkap}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.noSoal}</td>
                            <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">${result.pertanyaan}</td>
                            <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">${result.jawabanSiswa}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${result.status === 'benar' ? 'bg-green-100 text-green-800' : result.status === 'salah' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">${result.status}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.nilai}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="Management.viewResult('${result.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="Management.editResult('${result.id}')" class="text-green-600 hover:text-green-900 mr-3">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="Management.deleteResult('${result.id}')" class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
            },

            // =================================================================
            // Grade Management (Firebase Integration)
            // =================================================================
            async viewGrade(id) {
                const doc = await db.collection('grades').doc(id).get();
                if (!doc.exists) return;
                const grade = { id: doc.id, ...doc.data() };
                const content = `
                    <div class="space-y-3 text-sm">
                        <p><strong>Nama Siswa:</strong> ${grade.namaSiswa}</p>
                        <p><strong>Kelas:</strong> ${grade.kelas}</p>
                        <p><strong>Kode Soal:</strong> ${grade.kodeSoal}</p>
                        <p><strong>Mata Pelajaran:</strong> ${grade.mataPelajaran}</p>
                        <hr>
                        <p><strong>Nilai Akhir:</strong> <span class="text-2xl font-bold text-blue-600">${grade.nilai}</span></p>
                        <p><strong>Grade:</strong> <span class="font-semibold">${grade.grade}</span></p>
                        <p><strong>Keterangan:</strong> <span class="font-semibold">${grade.keterangan}</span></p>
                        <p><strong>Waktu Selesai:</strong> ${grade.waktuSelesai}</p>
                    </div>
                    <div class="flex justify-end pt-4 mt-4 border-t">
                        <button onclick="UI.hideModal()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Tutup</button>
                    </div>
                `;
                UI.showModal('Detail Nilai Siswa', content);
            },

            async editGrade(id) {
                const doc = await db.collection('grades').doc(id).get();
                if (!doc.exists) return;
                const grade = { id: doc.id, ...doc.data() };

                const content = `
                    <form id="editGradeForm" class="space-y-4">
                        <p class="text-sm">Mengedit nilai akhir untuk <strong>${grade.namaSiswa}</strong> pada ujian <strong>${grade.kodeSoal}</strong>.</p>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nilai Akhir (0-100)</label>
                            <input type="number" name="nilai" value="${grade.nilai}" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan Nilai</button>
                        </div>
                    </form>
                `;
                UI.showModal('Edit Nilai Akhir', content);

                document.getElementById('editGradeForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newNilai = parseInt(e.target.nilai.value);
                    const newGrade = newNilai >= 90 ? 'A' : newNilai >= 80 ? 'B' : newNilai >= 70 ? 'C' : newNilai >= 60 ? 'D' : 'E';
                    const newKeterangan = newNilai >= 70 ? 'Lulus' : 'Tidak Lulus';

                    try {
                        // Firebase Integration: Update grade
                        await db.collection('grades').doc(id).update({
                            nilai: newNilai,
                            grade: newGrade,
                            keterangan: newKeterangan
                        });
                        UI.hideModal();
                        UI.showNotification('Nilai akhir berhasil diperbarui!', 'success');
                    } catch (error) {
                        UI.showNotification('Gagal memperbarui nilai!', 'error');
                    }
                });
            },

            deleteGrade(id) {
                UI.showConfirmModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus data nilai ini?', async () => {
                    try {
                        // Firebase Integration: Delete grade
                        await db.collection('grades').doc(id).delete();
                        UI.showNotification('Data nilai berhasil dihapus!', 'success');
                    } catch (error) {
                        UI.showNotification('Gagal menghapus data nilai!', 'error');
                    }
                });
            },

            renderFilteredGrades(grades) {
                AppState.currentlyDisplayed.grades = grades; // Store for bulk delete
                const gradesTableBody = document.getElementById('gradesTableBody');
                if (!gradesTableBody) return;

                // Sort grades by student name
                grades.sort((a, b) => a.namaSiswa.localeCompare(b.namaSiswa));

                gradesTableBody.innerHTML = grades.length === 0 ?
                    '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500">Belum ada data nilai yang sesuai dengan filter</td></tr>' :
                    grades.map((grade, index) => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.kelas}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.namaSiswa}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.kodeSoal}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.mataPelajaran}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.nilai}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${grade.grade === 'A' ? 'bg-green-100 text-green-800' : grade.grade === 'B' ? 'bg-blue-100 text-blue-800' : grade.grade === 'C' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${grade.grade}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.keterangan}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.waktuSelesai}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="Management.viewGrade('${grade.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="Management.editGrade('${grade.id}')" class="text-green-600 hover:text-green-900 mr-3">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="Management.deleteGrade('${grade.id}')" class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
            },
            
            async downloadQuestionsPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.text("Laporan Daftar Soal", 14, 16);
                doc.setFontSize(10);
                doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 14, 22);

                const tableColumn = ["No", "Kode Soal", "Kelas", "Mata Pelajaran", "Tipe", "Pertanyaan"];
                const tableRows = [];

                // Use the already filtered and sorted data from the state
                const filteredQuestions = AppState.currentlyDisplayed.questions;

                filteredQuestions.forEach((question, index) => {
                    let questionText = question.pertanyaan;
                    if (question.tipe === 'pilihan_ganda' && question.pilihan) {
                        const options = question.pilihan.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n');
                        questionText += '\n' + options;
                    }

                    const questionData = [
                        index + 1,
                        question.kode,
                        question.kelas,
                        question.mataPelajaran,
                        question.tipe,
                        doc.splitTextToSize(questionText, 100)
                    ];
                    tableRows.push(questionData);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 28,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [59, 130, 246] }
                });

                doc.save(`daftar-soal-${new Date().toISOString().slice(0,10)}.pdf`);
                UI.showNotification('PDF berhasil diunduh!', 'success');
            },

            async downloadResultsPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text("Laporan Hasil Ujian", 14, 16);
                doc.setFontSize(10);
                doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 14, 22);

                const tableColumn = ["No", "Kelas", "Kode Soal", "Nama Siswa", "No. Soal", "Status", "Nilai"];
                const tableRows = [];

                const filteredResults = AppState.currentlyDisplayed.results;
                
                filteredResults.forEach((result, index) => {
                    tableRows.push([
                        index + 1, result.kelas, result.kodesoal, result.namaLengkap,
                        result.noSoal, result.status, result.nilai
                    ]);
                });

                doc.autoTable({ head: [tableColumn], body: tableRows, startY: 28 });
                doc.save(`hasil-ujian-${new Date().toISOString().slice(0,10)}.pdf`);
                UI.showNotification('PDF berhasil diunduh!', 'success');
            },

            async downloadGradesPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text("Laporan Daftar Nilai", 14, 16);
                doc.setFontSize(10);
                doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 14, 22);

                const tableColumn = ["No", "Kelas", "Nama Siswa", "Kode Soal", "Mata Pelajaran", "Nilai", "Grade", "Keterangan"];
                const tableRows = [];

                const filteredGrades = AppState.currentlyDisplayed.grades;

                filteredGrades.forEach((grade, index) => {
                    tableRows.push([
                        index + 1, grade.kelas, grade.namaSiswa, grade.kodeSoal,
                        grade.mataPelajaran, grade.nilai, grade.grade, grade.keterangan
                    ]);
                });

                doc.autoTable({ head: [tableColumn], body: tableRows, startY: 28 });
                doc.save(`daftar-nilai-${new Date().toISOString().slice(0,10)}.pdf`);
                UI.showNotification('PDF berhasil diunduh!', 'success');
            },

            deleteFilteredQuestions() {
                const questionsToDelete = AppState.currentlyDisplayed.questions;
                if (questionsToDelete.length === 0) {
                    UI.showNotification('Tidak ada soal untuk dihapus sesuai filter.', 'info');
                    return;
                }
                UI.showConfirmModal(
                    'Konfirmasi Hapus Massal', 
                    `Anda akan menghapus **${questionsToDelete.length}** soal secara permanen. Aksi ini tidak dapat dibatalkan. Lanjutkan?`, 
                    async () => {
                        const batch = db.batch();
                        questionsToDelete.forEach(question => {
                            batch.delete(db.collection('examQuestions').doc(question.id));
                        });
                        try {
                            await batch.commit();
                            UI.showNotification('Soal yang difilter berhasil dihapus!', 'success');
                        } catch (error) {
                            UI.showNotification('Gagal menghapus soal!', 'error');
                            console.error("Error deleting filtered questions: ", error);
                        }
                    }
                );
            },

            deleteFilteredResults() {
                const resultsToDelete = AppState.currentlyDisplayed.results;
                if (resultsToDelete.length === 0) {
                    UI.showNotification('Tidak ada hasil ujian untuk dihapus sesuai filter.', 'info');
                    return;
                }
                UI.showConfirmModal(
                    'Konfirmasi Hapus Massal', 
                    `Anda akan menghapus **${resultsToDelete.length}** data hasil ujian secara permanen. Aksi ini tidak dapat dibatalkan. Lanjutkan?`, 
                    async () => {
                        const batch = db.batch();
                        resultsToDelete.forEach(result => {
                            batch.delete(db.collection('examResults').doc(result.id));
                        });
                        try {
                            await batch.commit();
                            UI.showNotification('Hasil ujian yang difilter berhasil dihapus!', 'success');
                        } catch (error) {
                            UI.showNotification('Gagal menghapus hasil ujian!', 'error');
                            console.error("Error deleting filtered results: ", error);
                        }
                    }
                );
            },

            deleteFilteredGrades() {
                const gradesToDelete = AppState.currentlyDisplayed.grades;
                if (gradesToDelete.length === 0) {
                    UI.showNotification('Tidak ada daftar nilai untuk dihapus sesuai filter.', 'info');
                    return;
                }
                UI.showConfirmModal(
                    'Konfirmasi Hapus Massal', 
                    `Anda akan menghapus **${gradesToDelete.length}** data nilai secara permanen. Aksi ini tidak dapat dibatalkan. Lanjutkan?`, 
                    async () => {
                        const batch = db.batch();
                        gradesToDelete.forEach(grade => {
                            batch.delete(db.collection('grades').doc(grade.id));
                        });
                        try {
                            await batch.commit();
                            UI.showNotification('Daftar nilai yang difilter berhasil dihapus!', 'success');
                        } catch (error) {
                            UI.showNotification('Gagal menghapus daftar nilai!', 'error');
                            console.error("Error deleting filtered grades: ", error);
                        }
                    }
                );
            }
        };

        // =================================================================
        // AUTHENTICATION SYSTEM
        // =================================================================
        const Auth = {
            login(username, password) {
                const user = AppState.users.find(u => u.username === username && u.password === password);
                if (user) {
                    AppState.currentUser = user;
                    // Firebase Persistence: Save user to localStorage
                    localStorage.setItem('cbtCurrentUser', JSON.stringify(user));
                    return { success: true, user: user };
                }
                return { success: false, message: 'Username atau password salah!' };
            },

            logout() {
                AppState.currentUser = null;
                // Firebase Persistence: Remove user from localStorage
                localStorage.removeItem('cbtCurrentUser');
                this.clearExamTimer();
                UI.showLogin();
            },

            clearExamTimer() {
                if (AppState.examTimer) {
                    clearInterval(AppState.examTimer);
                    AppState.examTimer = null;
                }
            },
            
            // Firebase Persistence: Check for persisted user on load
            checkSession() {
                const persistedUser = localStorage.getItem('cbtCurrentUser');
                if (persistedUser) {
                    // Make sure the user still exists in the fetched list
                    const parsedUser = JSON.parse(persistedUser);
                    const userExists = AppState.users.some(u => u.username === parsedUser.username);

                    if (userExists) {
                        AppState.currentUser = parsedUser;
                        UI.showDashboard();
                    } else {
                        // User might have been removed from the source
                        this.logout();
                    }

                } else {
                    UI.showLogin();
                }
            }
        };

        // =================================================================
        // UI MANAGEMENT
        // =================================================================
        const UI = {
            toBase64: file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            }),
            showModal(title, content) {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalContent').innerHTML = content;
                document.getElementById('managementModal').classList.remove('hidden');
            },

            hideModal() {
                document.getElementById('managementModal').classList.add('hidden');
            },

            showConfirmModal(title, message, onConfirm) {
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').innerHTML = message.replace(/\n/g, '<br>');
                document.getElementById('confirmModal').classList.remove('hidden');
                
                const confirmBtn = document.getElementById('confirmOkBtn');
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                newConfirmBtn.addEventListener('click', () => {
                    document.getElementById('confirmModal').classList.add('hidden');
                    onConfirm();
                }, { once: true });
            },

            showLogin() {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('dashboardInterface').classList.add('hidden');
                document.getElementById('examInterface').classList.add('hidden');
                document.getElementById('loginError').classList.add('hidden');
                AppState.currentView = 'login';
            },

            showDashboard() {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboardInterface').classList.remove('hidden');
                document.getElementById('examInterface').classList.add('hidden');
                this.updateDashboardUserInfo();
                this.setupDashboardNavigation();

                if (AppState.currentUser.role === 'guru') {
                    this.setActiveNav('questions');
                    this.showDashboardView('questions');
                } else {
                    this.setActiveNav('dashboard');
                    this.showDashboardView('dashboard');
                }
            },

            async showExamInterface() {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboardInterface').classList.add('hidden');
                document.getElementById('examInterface').classList.remove('hidden');
                this.updateUserInfo();
                
                const success = await this.initializeExam(AppState.selectedExamCode);
                if (!success) {
                    this.showDashboard();
                    return;
                }
                
                AppState.currentView = 'exam';
            },

            updateDashboardUserInfo() {
                if (AppState.currentUser) {
                    document.getElementById('dashboardUserInfo').textContent = AppState.currentUser.nama;
                    document.getElementById('dashboardUserRole').textContent = AppState.currentUser.role.toUpperCase();
                }
            },

            updateUserInfo() {
                if (AppState.currentUser) {
                    document.getElementById('examUserInfo').textContent = AppState.currentUser.nama;
                }
            },

            setupDashboardNavigation() {
                const nav = document.getElementById('dashboardNav');
                let navItems = [];

                if (AppState.currentUser.role === 'admin') {
                    navItems = [
                        { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-tachometer-alt' },
                        { id: 'users', label: 'Manajemen Pengguna', icon: 'fas fa-users' },
                        { id: 'classes', label: 'Manajemen Kelas', icon: 'fas fa-school' },
                        { id: 'subjects', label: 'Manajemen Mata Pelajaran', icon: 'fas fa-book' }
                    ];
                } else if (AppState.currentUser.role === 'guru') {
                    navItems = [
                        { id: 'questions', label: 'Manajemen Soal', icon: 'fas fa-question-circle' },
                        { id: 'results', label: 'Hasil Ujian', icon: 'fas fa-chart-bar' },
                        { id: 'grades', label: 'Daftar Nilai', icon: 'fas fa-list-alt' }
                    ];
                } else if (AppState.currentUser.role === 'siswa') {
                    navItems = [
                        { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-tachometer-alt' }
                    ];
                }

                nav.innerHTML = navItems.map(item => `
                    <button class="flex items-center px-3 py-4 text-sm font-medium hover:bg-blue-800 transition duration-200 nav-item" data-view="${item.id}">
                        <i class="${item.icon} mr-2"></i>
                        ${item.label}
                    </button>
                `).join('');

                nav.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const view = e.currentTarget.dataset.view;
                        this.setActiveNav(view);
                        this.showDashboardView(view);
                    });
                });
            },

            setActiveNav(activeView) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('bg-blue-800');
                });
                const activeItem = document.querySelector(`[data-view="${activeView}"]`);
                if (activeItem) {
                    activeItem.classList.add('bg-blue-800');
                }
            },

            showDashboardView(view) {
                switch (view) {
                    case 'dashboard': this.showDashboardHome(); break;
                    case 'users': this.showUserManagement(); break;
                    case 'classes': this.showClassManagement(); break;
                    case 'subjects': this.showSubjectManagement(); break;
                    case 'questions': this.showQuestionManagement(); break;
                    case 'results': this.showResultManagement(); break;
                    case 'grades': this.showGradeManagement(); break;
                    case 'exam': this.showExamInterface(); break;
                    default: this.showDashboardHome();
                }
            },

            showDashboardHome() {
                const content = document.getElementById('dashboardContent');
                const user = AppState.currentUser;
                
                let dashboardContent = `<div class="fade-in"><h2 class="text-3xl font-bold text-gray-900 mb-8">Selamat Datang, ${user.nama}</h2>`;

                if (user.role === 'admin') {
                    dashboardContent += `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white rounded-lg shadow p-6"><div class="flex items-center"><div class="bg-blue-100 rounded-full p-3"><i class="fas fa-users text-blue-600 text-xl"></i></div><div class="ml-4"><p class="text-sm font-medium text-gray-600">Total Pengguna</p><p class="text-2xl font-bold text-gray-900">${AppState.users.length}</p></div></div></div>
                            <div class="bg-white rounded-lg shadow p-6"><div class="flex items-center"><div class="bg-green-100 rounded-full p-3"><i class="fas fa-school text-green-600 text-xl"></i></div><div class="ml-4"><p class="text-sm font-medium text-gray-600">Total Kelas</p><p class="text-2xl font-bold text-gray-900">${AppState.classes.length}</p></div></div></div>
                            <div class="bg-white rounded-lg shadow p-6"><div class="flex items-center"><div class="bg-yellow-100 rounded-full p-3"><i class="fas fa-book text-yellow-600 text-xl"></i></div><div class="ml-4"><p class="text-sm font-medium text-gray-600">Mata Pelajaran</p><p class="text-2xl font-bold text-gray-900">${AppState.subjects.length}</p></div></div></div>
                        </div>`;
                } else if (user.role === 'guru') {
                    // This view is no longer used for teachers, they go straight to questions
                } else if (user.role === 'siswa') {
                    dashboardContent += `
                        <div class="bg-white rounded-lg shadow p-8">
                            <div class="text-center mb-8"><i class="fas fa-clipboard-list text-6xl text-blue-600 mb-4"></i><h3 class="text-xl font-semibold mb-4">Mulai Ujian</h3><p class="text-gray-600 mb-6">Masukkan kode soal untuk memulai ujian</p></div>
                            <form id="examCodeForm" class="max-w-md mx-auto">
                                <div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2">Kode Soal</label><input type="text" id="examCode" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-lg font-mono" placeholder="Contoh: PAI001"></div>
                                <div id="examCodeError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm mb-4"></div>
                                <button type="submit" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-semibold"><i class="fas fa-play mr-2"></i>Mulai Ujian</button>
                            </form>
                        </div>`;
                }
                dashboardContent += `</div>`;
                content.innerHTML = dashboardContent;
                
                if (user.role === 'siswa') {
                    document.getElementById('examCodeForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const examCode = document.getElementById('examCode').value.trim();
                        const errorDiv = document.getElementById('examCodeError');
                        
                        if (!examCode) {
                            errorDiv.textContent = 'Silakan masukkan kode soal!';
                            errorDiv.classList.remove('hidden');
                            return;
                        }
                        
                        // Firebase Integration: Check if exam code exists
                        const examQuery = await db.collection('examQuestions').where('kode', '==', examCode).limit(1).get();
                        if (examQuery.empty) {
                            errorDiv.textContent = 'Kode soal tidak ditemukan!';
                            errorDiv.classList.remove('hidden');
                            return;
                        }

                        // New: Check if student's grade level matches exam's grade level
                        const examData = examQuery.docs[0].data();
                        const studentGrade = AppState.currentUser.kelas.charAt(0);
                        const examGrade = examData.kelas.charAt(0);

                        if (studentGrade !== examGrade) {
                            errorDiv.textContent = 'Anda tidak diizinkan mengerjakan soal untuk kelas ini.';
                            errorDiv.classList.remove('hidden');
                            return;
                        }
                        
                        errorDiv.classList.add('hidden');
                        AppState.selectedExamCode = examCode;
                        UI.showExamInterface();
                    });
                }
            },

            showUserManagement() {
                const content = document.getElementById('dashboardContent');
                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-900">Manajemen Pengguna</h2><button onclick="Management.showAddUserModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200"><i class="fas fa-plus mr-2"></i>Tambah Pengguna</button></div>
                        
                        <!-- Filter Section -->
                        <div class="bg-white rounded-lg shadow p-6 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama / Username</label>
                                    <input type="text" id="filterUserName" placeholder="Cari..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                    <select id="filterUserRole" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua Role</option>
                                        <option value="admin">Admin</option>
                                        <option value="guru">Guru</option>
                                        <option value="siswa">Siswa</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                    <select id="filterUserClass" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua Kelas</option>
                                        ${AppState.classes.map(c => `<option value="${c.nama}">${c.nama}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button id="applyUserFilterBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-search mr-2"></i>Filter</button>
                                </div>
                                <div class="flex items-end">
                                    <button id="resetUserFilterBtn" class="w-full bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700"><i class="fas fa-sync mr-2"></i>Reset</button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="overflow-x-auto">
                                <table id="userManagementTable" class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Password</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <!-- User data will be rendered here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;

                document.getElementById('applyUserFilterBtn').addEventListener('click', () => this.renderUserTable());
                document.getElementById('resetUserFilterBtn').addEventListener('click', () => {
                    document.getElementById('filterUserName').value = '';
                    document.getElementById('filterUserRole').value = '';
                    document.getElementById('filterUserClass').value = '';
                    this.renderUserTable();
                });

                this.renderUserTable();
            },

            renderUserTable() {
                const nameFilter = document.getElementById('filterUserName').value.toLowerCase();
                const roleFilter = document.getElementById('filterUserRole').value;
                const classFilter = document.getElementById('filterUserClass').value;

                const filteredUsers = AppState.users.filter(user => {
                    const nameMatch = user.nama.toLowerCase().includes(nameFilter) || user.username.toLowerCase().includes(nameFilter);
                    const roleMatch = !roleFilter || user.role === roleFilter;
                    const classMatch = !classFilter || user.kelas === classFilter;
                    return nameMatch && roleMatch && classMatch;
                });

                const tableBody = document.querySelector('#userManagementTable tbody');
                tableBody.innerHTML = filteredUsers.map((user, index) => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.kelas || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.role === 'admin' ? 'bg-red-100 text-red-800' : user.role === 'guru' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${user.role.toUpperCase()}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="Management.viewUser('${user.id}')" class="text-blue-600 hover:text-blue-900 mr-3"><i class="fas fa-eye"></i></button>
                            <button onclick="Management.editUser('${user.id}')" class="text-green-600 hover:text-green-900 mr-3"><i class="fas fa-edit"></i></button>
                            <button onclick="Management.deleteUser('${user.id}')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`).join('');
            },

            showClassManagement() {
                const content = document.getElementById('dashboardContent');
                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-900">Manajemen Kelas</h2><button onclick="Management.showAddClassModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200"><i class="fas fa-plus mr-2"></i>Tambah Kelas</button></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${AppState.classes.map(cls => `
                            <div class="bg-white rounded-lg shadow hover:shadow-md transition duration-200"><div class="p-6"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold text-gray-900">${cls.nama}</h3></div><p class="text-gray-600 text-sm mb-4">${cls.deskripsi}</p><div class="flex space-x-2"><button onclick="Management.editClass('${cls.id}')" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700"><i class="fas fa-edit mr-1"></i>Edit</button><button onclick="Management.deleteClass('${cls.id}')" class="bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-700"><i class="fas fa-trash"></i></button></div></div></div>`).join('')}
                        </div></div>`;
            },

            showSubjectManagement() {
                const content = document.getElementById('dashboardContent');
                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-900">Manajemen Mata Pelajaran</h2><button onclick="Management.showAddSubjectModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200"><i class="fas fa-plus mr-2"></i>Tambah Mata Pelajaran</button></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${AppState.subjects.map(subject => `
                            <div class="bg-white rounded-lg shadow hover:shadow-md transition duration-200"><div class="p-6"><div class="flex items-center mb-4"><div class="bg-blue-100 rounded-full w-12 h-12 flex items-center justify-center"><i class="fas fa-book text-blue-600"></i></div><div class="ml-4"><h3 class="text-lg font-semibold text-gray-900">${subject.nama}</h3></div></div><p class="text-gray-600 text-sm mb-4">${subject.deskripsi}</p><div class="flex space-x-2"><button onclick="Management.editSubject('${subject.id}')" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700"><i class="fas fa-edit mr-1"></i>Edit</button><button onclick="Management.deleteSubject('${subject.id}')" class="bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-700"><i class="fas fa-trash"></i></button></div></div></div>`).join('')}
                        </div></div>`;
            },

            showQuestionManagement() {
                const content = document.getElementById('dashboardContent');
                const isTeacher = AppState.currentUser.role === 'guru';
                let classOptions = '';
                if (isTeacher) {
                    const teacherGrade = AppState.currentUser.kelas.charAt(0);
                    const availableClasses = AppState.classes.filter(c => c.nama.startsWith(teacherGrade));
                    classOptions = availableClasses.map(c => `<option value="${c.nama}">${c.nama}</option>`).join('');
                } else {
                    classOptions = AppState.classes.map(c => `<option value="${c.nama}">${c.nama}</option>`).join('');
                }

                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
                            <h2 class="text-2xl font-bold text-gray-900">Manajemen Soal</h2>
                            <div class="flex items-center gap-2">
                                <button onclick="Management.deleteFilteredQuestions()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200"><i class="fas fa-trash-alt mr-2"></i>Hapus Soal</button>
                                <button onclick="Management.downloadQuestionsPDF()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200"><i class="fas fa-download mr-2"></i>Download PDF</button>
                                <button onclick="Management.showAddQuestionModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200"><i class="fas fa-plus mr-2"></i>Tambah Soal</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 mb-6"><div class="grid grid-cols-1 md:grid-cols-4 gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label><select id="filterKelas" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua Kelas</option>${classOptions}</select></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label><select id="filterSubject" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua Mata Pelajaran</option>${AppState.subjects.map(s => `<option value="${s.nama}">${s.nama}</option>`).join('')}</select></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Kode Soal</label><input type="text" id="filterCode" placeholder="Masukkan kode soal" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></div><div class="flex items-end"><button id="applyFilterBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-search mr-2"></i>Filter</button></div></div></div>
                        <div id="questionsList" class="space-y-4"><div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i><p class="mt-2 text-gray-600">Memuat soal...</p></div></div></div>`;
                
                // Firebase Integration: Real-time listener for questions
                document.getElementById('applyFilterBtn').addEventListener('click', () => {
                    const kelas = document.getElementById('filterKelas').value;
                    const mataPelajaran = document.getElementById('filterSubject').value;
                    const kode = document.getElementById('filterCode').value;

                    let query = db.collection('examQuestions');
                    
                    query.onSnapshot(snapshot => {
                        let questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                        if (AppState.currentUser.role === 'guru' && AppState.currentUser.kelas) {
                            const teacherGrade = AppState.currentUser.kelas.charAt(0);
                            questions = questions.filter(q => q.kelas && q.kelas.startsWith(teacherGrade));
                        }
                        
                        if (kelas) {
                            questions = questions.filter(q => q.kelas === kelas);
                        }
                        if (mataPelajaran) {
                            questions = questions.filter(q => q.mataPelajaran === mataPelajaran);
                        }
                        if (kode) {
                            questions = questions.filter(q => q.kode && q.kode.toLowerCase().includes(kode.toLowerCase()));
                        }
                        Management.renderFilteredQuestions(questions);
                    }, error => console.error(error));
                });
                // Initial load
                document.getElementById('applyFilterBtn').click();
            },

            showResultManagement() {
                const content = document.getElementById('dashboardContent');
                const isTeacher = AppState.currentUser.role === 'guru';
                
                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
                            <h2 class="text-2xl font-bold text-gray-900">Hasil Ujian</h2>
                            <div class="flex items-center gap-2">
                                <button onclick="Management.deleteFilteredResults()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200"><i class="fas fa-trash-alt mr-2"></i>Hapus</button>
                                <button onclick="Management.downloadResultsPDF()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200"><i class="fas fa-download mr-2"></i>Download PDF</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 mb-6"><div class="grid grid-cols-1 md:grid-cols-5 gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">Kode Soal</label><input type="text" id="filterResultCode" placeholder="Kode soal" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label><select id="filterResultSubject" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua</option>${AppState.subjects.map(s => `<option value="${s.nama}">${s.nama}</option>`).join('')}</select></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label><select id="filterResultClass" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" ${isTeacher ? 'disabled' : ''}><option value="">Semua</option>${AppState.classes.map(c => `<option value="${c.nama}">${c.nama}</option>`).join('')}</select></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Siswa</label><select id="filterResultStudent" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua Siswa</option></select></div><div class="flex items-end"><button id="applyResultFilterBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-search mr-2"></i>Filter</button></div></div></div>
                        <div class="bg-white rounded-lg shadow overflow-hidden"><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode Soal</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Lengkap</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. Soal</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pertanyaan</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jawaban Siswa</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th></tr></thead><tbody id="resultsTableBody" class="bg-white divide-y divide-gray-200"></tbody></table></div></div></div>`;
                
                if (isTeacher) document.getElementById('filterResultClass').value = AppState.currentUser.kelas;
                
                UI.populateStudentFilter('filterResultClass', 'filterResultStudent');

                document.getElementById('applyResultFilterBtn').addEventListener('click', () => {
                    let query = db.collection('examResults');
                    const kodesoal = document.getElementById('filterResultCode').value;
                    const mataPelajaran = document.getElementById('filterResultSubject').value;
                    const kelas = document.getElementById('filterResultClass').value;
                    const namaLengkap = document.getElementById('filterResultStudent').value;

                    query.onSnapshot(snapshot => {
                        let results = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (kelas) {
                            results = results.filter(r => r.kelas === kelas);
                        }
                        if (mataPelajaran) {
                            results = results.filter(r => r.mataPelajaran === mataPelajaran);
                        }
                        if (namaLengkap) {
                            results = results.filter(r => r.namaLengkap === namaLengkap);
                        }
                        if (kodesoal) {
                            results = results.filter(r => r.kodesoal.toLowerCase().includes(kodesoal.toLowerCase()));
                        }
                        Management.renderFilteredResults(results);
                    });
                });
                document.getElementById('applyResultFilterBtn').click();
            },

            showGradeManagement() {
                const content = document.getElementById('dashboardContent');
                const isTeacher = AppState.currentUser.role === 'guru';

                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
                            <h2 class="text-2xl font-bold text-gray-900">Daftar Nilai</h2>
                            <div class="flex items-center gap-2">
                                <button onclick="Management.deleteFilteredGrades()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200"><i class="fas fa-trash-alt mr-2"></i>Hapus</button>
                                <button onclick="Management.downloadGradesPDF()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200"><i class="fas fa-download mr-2"></i>Download PDF</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 mb-6"><div class="grid grid-cols-1 md:grid-cols-5 gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">Kode Soal</label><input type="text" id="filterGradeCode" placeholder="Kode soal" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label><select id="filterGradeSubject" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua</option>${AppState.subjects.map(s => `<option value="${s.nama}">${s.nama}</option>`).join('')}</select></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label><select id="filterGradeClass" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" ${isTeacher ? 'disabled' : ''}><option value="">Semua</option>${AppState.classes.map(c => `<option value="${c.nama}">${c.nama}</option>`).join('')}</select></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Siswa</label><select id="filterGradeStudent" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua Siswa</option></select></div><div class="flex items-end"><button id="applyGradeFilterBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-search mr-2"></i>Filter</button></div></div></div>
                        <div class="bg-white rounded-lg shadow overflow-hidden"><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode Soal</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu Selesai</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th></tr></thead><tbody id="gradesTableBody" class="bg-white divide-y divide-gray-200"></tbody></table></div></div></div>`;
                
                if (isTeacher) document.getElementById('filterGradeClass').value = AppState.currentUser.kelas;

                UI.populateStudentFilter('filterGradeClass', 'filterGradeStudent');

                document.getElementById('applyGradeFilterBtn').addEventListener('click', () => {
                    let query = db.collection('grades');
                    const kodeSoal = document.getElementById('filterGradeCode').value;
                    const mataPelajaran = document.getElementById('filterGradeSubject').value;
                    const kelas = document.getElementById('filterGradeClass').value;
                    const namaSiswa = document.getElementById('filterGradeStudent').value;

                    query.onSnapshot(snapshot => {
                        let grades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (kelas) {
                            grades = grades.filter(g => g.kelas === kelas);
                        }
                        if (mataPelajaran) {
                            grades = grades.filter(g => g.mataPelajaran === mataPelajaran);
                        }
                        if (namaSiswa) {
                            grades = grades.filter(g => g.namaSiswa === namaSiswa);
                        }
                        if (kodeSoal) {
                            grades = grades.filter(g => g.kodeSoal.toLowerCase().includes(kodeSoal.toLowerCase()));
                        }
                        Management.renderFilteredGrades(grades);
                    });
                });
                document.getElementById('applyGradeFilterBtn').click();
            },

            async initializeExam(examCode) {
                if (!examCode) return false;

                try {
                    // Firebase Integration: Get questions from Firestore
                    const snapshot = await db.collection('examQuestions').where('kode', '==', examCode).get();
                    if (snapshot.empty) {
                        UI.showNotification('Kode soal tidak ditemukan!', 'error');
                        return false;
                    }

                    const filteredQuestions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const typeOrder = { 'pilihan_ganda': 1, 'isian': 2, 'uraian': 3 };
                    
                    filteredQuestions.sort((a, b) => {
                        const typeA = typeOrder[a.tipe] || 99;
                        const typeB = typeOrder[b.tipe] || 99;

                        if (typeA !== typeB) {
                            return typeA - typeB; // 1. Sort by question type
                        }

                        // 2. If type is the same, sort by creation time
                        const timeA = a.createdAt ? a.createdAt.toMillis() : 0;
                        const timeB = b.createdAt ? b.createdAt.toMillis() : 0;
                        return timeA - timeB; 
                    });

                    AppState.questions = filteredQuestions.map((q, index) => ({
                        originalId: q.id,
                        id: index + 1,
                        type: q.tipe === 'pilihan_ganda' ? 'multiple' : q.tipe === 'isian' ? 'fill' : 'essay',
                        question: q.pertanyaan,
                        options: q.pilihan || [],
                        correct: q.correct,
                        gambar: q.gambar || null
                    }));
                    
                    AppState.selectedExamCode = examCode;
                    AppState.currentQuestion = 0;
                    AppState.examAnswers = {};
                    AppState.examTimeLeft = 3600;
                    
                    this.renderQuestion();
                    this.setupQuestionNavigation();
                    this.startTimer();
                    this.updateProgress();
                    return true;
                } catch (error) {
                    console.error("Error initializing exam: ", error);
                    UI.showNotification('Gagal memuat soal ujian!', 'error');
                    return false;
                }
            },

            renderQuestion() {
                const question = AppState.questions[AppState.currentQuestion];
                const questionContent = document.getElementById('questionContent');
                
                document.getElementById('currentQuestionNum').textContent = AppState.currentQuestion + 1;
                document.getElementById('totalQuestions').textContent = AppState.questions.length;
                
                let content = `
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-4"><h3 class="text-2xl font-bold text-gray-800">Soal No. ${AppState.currentQuestion + 1}</h3><span class="px-3 py-1 text-sm rounded-full ${question.type === 'multiple' ? 'bg-blue-100 text-blue-800' : question.type === 'fill' ? 'bg-green-100 text-green-800' : 'bg-purple-100 text-purple-800'}">${question.type === 'multiple' ? 'Pilihan Ganda' : question.type === 'fill' ? 'Isian' : 'Uraian'}</span></div>
                        <p class="text-lg text-gray-800 leading-relaxed mb-6">${question.question}</p>
                        ${question.gambar ? `<div class="my-4"><img src="${question.gambar}" class="w-full max-w-sm mx-auto rounded-lg shadow-md"></div>` : ''}
                    </div>`;
                
                if (question.type === 'multiple') {
                    content += `<div class="space-y-3">${question.options.map((option, index) => `<label class="flex items-center p-4 border-2 rounded-lg hover:bg-blue-50 hover:border-blue-300 cursor-pointer transition duration-200 ${AppState.examAnswers[AppState.currentQuestion] === index ? 'bg-blue-50 border-blue-500' : 'border-gray-200'}"><input type="radio" name="answer" value="${index}" class="mr-4 w-5 h-5 text-blue-600" ${AppState.examAnswers[AppState.currentQuestion] === index ? 'checked' : ''}><span class="text-gray-800 font-medium mr-3">${String.fromCharCode(65 + index)}.</span><span class="text-gray-800">${option}</span></label>`).join('')}</div>`;
                } else if (question.type === 'fill') {
                    content += `<div><label class="block text-sm font-medium text-gray-700 mb-3">Jawaban:</label><input type="text" name="answer" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg" placeholder="Masukkan jawaban Anda" value="${AppState.examAnswers[AppState.currentQuestion] || ''}"></div>`;
                } else if (question.type === 'essay') {
                    content += `<div><label class="block text-sm font-medium text-gray-700 mb-3">Jawaban:</label><textarea name="answer" rows="8" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg resize-none" placeholder="Tuliskan jawaban Anda dengan lengkap dan jelas">${AppState.examAnswers[AppState.currentQuestion] || ''}</textarea></div>`;
                }
                
                questionContent.innerHTML = content;
                document.getElementById('prevQuestionBtn').disabled = AppState.currentQuestion === 0;
                document.getElementById('nextQuestionBtn').innerHTML = AppState.currentQuestion === AppState.questions.length - 1 ? 'Selesai Ujian <i class="fas fa-flag-checkered ml-2"></i>' : 'Soal Selanjutnya <i class="fas fa-chevron-right ml-2"></i>';
                
                questionContent.querySelectorAll('input[name="answer"], textarea[name="answer"]').forEach(input => {
                    input.addEventListener('change', () => {
                        if (input.type === 'radio') AppState.examAnswers[AppState.currentQuestion] = parseInt(input.value);
                        else AppState.examAnswers[AppState.currentQuestion] = input.value;
                        this.updateQuestionNavigation();
                        this.updateProgress();
                    });
                });
            },

            setupQuestionNavigation() {
                const navigation = document.getElementById('questionNavigation');
                navigation.innerHTML = Array.from({ length: AppState.questions.length }, (_, i) => {
                    let stateClass = 'unanswered';
                    if (i === AppState.currentQuestion) stateClass = 'current';
                    else if (AppState.examAnswers[i] !== undefined) stateClass = 'answered';
                    return `<button class="question-nav-btn w-12 h-12 rounded-full border-2 text-sm font-bold ${stateClass}" onclick="UI.goToQuestion(${i})">${i + 1}</button>`;
                }).join('');
            },

            updateQuestionNavigation() { this.setupQuestionNavigation(); },

            goToQuestion(index) {
                AppState.currentQuestion = index;
                this.renderQuestion();
                this.updateQuestionNavigation();
                this.updateProgress();
                document.getElementById('questionListModal').classList.add('hidden');
            },

            updateProgress() {
                const answered = Object.keys(AppState.examAnswers).filter(key => AppState.examAnswers[key] !== undefined && AppState.examAnswers[key] !== '').length;
                const total = AppState.questions.length;
                const percentage = total > 0 ? (answered / total) * 100 : 0;
                document.getElementById('progressBar').style.width = `${percentage}%`;
            },

            startTimer() {
                if (AppState.examTimer) clearInterval(AppState.examTimer);
                AppState.examTimer = setInterval(() => {
                    AppState.examTimeLeft--;
                    document.getElementById('examTimer').textContent = this.formatTime(AppState.examTimeLeft);
                    if (AppState.examTimeLeft <= 0) this.submitExam();
                }, 1000);
            },

            formatTime(seconds) {
                const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
                const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                return `${h}:${m}:${s}`;
            },

            async submitExam() {
                if (AppState.examTimer) clearInterval(AppState.examTimer);
                
                const examDetailsSnapshot = await db.collection('examQuestions').where('kode', '==', AppState.selectedExamCode).limit(1).get();
                const mataPelajaran = !examDetailsSnapshot.empty ? examDetailsSnapshot.docs[0].data().mataPelajaran : 'Tidak diketahui';

                let totalScore = 0;
                // Firebase Integration: Use batch write for atomicity
                const batch = db.batch();

                AppState.questions.forEach((question, index) => {
                    const userAnswer = AppState.examAnswers[index];
                    let point = 0;
                    let status = 'salah';

                    if (question.type === 'multiple') {
                        if (question.correct !== undefined && userAnswer === question.correct) {
                            point = 100;
                            status = 'benar';
                        }
                    } else {
                        status = 'perlu dinilai';
                    }
                    totalScore += point;
                    
                    const resultRef = db.collection('examResults').doc();
                    batch.set(resultRef, {
                        kelas: AppState.currentUser.kelas,
                        kodesoal: AppState.selectedExamCode,
                        namaLengkap: AppState.currentUser.nama,
                        noSoal: index + 1,
                        pertanyaan: question.question,
                        jawabanSiswa: userAnswer !== undefined ? String(userAnswer) : 'Tidak dijawab',
                        status: status,
                        nilai: point,
                        mataPelajaran: mataPelajaran,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                const finalScore = AppState.questions.length > 0 ? Math.round(totalScore / AppState.questions.length) : 0;
                const grade = finalScore >= 90 ? 'A' : finalScore >= 80 ? 'B' : finalScore >= 70 ? 'C' : finalScore >= 60 ? 'D' : 'E';
                
                const gradeRef = db.collection('grades').doc();
                batch.set(gradeRef, {
                    kelas: AppState.currentUser.kelas,
                    namaSiswa: AppState.currentUser.nama,
                    kodeSoal: AppState.selectedExamCode,
                    mataPelajaran: mataPelajaran,
                    nilai: finalScore,
                    grade: grade,
                    keterangan: finalScore >= 70 ? 'Lulus' : 'Tidak Lulus',
                    waktuSelesai: new Date().toLocaleString('id-ID')
                });

                try {
                    await batch.commit();
                    Swal.fire({
                        title: 'Ujian Selesai!',
                        text: 'Terima kasih telah menyelesaikan ujian. Anda akan diarahkan kembali ke halaman login.',
                        icon: 'success',
                        confirmButtonText: 'OK',
                        allowOutsideClick: false
                    }).then(() => Auth.logout());
                } catch (error) {
                    console.error("Error submitting exam: ", error);
                    UI.showNotification('Gagal menyimpan hasil ujian!', 'error');
                }
            },

            showNotification(message, type = 'error') {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                });
                Toast.fire({ icon: type, title: message });
            },

            populateStudentFilter(classFilterId, studentFilterId) {
                const classFilterElement = document.getElementById(classFilterId);
                const studentFilterElement = document.getElementById(studentFilterId);

                const updateStudentOptions = () => {
                    const selectedClass = classFilterElement.value;
                    let filteredStudents = AppState.users.filter(u => u.role === 'siswa');

                    if (selectedClass) {
                        filteredStudents = filteredStudents.filter(u => u.kelas === selectedClass);
                    } else if (AppState.currentUser.role === 'guru') {
                        const teacherGrade = AppState.currentUser.kelas.charAt(0);
                        filteredStudents = filteredStudents.filter(u => u.kelas.startsWith(teacherGrade));
                    }

                    studentFilterElement.innerHTML = '<option value="">Semua Siswa</option>';
                    filteredStudents
                        .sort((a, b) => a.nama.localeCompare(b.nama))
                        .forEach(student => {
                            const option = document.createElement('option');
                            option.value = student.nama;
                            option.textContent = student.nama;
                            studentFilterElement.appendChild(option);
                        });
                };

                classFilterElement.addEventListener('change', updateStudentOptions);
                updateStudentOptions(); // Initial population
            }
        };

        // =================================================================
        // EVENT LISTENERS & INITIALIZATION
        // =================================================================
        document.addEventListener('DOMContentLoaded', async function() {
            const loginForm = document.getElementById('loginForm');
            const loginButton = loginForm.querySelector('button[type="submit"]');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginError = document.getElementById('loginError');

            // Show loading state while fetching user data
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Memuat Data...';
            usernameInput.disabled = true;
            passwordInput.disabled = true;

            const dataLoaded = await fetchUsersFromGoogleScript();

            if (dataLoaded) {
                 // Restore login form state
                loginButton.disabled = false;
                loginButton.innerHTML = 'Login';
                usernameInput.disabled = false;
                passwordInput.disabled = false;
                
                // Check for a persisted session after data is loaded
                Auth.checkSession();
            } else {
                 loginButton.innerHTML = 'Gagal Memuat';
            }


            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                
                loginError.classList.add('hidden');
                
                const result = Auth.login(username, password);
                if (result.success) UI.showDashboard();
                else {
                    loginError.textContent = result.message;
                    loginError.classList.remove('hidden');
                }
            });
            
            document.getElementById('togglePasswordVisibility').addEventListener('click', function() {
                const passwordField = document.getElementById('password');
                const icon = this.querySelector('i');
                if (passwordField.type === 'password') {
                    passwordField.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordField.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });

            document.getElementById('prevQuestionBtn').addEventListener('click', () => {
                if (AppState.currentQuestion > 0) {
                    AppState.currentQuestion--;
                    UI.renderQuestion();
                    UI.updateQuestionNavigation();
                    UI.updateProgress();
                }
            });

            document.getElementById('nextQuestionBtn').addEventListener('click', () => {
                if (AppState.currentQuestion < AppState.questions.length - 1) {
                    AppState.currentQuestion++;
                    UI.renderQuestion();
                    UI.updateQuestionNavigation();
                    UI.updateProgress();
                } else {
                    const unansweredCount = AppState.questions.length - Object.keys(AppState.examAnswers).filter(k => AppState.examAnswers[k] !== undefined && AppState.examAnswers[k] !== '').length;
                    let message = 'Apakah Anda yakin ingin mengakhiri ujian?';
                    if (unansweredCount > 0) message += `\n\nAnda memiliki ${unansweredCount} soal yang belum dikerjakan.`;
                    UI.showConfirmModal('Konfirmasi Selesai Ujian', message, () => UI.submitExam());
                }
            });

            document.getElementById('questionListBtn').addEventListener('click', () => document.getElementById('questionListModal').classList.remove('hidden'));
            document.getElementById('closeQuestionListBtn').addEventListener('click', () => document.getElementById('questionListModal').classList.add('hidden'));
            document.getElementById('submitExamBtn').addEventListener('click', () => {
                 const unansweredCount = AppState.questions.length - Object.keys(AppState.examAnswers).filter(k => AppState.examAnswers[k] !== undefined && AppState.examAnswers[k] !== '').length;
                let message = 'Apakah Anda yakin ingin mengakhiri ujian?';
                if (unansweredCount > 0) message += `\n\nAnda memiliki ${unansweredCount} soal yang belum dikerjakan.`;
                UI.showConfirmModal('Konfirmasi Selesai Ujian', message, () => UI.submitExam());
            });
            document.getElementById('logoutBtn').addEventListener('click', () => UI.showConfirmModal('Konfirmasi Keluar', 'Apakah Anda yakin ingin keluar dari ujian?', () => Auth.logout()));
            document.getElementById('dashboardLogoutBtn').addEventListener('click', () => UI.showConfirmModal('Konfirmasi Keluar', 'Apakah Anda yakin ingin keluar?', () => Auth.logout()));
            document.getElementById('closeModalBtn').addEventListener('click', () => UI.hideModal());
            document.getElementById('managementModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) UI.hideModal(); });
            document.getElementById('questionListModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) e.currentTarget.classList.add('hidden'); });
            
            document.getElementById('confirmCancelBtn').addEventListener('click', () => document.getElementById('confirmModal').classList.add('hidden'));

        });

        document.addEventListener('contextmenu', (e) => { if (AppState.currentView === 'exam') e.preventDefault(); });
        document.addEventListener('keydown', (e) => {
            if (AppState.currentView === 'exam' && (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.key === 'u'))) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>

