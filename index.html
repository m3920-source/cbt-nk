
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT SD IT Nurul Kautsar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .timer-warning { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .question-nav-btn { transition: all 0.3s ease; }
        .question-nav-btn.answered { background-color: #22c55e; color: white; } /* Corresponds to bg-green-500 */
        .question-nav-btn.current { background-color: #3b82f6; color: white; } /* Corresponds to bg-blue-500 */
        .question-nav-btn.unanswered { background-color: #d1d5db; color: #374151; } /* Corresponds to bg-gray-300 */
        .question-nav-btn:hover { transform: scale(1.05); }
        .modal-backdrop { backdrop-filter: blur(4px); }
        .login-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .login-box {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.24.0",
    "react-image-crop": "https://aistudiocdn.com/react-image-crop@^11.0.10",
    "monaco-editor": "https://aistudiocdn.com/monaco-editor@^0.54.0",
    "safevalues/": "https://aistudiocdn.com/safevalues@^1.2.0/",
    "safevalues": "https://cdn.jsdelivr.net/npm/safevalues@^1.2.0/dist/mjs/index.min.js",
    "markdown-it": "https://aistudiocdn.com/markdown-it@^14.1.0",
    "@monaco-editor/loader": "https://aistudiocdn.com/@monaco-editor/loader@^1.6.0",
    "sortablejs": "https://aistudiocdn.com/sortablejs@^1.15.6"
  }
}
</script>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container flex items-center justify-center p-4">
        <div class="login-box bg-white rounded-2xl shadow-2xl p-6 sm:p-8 w-full max-w-md fade-in">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="bg-blue-600 text-white py-4 px-6 rounded-xl mb-6">
                    <h1 class="text-2xl font-bold">SD IT NURUL KAUTSAR</h1>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Selamat Datang</h2>
            </div>
            
            <!-- Login Form -->
            <form id="loginForm" class="space-y-6">
                <div id="loginError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                
                <div>
                    <input type="text" id="username" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" 
                           placeholder="Username">
                </div>
                
                <div class="relative">
                    <input type="password" id="password" required 
                           class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" 
                           placeholder="Password">
                    <button type="button" id="togglePasswordVisibility" class="absolute inset-y-0 right-0 flex items-center px-4 text-gray-600">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 font-semibold text-lg">
                    Login
                </button>
            </form>
            

        </div>
    </div>

    <!-- Dashboard Interface -->
    <div id="dashboardInterface" class="hidden flex h-screen bg-gray-200">
        <!-- Sidebar -->
        <div id="dashboardSidebar" class="w-64 bg-blue-900 text-white flex flex-col">
            <div class="px-4 py-6 text-center border-b border-blue-800">
                <h2 class="text-xl font-bold">CBT Dashboard</h2>
                <div class="mt-4">
                    <p id="dashboardUserInfo" class="font-semibold"></p>
                    <p id="dashboardUserRole" class="text-sm text-blue-300"></p>
                </div>
            </div>
            <nav id="dashboardNav" class="flex-1 overflow-y-auto"></nav>
            <div class="px-4 py-4 border-t border-blue-800">
                <button id="dashboardLogoutBtn" class="w-full flex items-center justify-center px-4 py-2 text-sm font-medium hover:bg-blue-800 transition duration-200 rounded-md">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    Logout
                </button>
            </div>
        </div>
        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header for Admin/Guru -->
            <header id="dashboardHeader" class="hidden bg-white shadow-md z-10 p-4">
                <!-- Content populated by JavaScript -->
            </header>
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 sm:p-8">
                <div id="dashboardContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </main>
        </div>
    </div>

    <!-- Management Modal -->
    <div id="managementModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-bold text-gray-800" id="modalTitle">Modal Title</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto" id="modalContent">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4" id="confirmTitle">Konfirmasi</h3>
            <p class="text-gray-700 mb-6" id="confirmMessage">Apakah Anda yakin?</p>
            <div class="flex justify-end space-x-4">
                <button id="confirmCancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button>
                <button id="confirmOkBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>

    <!-- Gemini Generation Modal -->
    <div id="geminiModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-bold text-gray-800" id="geminiModalTitle">âœ¨ Buat Soal Otomatis dengan AI</h3>
                <button onclick="UI.hideGeminiModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto" id="geminiModalContent">
                <!-- Gemini Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Exam Interface -->
    <div id="examInterface" class="hidden min-h-screen bg-gray-100">
        <!-- Exam Top Bar -->
        <div class="bg-white shadow-md sticky top-0 z-20">
            <div class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <p id="examUserInfo" class="text-sm font-semibold text-gray-800 hidden sm:block"></p>
                    <div class="flex items-center bg-red-100 text-red-700 px-3 py-2 rounded-lg shadow-sm">
                        <i class="far fa-clock mr-2"></i>
                        <span id="examTimer" class="font-bold text-md">01:00:00</span>
                    </div>
                </div>
                <button id="questionListBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 flex items-center">
                    <i class="fas fa-list-ul mr-2"></i><span class="hidden sm:inline">Daftar Soal</span>
                </button>
                <div class="flex items-center gap-4">
                    <p class="text-sm text-gray-600 font-medium hidden sm:block">
                        Soal <span id="currentQuestionNum">1</span> dari <span id="totalQuestions">0</span>
                    </p>
                    <button id="submitExamBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 whitespace-nowrap">
                        <i class="fas fa-flag-checkered mr-2"></i> Selesai
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container mx-auto px-4 py-6 sm:px-6 sm:py-8">
            <!-- Question Area -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                <div id="questionContent">
                    <!-- Question will be rendered here -->
                </div>
                <div class="mt-8 pt-6 border-t flex flex-col sm:flex-row justify-between items-center gap-4">
                    <button id="prevQuestionBtn" class="w-full sm:w-auto bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
                        <i class="fas fa-chevron-left mr-2"></i> Soal Sebelumnya
                    </button>
                    <div class="w-full sm:w-1/3">
                        <p class="text-center text-xs text-gray-500 mb-1">Progress</p>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <button id="nextQuestionBtn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
                        Soal Selanjutnya <i class="fas fa-chevron-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Question List Modal -->
    <div id="questionListModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Daftar Soal</h3>
                <button id="closeQuestionListBtn" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="overflow-y-auto">
                <div id="questionListModalContent" class="grid grid-cols-5 gap-2 sm:gap-4">
                    <!-- Navigation buttons will be rendered here via JS -->
      u          </div>
            </div>
            <div class="mt-6 pt-4 border-t flex justify-center items-center gap-4 text-sm flex-wrap">
                <span class="flex items-center"><span class="w-4 h-4 rounded-full bg-green-500 mr-2"></span>Sudah dijawab</span>
                <span class="flex items-center"><span class="w-4 h-4 rounded-full bg-blue-500 mr-2"></span>Dikerjakan</span>
                <span class="flex items-center"><span class="w-4 h-4 rounded-full bg-gray-300 mr-2"></span>Belum dijawab</span>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // FIREBASE CONFIGURATION
        // =================================================================
        // PASTE KONFIGURASI FIREBASE ANDA DI SINI
        const firebaseConfig = {
            apiKey: "AIzaSyB8C9Y_i02CRiroLqwkImf9hw49_4Kxx-A",
            authDomain: "cbt-nurul-kautsar.firebaseapp.com",
            projectId: "cbt-nurul-kautsar",
            storageBucket: "cbt-nurul-kautsar.firebasestorage.app",
            messagingSenderId: "862806304239",
            appId: "1:862806304239:web:d2a11dc542450e9b22021a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth(); // Firebase Auth instance
        
        // =================================================================
        // GOOGLE SCRIPT CONFIGURATION
        // =================================================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwryYlMGYwDp0t4l96WY_OuEmoFB8sOxUjHcm1756tWEGVM4DyMvEq0W0JF2_vZORv3/exec';


        // =================================================================
        // APPLICATION STATE
        // =================================================================
        const AppState = {
            currentUser: null,
            currentQuestion: 0,
            examAnswers: {},
            examTimer: null,
            examTimeLeft: 3600, // 60 minutes in seconds
            questions: [], // This will be populated from Firestore for the current exam
            currentView: 'login',
            selectedExamCode: null,
            lastQuestionData: { semester: '', tahunAjaran: '' }, // To store last used question data for teacher
            filters: {
                questions: { kelas: '', mataPelajaran: '', kode: '' },
                results: { kodesoal: '', mataPelajaran: '', kelas: '', namaLengkap: '' },
                grades: { kodeSoal: '', mataPelajaran: '', kelas: '', namaSiswa: '' }
            },
            currentlyDisplayed: {
                questions: [],
                results: [], // This will now be populated from Google Sheets
                grades: []
            },
            // Users are fetched from Google Script
            users: [],
            // Classes and Subjects remain local
            classes: [
                { id: 1, nama: '4A', deskripsi: 'Kelas 4A' }, { id: 2, nama: '4B', deskripsi: 'Kelas 4B' },
                { id: 3, nama: '4C', deskripsi: 'Kelas 4C' }, { id: 4, nama: '4D', deskripsi: 'Kelas 4D' },
                { id: 5, nama: '5A', deskripsi: 'Kelas 5A' }, { id: 6, nama: '5B', deskripsi: 'Kelas 5B' },
                { id: 9, nama: '6A', deskripsi: 'Kelas 6A' }, { id: 10, nama: '6B', deskripsi: 'Kelas 6B' }
            ],
            subjects: [
                { id: 1, nama: 'Bahasa Indonesia', deskripsi: 'Mata pelajaran Bahasa Indonesia' },
                { id: 2, nama: 'Matematika', deskripsi: 'Mata pelajaran Matematika' },
                { id: 3, nama: 'Bahasa Inggris', deskripsi: 'Mata pelajaran Bahasa Inggris' },
                { id: 4, nama: 'Pend. Pancasila', deskripsi: 'Mata pelajaran Pend. Pancasila' },
                { id: 5, nama: 'IPAS', deskripsi: 'Mata pelajaran IPAS' },
                { id: 6, nama: 'Seni Rupa', deskripsi: 'Mata pelajaran Seni Rupa' },
                { id: 7, nama: 'Tauhid', deskripsi: 'Mata pelajaran Tauhid' },
                { id: 8, nama: 'Bahasa Arab', deskripsi: 'Mata pelajaran Bahasa Arab' },
                { id: 9, nama: 'Fikih', deskripsi: 'Mata pelajaran Fikih' },
                { id: 10, nama: 'Siroh', deskripsi: 'Mata pelajaran Siroh' },
                { id: 11, nama: 'Akhlak', deskripsi: 'Mata pelajaran Akhlak' },
                { id: 12, nama: 'Hadits', deskripsi: 'Mata pelajaran Hadits' },
                { id: 13, nama: 'Khot', deskripsi: 'Mata pelajaran Khot' },
                { id: 14, nama: 'PJOK', deskripsi: 'Mata pelajaran PJOK' }
            ]
        };
        
        // =================================================================
        // DATA FETCHING
        // =================================================================
        async function fetchUsersFromGoogleScript() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                if (result.status === 'success' && Array.isArray(result.data)) {
                    // Add a unique local ID to each user for easier management
                    AppState.users = result.data.map((user, index) => ({
                        ...user,
                        id: `gs-user-${index}`
                    }));
                    console.log('User data loaded successfully from Google Script.');
                    return true;
                } else {
                    throw new Error('Invalid data format received from Google Script.');
                }
            } catch (error) {
                console.error('Failed to fetch user data:', error);
                const loginError = document.getElementById('loginError');
                loginError.textContent = 'Gagal memuat data pengguna. Silakan muat ulang halaman.';
                loginError.classList.remove('hidden');
                return false;
            }
        }

        // =================================================================
        // EXAM SECURITY SYSTEM
        // =================================================================
        const ExamSecurity = {
            getAttemptsKey: (username, examCode) => `cbtAttempts_${username}_${examCode}`,
            getBlockTimestampKey: (username, examCode) => `cbtBlock_${username}_${examCode}`,

            getAttempts: function(username, examCode) {
                return parseInt(localStorage.getItem(this.getAttemptsKey(username, examCode)) || '0');
            },

            incrementAttempts: function(username, examCode) {
                let attempts = this.getAttempts(username, examCode);
                attempts++;
                localStorage.setItem(this.getAttemptsKey(username, examCode), attempts.toString());
                return attempts;
            },

            clearAttempts: function(username, examCode) {
                localStorage.removeItem(this.getAttemptsKey(username, examCode));
                localStorage.removeItem(this.getBlockTimestampKey(username, examCode));
            },

            block: function(username, examCode) {
                const now = Date.now();
                localStorage.setItem(this.getBlockTimestampKey(username, examCode), now.toString());
            },

            isBlocked: function(username, examCode) {
                const blockTimestamp = localStorage.getItem(this.getBlockTimestampKey(username, examCode));
                if (!blockTimestamp) return false;

                const oneHour = 60 * 60 * 1000;
                const timeSinceBlock = Date.now() - parseInt(blockTimestamp);

                if (timeSinceBlock < oneHour) {
                    return true;
                } else {
                    // Block expired, clear it
                    this.clearAttempts(username, examCode);
                    return false;
                }
            },

            getBlockTimeRemaining: function(username, examCode) {
                const blockTimestamp = localStorage.getItem(this.getBlockTimestampKey(username, examCode));
                if (!blockTimestamp) return '0 detik';

                const oneHour = 60 * 60 * 1000;
                const blockEndTime = parseInt(blockTimestamp) + oneHour;
                const remainingMs = blockEndTime - Date.now();

                if (remainingMs <= 0) return '0 detik';

                const minutes = Math.floor(remainingMs / 60000);
                const seconds = Math.floor((remainingMs % 60000) / 1000);

                return `${minutes} menit ${seconds} detik`;
            },
        };


        // =================================================================
        // MANAGEMENT SYSTEM (with Firebase & Google Sheet Integration)
        // =================================================================
        const Management = {
            generateId() {
                return 'id-' + Date.now() + Math.random().toString(36).substr(2, 9);
            },

            // User, Class, Subject management remain local as requested
            showAddUserModal() {
                const content = `
                    <form id="addUserForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input type="text" name="username" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input type="password" name="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" name="nama" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                <select name="role" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="this.value === 'siswa' ? document.getElementById('kelasField').classList.remove('hidden') : document.getElementById('kelasField').classList.add('hidden')">
                                    <option value="">Pilih Role</option>
                                    <option value="admin">Admin</option>
                                    <option value="guru">Guru</option>
                                    <option value="siswa">Siswa</option>
                                </select>
                            </div>
                        </div>
                        <div id="kelasField" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                            <select name="kelas" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Pilih Kelas</option>
                                ${AppState.classes.map(c => `<option value="${c.nama}">${c.nama}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan</button>
                        </div>
                    </form>
                `;
                UI.showModal('Tambah Pengguna', content);
                
                document.getElementById('addUserForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const userData = Object.fromEntries(formData);
                    
                    if (userData.role !== 'siswa') {
                        userData.kelas = '';
                    }
                    
                    AppState.users.push({
                        id: this.generateId(),
                        ...userData
                    });
                    
                    UI.hideModal();
                    UI.showUserManagement();
                    UI.showNotification('Pengguna berhasil ditambahkan! Perubahan hanya bersifat lokal.', 'success');
                });
            },

            viewUser(id) {
                const user = AppState.users.find(u => u.id == id);
                const content = `
                    <div class="space-y-4">
                        <div><strong>Username:</strong> ${user.username}</div>
                        <div><strong>Nama:</strong> ${user.nama}</div>
                        <div><strong>Role:</strong> ${user.role}</div>
                        <div><strong>Kelas:</strong> ${user.kelas || '-'}</div>
                    </div>
                    <div class="flex justify-end pt-4">
                        <button onclick="UI.hideModal()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Tutup</button>
                    </div>
                `;
                UI.showModal('Detail Pengguna', content);
            },

            editUser(id) {
                const user = AppState.users.find(u => u.id == id);
                const content = `
                    <form id="editUserForm" class="space-y-4">
                        <input type="hidden" name="id" value="${user.id}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input type="text" name="username" value="${user.username}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input type="password" name="password" value="${user.password}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" name="nama" value="${user.nama}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                <select name="role" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="this.value === 'siswa' ? document.getElementById('editKelasField').classList.remove('hidden') : document.getElementById('editKelasField').classList.add('hidden')">
                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                    <option value="guru" ${user.role === 'guru' ? 'selected' : ''}>Guru</option>
                                    <option value="siswa" ${user.role === 'siswa' ? 'selected' : ''}>Siswa</option>
                                </select>
                            </div>
                        </div>
                        <div id="editKelasField" class="${user.role === 'siswa' ? '' : 'hidden'}">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                            <select name="kelas" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Pilih Kelas</option>
                                ${AppState.classes.map(c => `<option value="${c.nama}" ${user.kelas === c.nama ? 'selected' : ''}>${c.nama}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update</button>
                        </div>
                    </form>
                `;
                UI.showModal('Edit Pengguna', content);
                
                document.getElementById('editUserForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const userData = Object.fromEntries(formData);
                    
                    if (userData.role !== 'siswa') {
                        userData.kelas = '';
                    }
                    
                    const index = AppState.users.findIndex(u => u.id == userData.id);
                    if (index !== -1) {
                        AppState.users[index] = { ...AppState.users[index], ...userData };
                        UI.hideModal();
                        UI.showUserManagement();
                        UI.showNotification('Pengguna berhasil diupdate! Perubahan hanya bersifat lokal.', 'success');
                    }
                });
            },

            deleteUser(id) {
                UI.showConfirmModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus pengguna ini? Perubahan hanya bersifat lokal.', () => {
                    AppState.users = AppState.users.filter(u => u.id != id);
                    UI.showUserManagement();
                    UI.showNotification('Pengguna berhasil dihapus secara lokal!', 'success');
                });
            },

            showAddClassModal() {
                const content = `
                    <form id="addClassForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kelas</label>
                            <input type="text" name="nama" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: 1A">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                            <textarea name="deskripsi" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Deskripsi kelas"></textarea>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan</button>
                        </div>
                    </form>
                `;
                UI.showModal('Tambah Kelas', content);
                
                document.getElementById('addClassForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const classData = Object.fromEntries(formData);
                    
                    AppState.classes.push({
                        id: this.generateId(),
                        ...classData
                    });
                    
                    UI.hideModal();
                    UI.showClassManagement();
                    UI.showNotification('Kelas berhasil ditambahkan!', 'success');
                });
            },

            editClass(id) {
                const cls = AppState.classes.find(c => c.id == id);
                const content = `
                    <form id="editClassForm" class="space-y-4">
                        <input type="hidden" name="id" value="${cls.id}">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kelas</label>
                            <input type="text" name="nama" value="${cls.nama}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                            <textarea name="deskripsi" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${cls.deskripsi}</textarea>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update</button>
                        </div>
                    </form>
                `;
                UI.showModal('Edit Kelas', content);
                
                document.getElementById('editClassForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const classData = Object.fromEntries(formData);
                    
                    const index = AppState.classes.findIndex(c => c.id == classData.id);
                    if (index !== -1) {
                        AppState.classes[index] = { ...AppState.classes[index], ...classData };
                        UI.hideModal();
                        UI.showClassManagement();
                        UI.showNotification('Kelas berhasil diupdate!', 'success');
                    }
                });
            },

            deleteClass(id) {
                UI.showConfirmModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus kelas ini?', () => {
                    AppState.classes = AppState.classes.filter(c => c.id != id);
                    UI.showClassManagement();
                    UI.showNotification('Kelas berhasil dihapus!', 'success');
                });
            },

            showAddSubjectModal() {
                const content = `
                    <form id="addSubjectForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Mata Pelajaran</label>
                            <input type="text" name="nama" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Matematika">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                            <textarea name="deskripsi" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Deskripsi mata pelajaran"></textarea>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan</button>
                        </div>
                    </form>
                `;
                UI.showModal('Tambah Mata Pelajaran', content);
                
                document.getElementById('addSubjectForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const subjectData = Object.fromEntries(formData);
                    
                    AppState.subjects.push({
                        id: this.generateId(),
                        ...subjectData
                    });
                    
                    UI.hideModal();
                    UI.showSubjectManagement();
                    UI.showNotification('Mata pelajaran berhasil ditambahkan!', 'success');
                });
            },

            editSubject(id) {
                const subject = AppState.subjects.find(s => s.id == id);
                const content = `
                    <form id="editSubjectForm" class="space-y-4">
                        <input type="hidden" name="id" value="${subject.id}">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Mata Pelajaran</label>
                            <input type="text" name="nama" value="${subject.nama}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                            <textarea name="deskripsi" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${subject.deskripsi}</textarea>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update</button>
                        </div>
                    </form>
                `;
                UI.showModal('Edit Mata Pelajaran', content);
                
                document.getElementById('editSubjectForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const subjectData = Object.fromEntries(formData);
                    
                    const index = AppState.subjects.findIndex(s => s.id == subjectData.id);
                    if (index !== -1) {
                        AppState.subjects[index] = { ...AppState.subjects[index], ...subjectData };
                        UI.hideModal();
                        UI.showSubjectManagement();
                        UI.showNotification('Mata pelajaran berhasil diupdate!', 'success');
                    }
                });
            },

            deleteSubject(id) {
                UI.showConfirmModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus mata pelajaran ini?', () => {
                    AppState.subjects = AppState.subjects.filter(s => s.id != id);
                    UI.showSubjectManagement();
                    UI.showNotification('Mata pelajaran berhasil dihapus!', 'success');
                });
            },

            // =================================================================
            // Question Management (Firebase Integration)
            // =================================================================
            showAddQuestionModal() {
                const lastData = AppState.lastQuestionData;
                let classOptions = '';
                if (AppState.currentUser.role === 'guru' && AppState.currentUser.kelas) {
                    const teacherGrade = AppState.currentUser.kelas.charAt(0);
                    const availableClasses = AppState.classes.filter(c => c.nama.startsWith(teacherGrade));
                    classOptions = availableClasses.map(c => `<option value="${c.nama}" ${lastData.kelas === c.nama ? 'selected' : ''}>${c.nama}</option>`).join('');
                } else { // Admin sees all classes
                    classOptions = AppState.classes.map(c => `<option value="${c.nama}" ${lastData.kelas === c.nama ? 'selected' : ''}>${c.nama}</option>`).join('');
                }

                const content = `
                    <form id="addQuestionForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran</label>
                                <select name="tahunAjaran" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Tahun Ajaran</option>
                                    ${UI.getYearOptions(lastData.tahunAjaran)}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Semester Ujian</label>
                                <select name="semester" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Semester</option>
                                    ${UI.getSemesterOptions(lastData.semester)}
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kode Soal</label>
                                <input type="text" name="kode" value="${lastData.kode || ''}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: PAI001">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select name="kelas" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Kelas</option>
                                    ${classOptions}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <select name="mataPelajaran" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Mata Pelajaran</option>
                                    ${AppState.subjects.map(s => `<option value="${s.nama}" ${lastData.mataPelajaran === s.nama ? 'selected' : ''}>${s.nama}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipe Soal</label>
                            <select id="questionTypeSelect" name="tipe" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="const type = this.value; document.getElementById('pilihanField').classList.toggle('hidden', type !== 'pilihan_ganda'); document.getElementById('jawabanTeksField').classList.toggle('hidden', type === 'pilihan_ganda' || type === '');">
                                <option value="">Pilih Tipe Soal</option>
                                <option value="pilihan_ganda" ${lastData.tipe === 'pilihan_ganda' ? 'selected' : ''}>Pilihan Ganda</option>
                                <option value="isian" ${lastData.tipe === 'isian' ? 'selected' : ''}>Isian</option>
                                <option value="uraian" ${lastData.tipe === 'uraian' ? 'selected' : ''}>Uraian</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pertanyaan</label>
                            <textarea name="pertanyaan" rows="4" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan pertanyaan"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Upload Gambar (Opsional)</label>
                            <input type="file" id="gambarInput" name="gambar" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Ukuran gambar maksimal 10cm x 10cm</p>
                        </div>
                        <div id="pilihanField" class="${lastData.tipe === 'pilihan_ganda' ? '' : 'hidden'} space-y-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pilihan Jawaban</label>
                            <input type="text" name="pilihan1" placeholder="Pilihan A" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" name="pilihan2" placeholder="Pilihan B" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" name="pilihan3" placeholder="Pilihan C" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" name="pilihan4" placeholder="Pilihan D" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <select name="jawabanBenar" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Pilih Jawaban Benar</option>
                                <option value="0">A</option>
                                <option value="1">B</option>
                                <option value="2">C</option>
                                <option value="3">D</option>
                            </select>
                        </div>
                        <div id="jawabanTeksField" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jawaban Benar</label>
                            <textarea name="jawabanBenarTeks" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan jawaban yang benar untuk soal isian/uraian"></textarea>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan</button>
                        </div>
                    </form>
                `;
                UI.showModal('Tambah Soal', content);
                
                document.getElementById('addQuestionForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const submitButton = form.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...';

                    const formData = new FormData(form);
                    const questionData = Object.fromEntries(formData);
                    
                    // Tambahkan informasi pemilik soal
                    questionData.createdBy = AppState.currentUser.nama;
                    
                    const fileInput = document.getElementById('gambarInput');
                    if (fileInput.files[0]) {
                        questionData.gambar = await UI.toBase64(fileInput.files[0]);
                    } else {
                        questionData.gambar = null;
                    }

                    if (questionData.tipe === 'pilihan_ganda') {
                        questionData.pilihan = [
                            questionData.pilihan1,
                            questionData.pilihan2,
                            questionData.pilihan3,
                            questionData.pilihan4
                        ].filter(p => p);
                        questionData.correct = parseInt(questionData.jawabanBenar);
                        delete questionData.pilihan1;
                        delete questionData.pilihan2;
                        delete questionData.pilihan3;
                        delete questionData.pilihan4;
                        delete questionData.jawabanBenar;
                    } else if (questionData.tipe === 'isian' || questionData.tipe === 'uraian') {
                        questionData.jawabanBenar = questionData.jawabanBenarTeks;
                        delete questionData.jawabanBenarTeks;
                    }
                    
                    try {
                        // Add timestamp for ordering
                        questionData.createdAt = firebase.firestore.FieldValue.serverTimestamp(); 
                        
                        // Firebase Integration: Add question to Firestore
                        await db.collection('examQuestions').add(questionData);
                        AppState.lastQuestionData = {
                            tahunAjaran: questionData.tahunAjaran,
                            semester: questionData.semester,
                            kode: questionData.kode,
                            kelas: questionData.kelas,
                            mataPelajaran: questionData.mataPelajaran,
                            tipe: questionData.tipe
                        };
                        UI.hideModal();
                        UI.showNotification('Soal berhasil ditambahkan', 'success');
                    } catch (error) {
                        console.error("Error adding document: ", error);
                        UI.showNotification('Gagal menambahkan soal!', 'error');
                    } finally {
                         submitButton.disabled = false;
                         submitButton.innerHTML = 'Simpan';
                    }
                });
            },

            async viewQuestion(id) {
                try {
                    const doc = await db.collection('examQuestions').doc(id).get();
                    if (!doc.exists) {
                        UI.showNotification('Soal tidak ditemukan', 'error');
                        return;
                    }
                    const question = { id: doc.id, ...doc.data() };

                    let optionsHtml = '';
                    if (question.tipe === 'pilihan_ganda' && Array.isArray(question.pilihan)) {
                        optionsHtml = `
                            <div class="mt-4">
                                <h5 class="font-semibold text-gray-700 mb-2">Pilihan Jawaban:</h5>
                                <ul class="list-disc list-inside space-y-2">
                                    ${question.pilihan.map((opt, index) => `
                                        <li class="${index === question.correct ? 'font-bold text-green-600' : ''}">
                                            ${String.fromCharCode(65 + index)}. ${opt} ${index === question.correct ? '(Jawaban Benar)' : ''}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        `;
                    } else if ((question.tipe === 'isian' || question.tipe === 'uraian') && question.jawabanBenar) {
                        optionsHtml = `
                            <div class="mt-4">
                                <h5 class="font-semibold text-gray-700 mb-2">Kunci Jawaban:</h5>
                                <p class="p-4 bg-green-50 rounded-md border text-green-800">${question.jawabanBenar}</p>
                            </div>
                        `;
                    }

                    const content = `
                        <div class="space-y-4 text-gray-800">
                            <div>
                                <span class="font-semibold">Kode Soal:</span>
                                <span>${question.kode}</span>
                            </div>
                            <div>
                                <span class="font-semibold">Kelas:</span>
                                <span>${question.kelas}</span>
                            </div>
                            <div>
                                <span class="font-semibold">Mata Pelajaran:</span>
                                <span>${question.mataPelajaran}</span>
                            </div>
                            <div>
                                <span class="font-semibold">Tipe Soal:</span>
                                <span>${question.tipe}</span>
                            </div>
                            <hr class="my-4">
                            <div>
                                <h5 class="font-semibold mb-2">Pertanyaan:</h5>
                                <p class="p-4 bg-gray-50 rounded-md border">${question.pertanyaan || question.question || ''}</p>
                            </div>
                            ${question.gambar ? `
                                <div class="mt-4">
                                    <h5 class="font-semibold text-gray-700 mb-2">Gambar:</h5>
                                    <img src="${question.gambar}" class="w-full max-w-sm mx-auto rounded-lg shadow-sm border">
                                </div>
                            ` : ''}
                            ${optionsHtml}
                        </div>
                        <div class="flex justify-end pt-6 mt-6 border-t">
                            <button onclick="UI.hideModal()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Tutup</button>
                        </div>
                    `;
                    UI.showModal('Detail Soal', content);
                } catch (error) {
                    console.error("Error viewing question: ", error);
                    UI.showNotification('Gagal memuat detail soal.', 'error');
                }
            },

            async editQuestion(id) {
                try {
                    // Firebase Integration: Get question from Firestore
                    const doc = await db.collection('examQuestions').doc(id).get();
                    if (!doc.exists) {
                        UI.showNotification('Soal tidak ditemukan', 'error');
                        return;
                    }
                    const question = { id: doc.id, ...doc.data() };

                    let classOptions = '';
                    if (AppState.currentUser.role === 'guru' && AppState.currentUser.kelas) {
                        const teacherGrade = AppState.currentUser.kelas.charAt(0);
                        const availableClasses = AppState.classes.filter(c => c.nama.startsWith(teacherGrade));
                        classOptions = availableClasses.map(c => `<option value="${c.nama}" ${question.kelas === c.nama ? 'selected' : ''}>${c.nama}</option>`).join('');
                    } else { // Admin sees all classes
                        classOptions = AppState.classes.map(c => `<option value="${c.nama}" ${question.kelas === c.nama ? 'selected' : ''}>${c.nama}</option>`).join('');
                    }
                    
                    const content = `
                        <form id="editQuestionForm" class="space-y-4">
                            <input type="hidden" name="id" value="${question.id}">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran</label>
                                    <select name="tahunAjaran" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Pilih Tahun Ajaran</option>
                                        ${UI.getYearOptions(question.tahunAjaran)}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Semester Ujian</label>
                                    <select name="semester" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Pilih Semester</option>
                                        ${UI.getSemesterOptions(question.semester)}
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kode Soal</label>
                                    <input type="text" name="kode" value="${question.kode || ''}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                    <select name="kelas" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Pilih Kelas</option>
                                        ${classOptions}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                    <select name="mataPelajaran" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Pilih Mata Pelajaran</option>
                                        ${AppState.subjects.map(s => `<option value="${s.nama}" ${question.mataPelajaran === s.nama ? 'selected' : ''}>${s.nama}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipe Soal</label>
                                <select name="tipe" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="const type = this.value; document.getElementById('editPilihanField').classList.toggle('hidden', type !== 'pilihan_ganda'); document.getElementById('editJawabanTeksField').classList.toggle('hidden', type === 'pilihan_ganda' || type === '');">
                                    <option value="pilihan_ganda" ${question.tipe === 'pilihan_ganda' ? 'selected' : ''}>Pilihan Ganda</option>
                                    <option value="isian" ${question.tipe === 'isian' ? 'selected' : ''}>Isian</option>
                                    <option value="uraian" ${question.tipe === 'uraian' ? 'selected' : ''}>Uraian</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pertanyaan</label>
                                <textarea name="pertanyaan" rows="4" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${question.pertanyaan || question.question || ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Gambar (Opsional)</label>
                                <input type="file" id="editGambarInput" name="gambar" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-gray-500 mt-1">Pilih gambar baru untuk mengganti yang lama. Ukuran maksimal 10cm x 10cm.</p>
                                <div id="editImagePreview" class="mt-2">
                                    ${question.gambar ? `<img src="${question.gambar}" class="w-full max-w-sm mx-auto rounded-lg shadow-sm">` : ''}
                                </div>
                            </div>
                            <div id="editPilihanField" class="${question.tipe === 'pilihan_ganda' ? '' : 'hidden'} space-y-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pilihan Jawaban</label>
                                <input type="text" name="pilihan1" value="${question.pilihan ? question.pilihan[0] || '' : ''}" placeholder="Pilihan A" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <input type="text" name="pilihan2" value="${question.pilihan ? question.pilihan[1] || '' : ''}" placeholder="Pilihan B" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <input type="text" name="pilihan3" value="${question.pilihan ? question.pilihan[2] || '' : ''}" placeholder="Pilihan C" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <input type="text" name="pilihan4" value="${question.pilihan ? question.pilihan[3] || '' : ''}" placeholder="Pilihan D" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <select name="jawabanBenar" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Jawaban Benar</option>
                                    <option value="0" ${question.correct === 0 ? 'selected' : ''}>A</option>
                                    <option value="1" ${question.correct === 1 ? 'selected' : ''}>B</option>
                                    <option value="2" ${question.correct === 2 ? 'selected' : ''}>C</option>
                                    <option value="3" ${question.correct === 3 ? 'selected' : ''}>D</option>
                                </select>
                            </div>
                            <div id="editJawabanTeksField" class="${question.tipe === 'isian' || question.tipe === 'uraian' ? '' : 'hidden'}">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Jawaban Benar</label>
                                <textarea name="jawabanBenarTeks" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${question.jawabanBenar || ''}</textarea>
                            </div>
                            <div class="flex justify-end space-x-2 pt-4">
                                <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update</button>
                            </div>
                        </form>
                    `;
                    UI.showModal('Edit Soal', content);
                    
                    document.getElementById('editQuestionForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const form = e.target;
                        const submitButton = form.querySelector('button[type="submit"]');
                        submitButton.disabled = true;
                        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Mengupdate...';

                        const formData = new FormData(form);
                        const questionData = Object.fromEntries(formData);
                        
                        // Preserve the original creator or assign current editor as owner for old questions
                        if (question.createdBy) {
                            questionData.createdBy = question.createdBy;
                        } else {
                            questionData.createdBy = AppState.currentUser.nama;
                        }
                        
                        const fileInput = document.getElementById('editGambarInput');
                        if (fileInput.files[0]) {
                            questionData.gambar = await UI.toBase64(fileInput.files[0]);
                        } else {
                            questionData.gambar = question.gambar;
                        }
                        
                        if (questionData.tipe === 'pilihan_ganda') {
                            questionData.pilihan = [
                                questionData.pilihan1, questionData.pilihan2, questionData.pilihan3, questionData.pilihan4
                            ].filter(p => p);
                            questionData.correct = parseInt(questionData.jawabanBenar);
                            questionData.jawabanBenar = null; // Clear text answer
                            delete questionData.pilihan1;
                            delete questionData.pilihan2;
                            delete questionData.pilihan3;
                            delete questionData.pilihan4;
                            delete questionData.jawabanBenarTeks;
                        } else if (questionData.tipe === 'isian' || questionData.tipe === 'uraian') {
                            questionData.jawabanBenar = questionData.jawabanBenarTeks;
                            questionData.pilihan = []; // Clear choices
                            questionData.correct = null; // Clear correct choice
                            delete questionData.jawabanBenarTeks;
                        }
                        
                        try {
                            // Firebase Integration: Update question in Firestore
                            await db.collection('examQuestions').doc(question.id).set(questionData, { merge: true });
                            UI.hideModal();
                            UI.showNotification('Soal berhasil diupdate!', 'success');
                        } catch (error) {
                            console.error("Error updating document: ", error);
                            UI.showNotification('Gagal mengupdate soal!', 'error');
                        } finally {
                            submitButton.disabled = false;
                            submitButton.innerHTML = 'Update';
                        }
                    });

                } catch (error) {
                    console.error("Error getting document:", error);
                    UI.showNotification('Gagal memuat soal untuk diedit!', 'error');
                }
            },

            deleteQuestion(id) {
                UI.showConfirmModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus soal ini dari Firebase?', async () => {
                    try {
                        // Firebase Integration: Delete question from Firestore
                        await db.collection('examQuestions').doc(id).delete();
                        UI.showNotification('Soal berhasil dihapus!', 'success');
                    } catch (error) {
                        console.error("Error removing document: ", error);
                        UI.showNotification('Gagal menghapus soal!', 'error');
                    }
                });
            },

            renderFilteredQuestions(questions) {
                AppState.currentlyDisplayed.questions = questions; // Store for bulk delete
                const questionsList = document.getElementById('questionsList');
                if (!questionsList) return;

                const typeOrder = { 'pilihan_ganda': 1, 'isian': 2, 'uraian': 3 };
                questions.sort((a, b) => {
                    const typeA = typeOrder[a.tipe] || 99;
                    const typeB = typeOrder[b.tipe] || 99;
                    if (typeA !== typeB) {
                        return typeA - typeB;
                    }
                    const timeA = a.createdAt ? a.createdAt.toMillis() : 0;
                    const timeB = b.createdAt ? b.createdAt.toMillis() : 0;
                    return timeA - timeB;
                });

                questionsList.innerHTML = questions.length === 0 ?
                    '<div class="bg-white rounded-lg shadow p-6 text-center text-gray-500">Tidak ada soal yang sesuai dengan filter</div>' :
                    questions.map((question, index) => {
                        // Allow admin to edit everything.
                        // Allow teachers to edit their own questions OR orphaned questions.
                        const canEdit = AppState.currentUser.role === 'admin' || 
                                      (question.createdBy && question.createdBy === AppState.currentUser.nama) ||
                                      (!question.createdBy && AppState.currentUser.role === 'guru');

                        return `
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-2 flex-wrap">
                                        <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">${question.kelas}</span>
                                        <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">${question.mataPelajaran}</span>
                                        <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">${question.tipe}</span>
                                        <span class="text-xs text-gray-500">Kode: ${question.kode}</span>
                                        <span class="text-xs text-gray-400">Dibuat oleh: ${question.createdBy || '-'}</span>
                                    </div>
                                    <h4 class="font-medium text-gray-900 mb-2">Soal No. ${index + 1}</h4>
                                    <p class="text-gray-700 mb-3">${(question.pertanyaan || '').length > 100 ? (question.pertanyaan || '').substring(0, 100) + '...' : (question.pertanyaan || '')}</p>
                                </div>
                                <div class="flex space-x-3 ml-4">
                                    <button onclick="Management.viewQuestion('${question.id}')" class="text-blue-600 hover:text-blue-900" title="Lihat Soal">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${canEdit ? `
                                    <button onclick="Management.editQuestion('${question.id}')" class="text-green-600 hover:text-green-900" title="Edit Soal">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="Management.deleteQuestion('${question.id}')" class="text-red-600 hover:text-red-900" title="Hapus Soal">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `}).join('');
            },

            showAutoGenerateModal() {
                const lastData = AppState.lastQuestionData;
                let classOptions = '';
                 if (AppState.currentUser.role === 'guru' && AppState.currentUser.kelas) {
                    const teacherGrade = AppState.currentUser.kelas.charAt(0);
                    const availableClasses = AppState.classes.filter(c => c.nama.startsWith(teacherGrade));
                    classOptions = availableClasses.map(c => `<option value="${c.nama}" ${lastData.kelas === c.nama ? 'selected' : ''}>${c.nama}</option>`).join('');
                } else {
                    classOptions = AppState.classes.map(c => `<option value="${c.nama}" ${lastData.kelas === c.nama ? 'selected' : ''}>${c.nama}</option>`).join('');
                }

                const content = `
                    <form id="geminiGenerateForm" class="space-y-4">
                        <p class="text-sm text-gray-600 mb-4">Isi form di bawah ini untuk membuat soal secara otomatis menggunakan AI. Pastikan topik yang dimasukkan spesifik.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran</label>
                                <select name="tahunAjaran" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${UI.getYearOptions(lastData.tahunAjaran)}</select>
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Semester Ujian</label>
                                <select name="semester" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${UI.getSemesterOptions(lastData.semester)}</select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <select name="mataPelajaran" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Mata Pelajaran</option>
                                    ${AppState.subjects.map(s => `<option value="${s.nama}" ${lastData.mataPelajaran === s.nama ? 'selected' : ''}>${s.nama}</option>`).join('')}
                                </select>
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select name="kelas" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Kelas</option>
                                    ${classOptions}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kode Soal (Dasar)</label>
                                <input type="text" name="kodeSoal" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: PAI-STS-1">
                            </div>
                        </div>

                         <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Topik / Materi Pembahasan</label>
                            <input type="text" name="topik" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Perang Diponegoro, Penjumlahan Pecahan">
                        </div>

                        <div class="p-4 border rounded-lg bg-gray-50">
                            <label class="block text-sm font-medium text-gray-700 mb-3">Tentukan Jumlah Soal per Tipe (Total Maks. 100)</label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Pilihan Ganda</label>
                                    <input type="number" name="jumlah_pg" min="0" max="100" value="5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Isian Singkat</label>
                                    <input type="number" name="jumlah_isian" min="0" max="100" value="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Uraian / Esai</label>
                                    <input type="number" name="jumlah_uraian" min="0" max="100" value="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end pt-4">
                            <button type="submit" class="w-full bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition duration-200 font-semibold"><i class="fas fa-magic mr-2"></i>Buat Soal</button>
                        </div>
                    </form>
                    <div id="geminiResultArea" class="mt-6"></div>
                `;
                UI.showGeminiModal('âœ¨ Buat Soal Otomatis dengan AI', content);

                document.getElementById('geminiGenerateForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const submitButton = form.querySelector('button[type="submit"]');
                    const resultArea = document.getElementById('geminiResultArea');
                    
                    const formData = new FormData(form);
                    const promptData = Object.fromEntries(formData);

                    const jumlahPg = parseInt(promptData.jumlah_pg) || 0;
                    const jumlahIsian = parseInt(promptData.jumlah_isian) || 0;
                    const jumlahUraian = parseInt(promptData.jumlah_uraian) || 0;
                    const totalSoal = jumlahPg + jumlahIsian + jumlahUraian;

                    if (totalSoal <= 0) {
                        UI.showNotification('Masukkan jumlah soal yang ingin dibuat.', 'error');
                        return;
                    }
                    if (totalSoal > 100) {
                        UI.showNotification('Total jumlah soal tidak boleh melebihi 100.', 'error');
                        return;
                    }

                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sedang membuat soal...';
                    resultArea.innerHTML = '<div class="text-center p-8"><i class="fas fa-robot fa-spin text-3xl text-purple-600"></i><p class="mt-3 text-gray-600">AI sedang bekerja, mohon tunggu sebentar...</p></div>';

                    const generatedQuestions = await GeminiHelper.generateQuestions(promptData);

                    if (generatedQuestions && generatedQuestions.length > 0) {
                        this.renderGeneratedQuestions(generatedQuestions, promptData, resultArea);
                    } else {
                        resultArea.innerHTML = '<div class="text-center p-8 bg-red-50 rounded-lg"><i class="fas fa-exclamation-triangle text-3xl text-red-600"></i><p class="mt-3 text-red-700 font-semibold">Gagal membuat soal.</p><p class="text-sm text-red-600">Terjadi kesalahan saat menghubungi AI. Coba lagi beberapa saat.</p></div>';
                    }
                    
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="fas fa-magic mr-2"></i>Buat Soal';
                });
            },

            renderGeneratedQuestions(questions, metadata, container) {
                let html = '<h3 class="text-lg font-bold mb-4">Hasil Soal yang Dibuat:</h3>';
                html += questions.map((q, index) => {
                    let answerHtml = '';
                    if(q.pilihan && q.pilihan.length > 0) {
                        answerHtml = `<ul class="list-disc list-inside space-y-1 pl-4 mt-2">${q.pilihan.map((opt, i) => `<li class="${i === q.correct ? 'font-bold text-green-700' : ''}">${opt} ${i === q.correct ? '<span class="text-green-600 font-normal">(Jawaban Benar)</span>' : ''}</li>`).join('')}</ul>`;
                    } else if (q.jawabanBenar) {
                        answerHtml = `<div class="mt-2 p-2 bg-green-50 border border-green-200 rounded-md"><p class="text-sm text-green-800"><strong>Kunci Jawaban:</strong> ${q.jawabanBenar}</p></div>`;
                    }

                    return `<div class="p-4 border rounded-lg mb-3 bg-gray-50">
                                <p class="font-semibold">${index + 1}. ${q.pertanyaan}</p>
                                ${answerHtml}
                            </div>`;
                }).join('');

                html += `<div class="flex justify-end pt-4 mt-4 border-t">
                            <button id="saveGeneratedQuestionsBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold"><i class="fas fa-save mr-2"></i>Simpan Semua Soal</button>
                         </div>`;
                container.innerHTML = html;

                document.getElementById('saveGeneratedQuestionsBtn').addEventListener('click', async () => {
                    const button = document.getElementById('saveGeneratedQuestionsBtn');
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...';

                    const batch = db.batch();
                    const baseCode = metadata.kodeSoal;

                    questions.forEach((q, index) => {
                        const questionDocRef = db.collection('examQuestions').doc();
                        
                        const newQuestionData = {
                            tahunAjaran: metadata.tahunAjaran,
                            semester: metadata.semester,
                            mataPelajaran: metadata.mataPelajaran,
                            kelas: metadata.kelas,
                            kode: baseCode, // All generated questions share the same base code
                            tipe: q.tipe,
                            pertanyaan: q.pertanyaan,
                            pilihan: q.pilihan || [],
                            correct: (q.correct !== undefined && q.correct !== null) ? q.correct : null,
                            jawabanBenar: q.jawabanBenar || null,
                            gambar: null,
                            createdBy: AppState.currentUser.nama,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        batch.set(questionDocRef, newQuestionData);
                    });

                    try {
                        await batch.commit();
                        UI.hideGeminiModal();
                        UI.showNotification(`${questions.length} soal berhasil disimpan!`, 'success');
                    } catch(error) {
                        console.error('Error saving generated questions:', error);
                        UI.showNotification('Gagal menyimpan soal!', 'error');
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-save mr-2"></i>Simpan Semua Soal';
                    }
                });
            },

            // =================================================================
            // Result Management (Google Sheet Integration)
            // =================================================================
            viewResult(rowIndex) {
                // Data is fetched from AppState, not a new request
                const result = AppState.currentlyDisplayed.results.find(r => r.rowIndex == rowIndex);
                if (!result) {
                    UI.showNotification('Data hasil tidak ditemukan.', 'error');
                    return;
                }
                const content = `
                    <div class="space-y-3 text-sm">
                        <p><strong>Nama Siswa:</strong> ${result.namaLengkap}</p>
                        <p><strong>Kelas:</strong> ${result.kelas}</p>
                        <p><strong>Kode Soal:</strong> ${result.kodesoal}</p>
                        <hr>
                        <p><strong>No. Soal:</strong> ${result.noSoal}</p>
                        <p><strong>Pertanyaan:</strong> ${result.pertanyaan}</p>
                        <p><strong>Jawaban Siswa:</strong> ${result.jawabanSiswa}</p>
                        <p><strong>Status:</strong> <span class="${result.status === 'benar' ? 'text-green-600' : result.status === 'salah' ? 'text-red-600' : 'text-yellow-600'} font-semibold">${String(result.status).toUpperCase()}</span></p>
                        <p><strong>Nilai Poin:</strong> ${result.nilai}</p>
                    </div>
                    <div class="flex justify-end pt-4 mt-4 border-t">
                        <button onclick="UI.hideModal()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Tutup</button>
                    </div>
                `;
                UI.showModal('Detail Hasil Jawaban', content);
            },

            async editResult(rowIndex) {
                const result = AppState.currentlyDisplayed.results.find(r => r.rowIndex == rowIndex);
                if (!result) return;

                const content = `
                    <form id="editResultForm" class="space-y-4">
                        <input type="hidden" name="rowIndex" value="${result.rowIndex}">
                        <p class="text-sm"><strong>Siswa:</strong> ${result.namaLengkap}</p>
                        <p class="text-sm"><strong>Soal No:</strong> ${result.noSoal}</p>
                        <p class="text-sm"><strong>Pertanyaan:</strong> ${result.pertanyaan}</p>
                        <p class="text-sm"><strong>Jawaban:</strong> ${result.jawabanSiswa}</p>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nilai (0-100)</label>
                            <input type="number" name="nilai" value="${result.nilai}" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan Nilai</button>
                        </div>
                    </form>
                `;
                UI.showModal('Edit Nilai Soal', content);

                document.getElementById('editResultForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newNilai = parseInt(e.target.nilai.value);
                    const newStatus = newNilai > 0 ? 'benar' : 'salah';
                    
                    try {
                        // Google Sheet Integration: Update the result in the sheet
                        const response = await fetch(GOOGLE_SCRIPT_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'updateResult',
                                rowIndex: rowIndex,
                                data: { nilai: newNilai, status: newStatus }
                            })
                        });
                        const res = await response.json();
                        if (res.status !== 'success') throw new Error(res.message);

                        // Firebase Integration: Recalculate final grade (remains the same)
                        await this.recalculateFinalGrade(result.namaLengkap, result.kodesoal);
                        
                        UI.hideModal();
                        UI.showNotification('Nilai berhasil diperbarui!', 'success');
                        document.getElementById('applyResultFilterBtn').click(); // Refresh view
                    } catch (error) {
                        console.error("Error updating result/grade: ", error);
                        UI.showNotification('Gagal memperbarui nilai!', 'error');
                    }
                });
            },
            
            async recalculateFinalGrade(studentName, examCode) {
                 // 1. Get all questions for the exam to know the total count
                const questionsSnapshot = await db.collection('examQuestions').where('kode', '==', examCode).get();
                const totalQuestionsForExam = questionsSnapshot.size;
                if (totalQuestionsForExam === 0) return;

                // 2. Fetch ALL results for that student for that exam from Google Sheets
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getResults&namaLengkap=${encodeURIComponent(studentName)}&kodesoal=${encodeURIComponent(examCode)}`);
                const result = await response.json();
                if (result.status !== 'success') {
                    console.error('Failed to fetch results for recalculation');
                    return;
                }
                const studentResults = result.data;

                // 3. Calculate total score
                let totalScore = 0;
                studentResults.forEach(r => {
                    if (r.status !== 'perlu dinilai') {
                        totalScore += parseInt(r.nilai) || 0;
                    }
                });
                
                const finalScore = Math.round(totalScore / totalQuestionsForExam);
                const grade = finalScore >= 90 ? 'A' : finalScore >= 80 ? 'B' : finalScore >= 70 ? 'C' : finalScore >= 60 ? 'D' : 'E';

                // 4. Find and update the summary grade in Firebase
                const gradeQuery = await db.collection('grades')
                    .where('namaSiswa', '==', studentName)
                    .where('kodeSoal', '==', examCode)
                    .limit(1).get();

                if (!gradeQuery.empty) {
                    const gradeDocId = gradeQuery.docs[0].id;
                    await db.collection('grades').doc(gradeDocId).update({
                        nilai: finalScore,
                        grade: grade,
                        keterangan: finalScore >= 70 ? 'Lulus' : 'Tidak Lulus'
                    });
                }
            },

            deleteResult(rowIndex) {
                UI.showConfirmModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus detail hasil ini dari Google Sheet?', async () => {
                    try {
                        const response = await fetch(GOOGLE_SCRIPT_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'deleteResult', rowIndex: rowIndex })
                        });
                        const res = await response.json();
                        if (res.status !== 'success') throw new Error(res.message);
                        
                        UI.showNotification('Hasil ujian berhasil dihapus!', 'success');
                        document.getElementById('applyResultFilterBtn').click(); // Refresh view
                    } catch (error) {
                        console.error("Error deleting result: ", error);
                        UI.showNotification('Gagal menghapus hasil!', 'error');
                    }
                });
            },

            renderFilteredResults(results) {
                AppState.currentlyDisplayed.results = results; // Store for bulk operations
                const resultsTableBody = document.getElementById('resultsTableBody');
                if (!resultsTableBody) return;
                
                results.sort((a, b) => a.noSoal - b.noSoal);

                resultsTableBody.innerHTML = results.length === 0 ?
                    '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500">Tidak ada hasil ujian yang sesuai dengan filter</td></tr>' :
                    results.map((result, index) => {
                        let actionButtons = '';
                        if (result.status === 'perlu dinilai') {
                            actionButtons = `
                                <button id="grade-btn-${result.rowIndex}" onclick="Management.gradeWithAI('${result.rowIndex}')" class="bg-purple-600 text-white px-3 py-2 rounded-md hover:bg-purple-700 text-xs">
                                    <i class="fas fa-magic mr-1"></i> Nilai AI
                                </button>
                            `;
                        } else {
                            actionButtons = `
                                <button onclick="Management.viewResult('${result.rowIndex}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="Management.editResult('${result.rowIndex}')" class="text-green-600 hover:text-green-900 mr-3">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="Management.deleteResult('${result.rowIndex}')" class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                        }
                        return `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.kelas}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.kodesoal}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.namaLengkap}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.noSoal}</td>
                            <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">${result.pertanyaan}</td>
                            <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">${result.jawabanSiswa}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${result.status === 'benar' ? 'bg-green-100 text-green-800' : result.status === 'salah' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">${result.status}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.nilai}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                ${actionButtons}
                            </td>
                        </tr>
                    `}).join('');
            },
            
            async gradeAllWithAI() {
                const resultsToGrade = AppState.currentlyDisplayed.results.filter(r => r.status === 'perlu dinilai');

                if (resultsToGrade.length === 0) {
                    UI.showNotification('Tidak ada jawaban yang perlu dinilai pada filter ini.', 'info');
                    return;
                }

                UI.showConfirmModal(
                    'Konfirmasi Penilaian AI',
                    `Anda akan menilai <strong>${resultsToGrade.length}</strong> jawaban dengan AI. Proses ini mungkin memakan waktu. Lanjutkan?`,
                    async () => {
                        Swal.fire({
                            title: 'Menilai dengan AI...',
                            html: `Memproses <strong>0</strong> dari <strong>${resultsToGrade.length}</strong> jawaban.`,
                            allowOutsideClick: false,
                            didOpen: () => Swal.showLoading()
                        });

                        const updates = [];
                        const affectedGrades = new Set(); 

                        for (const [index, result] of resultsToGrade.entries()) {
                            try {
                                const gradingResult = await GeminiHelper.gradeAnswer(result.pertanyaan, result.correctAnswer, result.jawabanSiswa);
                                if (gradingResult) {
                                    const newNilai = gradingResult.nilai;
                                    const newStatus = newNilai > 0 ? 'benar' : 'salah';
                                    updates.push({ rowIndex: result.rowIndex, data: { nilai: newNilai, status: newStatus } });
                                    affectedGrades.add(`${result.namaLengkap}__${result.kodesoal}`);
                                }
                            } catch (error) {
                                console.error(`Failed to grade result for row ${result.rowIndex}:`, error);
                            }
                            Swal.update({ html: `Memproses <strong>${index + 1}</strong> dari <strong>${resultsToGrade.length}</strong> jawaban.` });
                        }

                        if (updates.length > 0) {
                             await fetch(GOOGLE_SCRIPT_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ action: 'batchUpdateResults', updates: updates })
                            });
                        }

                        Swal.update({ html: 'Menghitung ulang nilai akhir...' });
                        
                        for (const gradeKey of affectedGrades) {
                            const [namaLengkap, kodesoal] = gradeKey.split('__');
                            await this.recalculateFinalGrade(namaLengkap, kodesoal);
                        }

                        Swal.close();
                        UI.showNotification(`${updates.length} jawaban berhasil dinilai dengan AI.`, 'success');
                        document.getElementById('applyResultFilterBtn').click(); // Refresh the view
                    }
                );
            },

            async gradeWithAI(rowIndex) {
                const button = document.getElementById(`grade-btn-${rowIndex}`);
                if (!button) return;

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menilai...';

                try {
                    const resultData = AppState.currentlyDisplayed.results.find(r => r.rowIndex == rowIndex);
                    if (!resultData) throw new Error("Data hasil ujian tidak ditemukan.");

                    // We need the correct answer. It should be part of the result data from the sheet.
                    if (!resultData.correctAnswer) {
                        // If not, fetch from Firebase as a fallback (less efficient)
                        const questionsSnapshot = await db.collection('examQuestions').where('kode', '==', resultData.kodesoal).get();
                        if (questionsSnapshot.empty) throw new Error("Data soal tidak ditemukan.");
                        
                        let questions = questionsSnapshot.docs.map(doc => doc.data());
                        const typeOrder = { 'pilihan_ganda': 1, 'isian': 2, 'uraian': 3 };
                        questions.sort((a, b) => (typeOrder[a.tipe] || 99) - (typeOrder[b.tipe] || 99));

                        const question = questions[resultData.noSoal - 1];
                        if (!question || !question.jawabanBenar) throw new Error(`Kunci jawaban untuk soal no. ${resultData.noSoal} tidak ditemukan.`);
                        resultData.correctAnswer = question.jawabanBenar;
                    }

                    const gradingResult = await GeminiHelper.gradeAnswer(resultData.pertanyaan, resultData.correctAnswer, resultData.jawabanSiswa);
                    if (!gradingResult) throw new Error("Gagal mendapatkan nilai dari AI.");
                    
                    const newNilai = gradingResult.nilai;
                    const newStatus = newNilai > 0 ? 'benar' : 'salah';

                    // Update result in Google Sheet
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'updateResult',
                            rowIndex: rowIndex,
                            data: { nilai: newNilai, status: newStatus }
                        })
                    });
                    const res = await response.json();
                    if (res.status !== 'success') throw new Error(res.message);

                    await this.recalculateFinalGrade(resultData.namaLengkap, resultData.kodesoal);
                    
                    UI.showNotification(`Penilaian berhasil! Nilai: ${newNilai}. Feedback: ${gradingResult.feedback}`, 'success');
                    
                } catch (error) {
                    console.error("Error during AI grading: ", error);
                    UI.showNotification(error.message, 'error');
                } finally {
                    document.getElementById('applyResultFilterBtn').click();
                }
            },

            // =================================================================
            // Grade Management (Firebase Integration)
            // =================================================================
            async viewGrade(id) {
                const doc = await db.collection('grades').doc(id).get();
                if (!doc.exists) return;
                const grade = { id: doc.id, ...doc.data() };
                const content = `
                    <div class="space-y-3 text-sm">
                        <p><strong>Nama Siswa:</strong> ${grade.namaSiswa}</p>
                        <p><strong>Kelas:</strong> ${grade.kelas}</p>
                        <p><strong>Kode Soal:</strong> ${grade.kodeSoal}</p>
                        <p><strong>Mata Pelajaran:</strong> ${grade.mataPelajaran}</p>
                        <hr>
                        <p><strong>Nilai Akhir:</strong> <span class="text-2xl font-bold text-blue-600">${grade.nilai}</span></p>
                        <p><strong>Grade:</strong> <span class="font-semibold">${grade.grade}</span></p>
                        <p><strong>Keterangan:</strong> <span class="font-semibold">${grade.keterangan}</span></p>
                        <p><strong>Waktu Selesai:</strong> ${grade.waktuSelesai}</p>
                    </div>
                    <div class="flex justify-end pt-4 mt-4 border-t">
                        <button onclick="UI.hideModal()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Tutup</button>
                    </div>
                `;
                UI.showModal('Detail Nilai Siswa', content);
            },

            async editGrade(id) {
                const doc = await db.collection('grades').doc(id).get();
                if (!doc.exists) return;
                const grade = { id: doc.id, ...doc.data() };

                const content = `
                    <form id="editGradeForm" class="space-y-4">
                        <p class="text-sm">Mengedit nilai akhir untuk <strong>${grade.namaSiswa}</strong> pada ujian <strong>${grade.kodeSoal}</strong>.</p>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nilai Akhir (0-100)</label>
                            <input type="number" name="nilai" value="${grade.nilai}" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan Nilai</button>
                        </div>
                    </form>
                `;
                UI.showModal('Edit Nilai Akhir', content);

                document.getElementById('editGradeForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newNilai = parseInt(e.target.nilai.value);
                    const newGrade = newNilai >= 90 ? 'A' : newNilai >= 80 ? 'B' : newNilai >= 70 ? 'C' : newNilai >= 60 ? 'D' : 'E';
                    const newKeterangan = newNilai >= 70 ? 'Lulus' : 'Tidak Lulus';

                    try {
                        // Firebase Integration: Update grade
                        await db.collection('grades').doc(id).update({
                            nilai: newNilai,
                            grade: newGrade,
                            keterangan: newKeterangan
                        });
                        UI.hideModal();
                        UI.showNotification('Nilai akhir berhasil diperbarui!', 'success');
                    } catch (error) {
                        UI.showNotification('Gagal memperbarui nilai!', 'error');
                    }
                });
            },

            deleteGrade(id) {
                UI.showConfirmModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus data nilai ini?', async () => {
                    try {
                        // Firebase Integration: Delete grade
                        await db.collection('grades').doc(id).delete();
                        UI.showNotification('Data nilai berhasil dihapus!', 'success');
                    } catch (error) {
                        UI.showNotification('Gagal menghapus data nilai!', 'error');
                    }
                });
            },

            renderFilteredGrades(grades) {
                AppState.currentlyDisplayed.grades = grades; // Store for bulk delete
                const gradesTableBody = document.getElementById('gradesTableBody');
                if (!gradesTableBody) return;

                // Sort grades by student name
                grades.sort((a, b) => a.namaSiswa.localeCompare(b.namaSiswa));

                gradesTableBody.innerHTML = grades.length === 0 ?
                    '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500">Belum ada data nilai yang sesuai dengan filter</td></tr>' :
                    grades.map((grade, index) => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.kelas}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.namaSiswa}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.kodeSoal}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.mataPelajaran}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.nilai}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${grade.grade === 'A' ? 'bg-green-100 text-green-800' : grade.grade === 'B' ? 'bg-blue-100 text-blue-800' : grade.grade === 'C' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${grade.grade}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.keterangan}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.waktuSelesai}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="Management.viewGrade('${grade.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="Management.editGrade('${grade.id}')" class="text-green-600 hover:text-green-900 mr-3">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="Management.deleteGrade('${grade.id}')" class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
            },
            
            async downloadQuestionsPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.text("Laporan Daftar Soal", 14, 16);
                doc.setFontSize(10);
                doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 14, 22);

                const tableColumn = ["No", "Kode Soal", "Kelas", "Mata Pelajaran", "Tipe", "Pertanyaan"];
                const tableRows = [];

                // Use the already filtered and sorted data from the state
                const filteredQuestions = AppState.currentlyDisplayed.questions;

                filteredQuestions.forEach((question, index) => {
                    let questionText = question.pertanyaan;
                    if (question.tipe === 'pilihan_ganda' && question.pilihan) {
                        const options = question.pilihan.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n');
                        questionText += '\n' + options;
                    }

                    const questionData = [
                        index + 1,
                        question.kode,
                        question.kelas,
                        question.mataPelajaran,
                        question.tipe,
                        doc.splitTextToSize(questionText, 100)
                    ];
                    tableRows.push(questionData);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 28,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [59, 130, 246] }
                });

                doc.save(`daftar-soal-${new Date().toISOString().slice(0,10)}.pdf`);
                UI.showNotification('PDF berhasil diunduh!', 'success');
            },

            async downloadResultsPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text("Laporan Hasil Ujian", 14, 16);
                doc.setFontSize(10);
                doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 14, 22);

                const tableColumn = ["No", "Kelas", "Kode Soal", "Nama Siswa", "No. Soal", "Status", "Nilai"];
                const tableRows = [];

                const filteredResults = AppState.currentlyDisplayed.results;
                
                filteredResults.forEach((result, index) => {
                    tableRows.push([
                        index + 1, result.kelas, result.kodesoal, result.namaLengkap,
                        result.noSoal, result.status, result.nilai
                    ]);
                });

                doc.autoTable({ head: [tableColumn], body: tableRows, startY: 28 });
                doc.save(`hasil-ujian-${new Date().toISOString().slice(0,10)}.pdf`);
                UI.showNotification('PDF berhasil diunduh!', 'success');
            },

            async downloadGradesPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text("Laporan Daftar Nilai", 14, 16);
                doc.setFontSize(10);
                doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 14, 22);

                const tableColumn = ["No", "Kelas", "Nama Siswa", "Kode Soal", "Mata Pelajaran", "Nilai", "Grade", "Keterangan"];
                const tableRows = [];

                const filteredGrades = AppState.currentlyDisplayed.grades;

                filteredGrades.forEach((grade, index) => {
                    tableRows.push([
                        index + 1, grade.kelas, grade.namaSiswa, grade.kodeSoal,
                        grade.mataPelajaran, grade.nilai, grade.grade, grade.keterangan
                    ]);
                });

                doc.autoTable({ head: [tableColumn], body: tableRows, startY: 28 });
                doc.save(`daftar-nilai-${new Date().toISOString().slice(0,10)}.pdf`);
                UI.showNotification('PDF berhasil diunduh!', 'success');
            },

            deleteFilteredQuestions() {
                const allFilteredQuestions = AppState.currentlyDisplayed.questions;
                let questionsToDelete;

                if (AppState.currentUser.role === 'admin') {
                    // Admin can delete all filtered questions
                    questionsToDelete = allFilteredQuestions;
                } else if (AppState.currentUser.role === 'guru') {
                    // Teacher can only delete their own questions or orphaned ones (created before owner tracking)
                    questionsToDelete = allFilteredQuestions.filter(question => 
                        (question.createdBy && question.createdBy === AppState.currentUser.nama) || !question.createdBy
                    );
                } else {
                    // Other roles cannot delete in bulk
                    questionsToDelete = [];
                }
                
                if (questionsToDelete.length === 0) {
                    UI.showNotification('Tidak ada soal milik Anda untuk dihapus pada filter ini.', 'info');
                    return;
                }

                UI.showConfirmModal(
                    'Konfirmasi Hapus Massal', 
                    `Anda akan menghapus **${questionsToDelete.length}** soal milik Anda secara permanen. Aksi ini tidak dapat dibatalkan. Lanjutkan?`, 
                    async () => {
                        const batch = db.batch();
                        questionsToDelete.forEach(question => {
                            batch.delete(db.collection('examQuestions').doc(question.id));
                        });
                        try {
                            await batch.commit();
                            UI.showNotification('Soal yang Anda pilih berhasil dihapus!', 'success');
                        } catch (error) {
                            UI.showNotification('Gagal menghapus soal!', 'error');
                            console.error("Error deleting filtered questions: ", error);
                        }
                    }
                );
            },

            deleteFilteredResults() {
                const resultsToDelete = AppState.currentlyDisplayed.results;
                if (resultsToDelete.length === 0) {
                    UI.showNotification('Tidak ada hasil ujian untuk dihapus sesuai filter.', 'info');
                    return;
                }
                UI.showConfirmModal(
                    'Konfirmasi Hapus Massal', 
                    `Anda akan menghapus **${resultsToDelete.length}** data hasil ujian secara permanen dari Google Sheet. Aksi ini tidak dapat dibatalkan. Lanjutkan?`, 
                    async () => {
                        const rowIndexes = resultsToDelete.map(r => r.rowIndex);
                        try {
                             const response = await fetch(GOOGLE_SCRIPT_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ action: 'batchDeleteResults', rowIndexes: rowIndexes })
                            });
                            const res = await response.json();
                            if (res.status !== 'success') throw new Error(res.message);

                            UI.showNotification('Hasil ujian yang difilter berhasil dihapus!', 'success');
                            document.getElementById('applyResultFilterBtn').click();
                        } catch (error) {
                            UI.showNotification('Gagal menghapus hasil ujian!', 'error');
                            console.error("Error deleting filtered results: ", error);
                        }
                    }
                );
            },

            deleteFilteredGrades() {
                const gradesToDelete = AppState.currentlyDisplayed.grades;
                if (gradesToDelete.length === 0) {
                    UI.showNotification('Tidak ada daftar nilai untuk dihapus sesuai filter.', 'info');
                    return;
                }
                UI.showConfirmModal(
                    'Konfirmasi Hapus Massal', 
                    `Anda akan menghapus **${gradesToDelete.length}** data nilai secara permanen. Aksi ini tidak dapat dibatalkan. Lanjutkan?`, 
                    async () => {
                        const batch = db.batch();
                        gradesToDelete.forEach(grade => {
                            batch.delete(db.collection('grades').doc(grade.id));
                        });
                        try {
                            await batch.commit();
                            UI.showNotification('Daftar nilai yang difilter berhasil dihapus!', 'success');
                        } catch (error) {
                            UI.showNotification('Gagal menghapus daftar nilai!', 'error');
                            console.error("Error deleting filtered grades: ", error);
                        }
                    }
                );
            }
        };

        // =================================================================
        // GEMINI API HELPER
        // =================================================================
        const GeminiHelper = {
            async generateQuestions(promptData) {
                const apiKey = process.env.API_KEY; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const systemPrompt = `Anda adalah asisten pembuatan soal untuk guru SD. Buat soal berdasarkan topik, mata pelajaran, dan kelas yang diberikan. Pastikan jawaban pilihan ganda bervariasi dan pengecohnya masuk akal. Jangan membuat soal yang terlalu sulit untuk level SD. Selalu berikan respon dalam format JSON yang valid sesuai skema yang diminta, dan sertakan tipe soal ('pilihan_ganda', 'isian', 'uraian') untuk setiap soal.`;
                
                const jumlahPg = parseInt(promptData.jumlah_pg) || 0;
                const jumlahIsian = parseInt(promptData.jumlah_isian) || 0;
                const jumlahUraian = parseInt(promptData.jumlah_uraian) || 0;

                let requestedTypes = [];
                if (jumlahPg > 0) requestedTypes.push(`${jumlahPg} soal Pilihan Ganda`);
                if (jumlahIsian > 0) requestedTypes.push(`${jumlahIsian} soal Isian Singkat`);
                if (jumlahUraian > 0) requestedTypes.push(`${jumlahUraian} soal Uraian`);

                const userQuery = `
                    Topik: "${promptData.topik}"
                    Mata Pelajaran: "${promptData.mataPelajaran}"
                    Kelas: "${promptData.kelas}"
                    
                    Buatkan soal-soal berikut: ${requestedTypes.join(', ')}.

                    Untuk Pilihan Ganda, berikan 4 pilihan dan tandai jawaban yang benar (correct) dengan indeks mulai dari 0.
                    Untuk soal tipe 'isian' dan 'uraian', sertakan properti "jawabanBenar" dengan kunci jawaban yang benar dan akurat. Jangan sertakan properti "pilihan" dan "correct" untuk tipe ini.
                    Untuk setiap soal, sertakan properti "tipe" dengan nilai 'pilihan_ganda', 'isian', atau 'uraian'.
                `;

                const payload = {
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                    contents: [{
                        parts: [{ text: userQuery }]
                    }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    tipe: { type: "STRING" },
                                    pertanyaan: { type: "STRING" },
                                    pilihan: { 
                                        type: "ARRAY",
                                        items: { type: "STRING" }
                                    },
                                    correct: { type: "NUMBER" },
                                    jawabanBenar: { type: "STRING" }
                                },
                                required: ["tipe", "pertanyaan"]
                            }
                        }
                    }
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error('Gemini API Error:', errorBody);
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const jsonText = candidate.content.parts[0].text;
                        return JSON.parse(jsonText);
                    } else {
                        throw new Error("Invalid response structure from Gemini API.");
                    }
                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    return null;
                }
            },
            
            async gradeAnswer(questionText, correctAnswer, studentAnswer) {
                const apiKey = process.env.API_KEY;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const systemPrompt = "Anda adalah seorang guru ahli yang memeriksa jawaban ujian. Tugas Anda adalah menilai jawaban siswa berdasarkan pertanyaan dan kunci jawaban yang diberikan. Berikan respons HANYA dalam format JSON yang valid.";

                const userQuery = `
                    Tolong nilai jawaban siswa berikut.
                    Pertanyaan: "${questionText}"
                    Kunci Jawaban: "${correctAnswer}"
                    Jawaban Siswa: "${studentAnswer}"

                    Berdasarkan perbandingan, berikan nilai antara 0 dan 100 untuk jawaban siswa. 0 berarti salah total, dan 100 berarti benar sepenuhnya. Anda dapat memberikan nilai di antara rentang tersebut (misalnya 0, 10, 15, 20, 25, 30, dan seterusnya hingga 100) tergantung pada tingkat keakuratan dan kelengkapan jawaban siswa.

                    Berikan juga feedback singkat dan jelas mengenai kenapa nilai tersebut diberikan.
                `;
                
                const payload = {
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                    contents: [{
                        parts: [{ text: userQuery }]
                    }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                nilai: { type: "NUMBER" },
                                feedback: { type: "STRING" }
                            },
                            required: ["nilai", "feedback"]
                        }
                    }
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error('Gemini API Grading Error:', errorBody);
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const jsonText = candidate.content.parts[0].text;
                        const parsedResult = JSON.parse(jsonText);
                        // Ensure score is between 0 and 100
                        if (typeof parsedResult.nilai !== 'number' || parsedResult.nilai < 0 || parsedResult.nilai > 100) {
                            console.warn("AI returned an invalid score, defaulting to 0.", parsedResult.nilai);
                            parsedResult.nilai = 0; // Default to 0 if invalid value
                        } else {
                            parsedResult.nilai = Math.round(parsedResult.nilai);
                        }
                        return parsedResult;
                    } else {
                        throw new Error("Invalid response structure from Gemini API for grading.");
                    }
                } catch (error) {
                    console.error('Error calling Gemini API for grading:', error);
                    return null;
                }
            }
        };


        // =================================================================
        // AUTHENTICATION SYSTEM
        // =================================================================
        const Auth = {
            login(username, password) {
                const user = AppState.users.find(u => u.username === username && u.password === password);
                if (user) {
                    AppState.currentUser = user;
                    localStorage.setItem('cbtCurrentUser', JSON.stringify(user));
                    return { success: true, user: user };
                }
                return { success: false, message: 'Username atau password salah!' };
            },

            logout() {
                AppState.currentUser = null;
                localStorage.removeItem('cbtCurrentUser');
                this.clearExamTimer();
                UI.showLogin();
            },

            clearExamTimer() {
                if (AppState.examTimer) {
                    clearInterval(AppState.examTimer);
                    AppState.examTimer = null;
                }
            },
            
            checkSession() {
                const persistedUser = localStorage.getItem('cbtCurrentUser');
                if (persistedUser) {
                    const parsedUser = JSON.parse(persistedUser);
                    const userExists = AppState.users.some(u => u.username === parsedUser.username);

                    if (userExists) {
                        AppState.currentUser = parsedUser;
                        UI.showDashboard();
                    } else {
                        this.logout();
                    }

                } else {
                    UI.showLogin();
                }
            }
        };

        // =================================================================
        // UI MANAGEMENT
        // =================================================================
        const UI = {
            toBase64: file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            }),
            showModal(title, content) {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalContent').innerHTML = content;
                document.getElementById('managementModal').classList.remove('hidden');
            },

            hideModal() {
                document.getElementById('managementModal').classList.add('hidden');
            },

            showGeminiModal(title, content) {
                document.getElementById('geminiModalTitle').innerHTML = title;
                document.getElementById('geminiModalContent').innerHTML = content;
                document.getElementById('geminiModal').classList.remove('hidden');
            },

            hideGeminiModal() {
                document.getElementById('geminiModal').classList.add('hidden');
            },

            showConfirmModal(title, message, onConfirm) {
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').innerHTML = message.replace(/\n/g, '<br>');
                document.getElementById('confirmModal').classList.remove('hidden');
                
                const confirmBtn = document.getElementById('confirmOkBtn');
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                newConfirmBtn.addEventListener('click', () => {
                    document.getElementById('confirmModal').classList.add('hidden');
                    onConfirm();
                }, { once: true });
            },

            showQuestionListModal() {
                document.getElementById('questionListModal').classList.remove('hidden');
            },

            hideQuestionListModal() {
                document.getElementById('questionListModal').classList.add('hidden');
            },

            showLogin() {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('dashboardInterface').classList.add('hidden');
                document.getElementById('examInterface').classList.add('hidden');
                document.getElementById('loginError').classList.add('hidden');
                AppState.currentView = 'login';
            },

            showDashboard() {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboardInterface').classList.remove('hidden');
                document.getElementById('examInterface').classList.add('hidden');
                
                const sidebar = document.getElementById('dashboardSidebar');
                const header = document.getElementById('dashboardHeader');

                sidebar.classList.add('hidden');
                header.classList.remove('hidden');
                this.setupDashboardHeader();
                
                let defaultView = 'dashboard';
                if (AppState.currentUser.role === 'guru') {
                    defaultView = 'questions';
                }
                
                this.setActiveNav(defaultView);
                this.showDashboardView(defaultView);
            },

            async showExamInterface() {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboardInterface').classList.add('hidden');
                document.getElementById('examInterface').classList.remove('hidden');
                this.updateUserInfo();
                
                const success = await this.initializeExam(AppState.selectedExamCode);
                if (!success) {
                    this.showDashboard();
                    return;
                }
                
                AppState.currentView = 'exam';
            },

            updateDashboardUserInfo() {
                if (AppState.currentUser) {
                    document.getElementById('dashboardUserInfo').textContent = AppState.currentUser.nama;
                    document.getElementById('dashboardUserRole').textContent = AppState.currentUser.role.toUpperCase();
                }
            },

            updateUserInfo() {
                const userInfoEl = document.getElementById('examUserInfo');
                if (AppState.currentUser && userInfoEl) {
                    userInfoEl.textContent = AppState.currentUser.nama;
                }
            },

            setupDashboardHeader() {
                const header = document.getElementById('dashboardHeader');
                let navItems = [];

                if (AppState.currentUser.role === 'admin') {
                    navItems = [
                        { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-tachometer-alt' },
                        { id: 'users', label: 'Pengguna', icon: 'fas fa-users' },
                        { id: 'classes', label: 'Kelas', icon: 'fas fa-school' },
                        { id: 'subjects', label: 'Mapel', icon: 'fas fa-book' }
                    ];
                } else if (AppState.currentUser.role === 'guru') {
                    navItems = [
                        { id: 'questions', label: 'Manajemen Soal', icon: 'fas fa-question-circle' },
                        { id: 'results', label: 'Hasil Ujian', icon: 'fas fa-chart-bar' },
                        { id: 'grades', label: 'Daftar Nilai', icon: 'fas fa-list-alt' }
                    ];
                } else if (AppState.currentUser.role === 'siswa') {
                    navItems = [
                        { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-tachometer-alt' },
                        { id: 'student-results', label: 'Hasil Ujian', icon: 'fas fa-chart-bar' },
                        { id: 'student-grades', label: 'Daftar Nilai', icon: 'fas fa-list-alt' }
                    ];
                }

                header.innerHTML = `
                    <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div class="flex flex-col sm:flex-row items-center gap-4">
                            <h2 class="text-xl font-bold text-gray-800">SD IT NURUL KAUTSAR</h2>
                            <nav id="headerNav" class="flex items-center space-x-1 sm:border-l sm:pl-4">
                                ${navItems.map(item => `
                                    <button class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100 nav-item" data-view="${item.id}">
                                        <i class="${item.icon} mr-1 sm:mr-2"></i><span class="hidden sm:inline">${item.label}</span>
                                    </button>
                                `).join('')}
                            </nav>
                        </div>
                        <div class="flex items-center">
                            <div class="text-right mr-4">
                                 <p class="font-semibold text-gray-800">${AppState.currentUser.nama}</p>
                                 <p class="text-sm text-gray-500">${AppState.currentUser.role.toUpperCase()}</p>
                            </div>
                            <button id="headerLogoutBtn" class="bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-700 transition duration-200" title="Logout">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                `;

                header.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const view = e.currentTarget.dataset.view;
                        this.setActiveNav(view);
                        this.showDashboardView(view);
                    });
                });
                document.getElementById('headerLogoutBtn').addEventListener('click', () => UI.showConfirmModal('Konfirmasi Keluar', 'Apakah Anda yakin ingin keluar?', () => Auth.logout()));
            },

            setupDashboardNavigation() {
                const nav = document.getElementById('dashboardNav');
                let navItems = [];

                if (AppState.currentUser.role === 'admin') {
                    navItems = [
                        { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-tachometer-alt' },
                        { id: 'users', label: 'Manajemen Pengguna', icon: 'fas fa-users' },
                        { id: 'classes', label: 'Manajemen Kelas', icon: 'fas fa-school' },
                        { id: 'subjects', label: 'Manajemen Mata Pelajaran', icon: 'fas fa-book' }
                    ];
                } else if (AppState.currentUser.role === 'guru') {
                    navItems = [
                        { id: 'questions', label: 'Manajemen Soal', icon: 'fas fa-question-circle' },
                        { id: 'results', label: 'Hasil Ujian', icon: 'fas fa-chart-bar' },
                        { id: 'grades', label: 'Daftar Nilai', icon: 'fas fa-list-alt' }
                    ];
                } else if (AppState.currentUser.role === 'siswa') {
                    navItems = [
                        { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-tachometer-alt' },
                        { id: 'student-results', label: 'Hasil Ujian', icon: 'fas fa-chart-bar' },
                        { id: 'student-grades', label: 'Daftar Nilai', icon: 'fas fa-list-alt' }
                    ];
                }

                nav.innerHTML = navItems.map(item => `
                    <button class="flex items-center px-3 py-4 text-sm font-medium hover:bg-blue-800 transition duration-200 nav-item" data-view="${item.id}">
                        <i class="${item.icon} mr-2"></i>
                        ${item.label}
                    </button>
                `).join('');

                nav.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const view = e.currentTarget.dataset.view;
                        this.setActiveNav(view);
                        this.showDashboardView(view);
                    });
                });
            },

            setActiveNav(activeView) {
                // Reset and set for sidebar items
                document.querySelectorAll('#dashboardNav .nav-item').forEach(item => {
                    item.classList.toggle('bg-blue-800', item.dataset.view === activeView);
                });
                // Reset and set for header items
                document.querySelectorAll('#headerNav .nav-item').forEach(item => {
                    item.classList.toggle('bg-blue-100', item.dataset.view === activeView);
                    item.classList.toggle('text-blue-600', item.dataset.view === activeView);
                    item.classList.toggle('font-semibold', item.dataset.view === activeView);
                });
            },

            showDashboardView(view) {
                switch (view) {
                    case 'dashboard': this.showDashboardHome(); break;
                    case 'users': this.showUserManagement(); break;
                    case 'classes': this.showClassManagement(); break;
                    case 'subjects': this.showSubjectManagement(); break;
                    case 'questions': this.showQuestionManagement(); break;
                    case 'results': this.showResultManagement(); break;
                    case 'grades': this.showGradeManagement(); break;
                    case 'exam': this.showExamInterface(); break;
                    case 'student-results': this.showStudentResults(); break;
                    case 'student-grades': this.showStudentGrades(); break;
                    default: this.showDashboardHome();
                }
            },

            showDashboardHome() {
                const content = document.getElementById('dashboardContent');
                const user = AppState.currentUser;
                
                let dashboardContent = `<div class="fade-in"><h2 class="text-3xl font-bold text-gray-900 mb-8">Selamat Datang, ${user.nama}</h2>`;

                if (user.role === 'admin') {
                    dashboardContent += `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white rounded-lg shadow p-6"><div class="flex items-center"><div class="bg-blue-100 rounded-full p-3"><i class="fas fa-users text-blue-600 text-xl"></i></div><div class="ml-4"><p class="text-sm font-medium text-gray-600">Total Pengguna</p><p class="text-2xl font-bold text-gray-900">${AppState.users.length}</p></div></div></div>
                            <div class="bg-white rounded-lg shadow p-6"><div class="flex items-center"><div class="bg-green-100 rounded-full p-3"><i class="fas fa-school text-green-600 text-xl"></i></div><div class="ml-4"><p class="text-sm font-medium text-gray-600">Total Kelas</p><p class="text-2xl font-bold text-gray-900">${AppState.classes.length}</p></div></div></div>
                            <div class="bg-white rounded-lg shadow p-6"><div class="flex items-center"><div class="bg-yellow-100 rounded-full p-3"><i class="fas fa-book text-yellow-600 text-xl"></i></div><div class="ml-4"><p class="text-sm font-medium text-gray-600">Mata Pelajaran</p><p class="text-2xl font-bold text-gray-900">${AppState.subjects.length}</p></div></div></div>
                        </div>`;
                } else if (user.role === 'guru') {
                    // This view is no longer used for teachers, they go straight to questions
                } else if (user.role === 'siswa') {
                    dashboardContent += `
                        <div class="bg-white rounded-lg shadow p-8">
                            <div class="text-center mb-8"><i class="fas fa-clipboard-list text-6xl text-blue-600 mb-4"></i><h3 class="text-xl font-semibold mb-4">Mulai Ujian</h3><p class="text-gray-600 mb-6">Masukkan kode soal untuk memulai ujian</p></div>
                            <form id="examCodeForm" class="max-w-md mx-auto">
                                <div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2">Kode Soal</label><input type="text" id="examCode" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-lg font-mono" placeholder="Contoh: PAI001"></div>
                                <div id="examCodeError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm mb-4"></div>
                                <button type="submit" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-semibold"><i class="fas fa-play mr-2"></i>Mulai Ujian</button>
                            </form>
                        </div>`;
                }
                dashboardContent += `</div>`;
                content.innerHTML = dashboardContent;
                
                if (user.role === 'siswa') {
                    document.getElementById('examCodeForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const examCode = document.getElementById('examCode').value.trim();
                        const errorDiv = document.getElementById('examCodeError');
                        const studentUsername = AppState.currentUser.username;
                        
                        if (!examCode) {
                            errorDiv.textContent = 'Silakan masukkan kode soal!';
                            errorDiv.classList.remove('hidden');
                            return;
                        }

                        // Security Check: Is student blocked?
                        if (ExamSecurity.isBlocked(studentUsername, examCode)) {
                            const remainingTime = ExamSecurity.getBlockTimeRemaining(studentUsername, examCode);
                            errorDiv.innerHTML = `Akses Anda ke soal ini diblokir karena telah mencoba 3 kali.<br>Coba lagi dalam: <strong>${remainingTime}</strong>`;
                            errorDiv.classList.remove('hidden');
                            return;
                        }
                        
                        // Firebase Integration: Check if exam code exists
                        const examQuery = await db.collection('examQuestions').where('kode', '==', examCode).limit(1).get();
                        if (examQuery.empty) {
                            errorDiv.textContent = 'Kode soal tidak ditemukan!';
                            errorDiv.classList.remove('hidden');
                            return;
                        }

                        // New: Check if student's grade level matches exam's grade level
                        const examData = examQuery.docs[0].data();
                        const studentGrade = AppState.currentUser.kelas.charAt(0);
                        const examGrade = examData.kelas.charAt(0);

                        if (studentGrade !== examGrade) {
                            errorDiv.textContent = 'Anda tidak diizinkan mengerjakan soal untuk kelas ini.';
                            errorDiv.classList.remove('hidden');
                            return;
                        }

                        // Security Check: Increment attempts and check if it reaches the limit
                        const attempts = ExamSecurity.incrementAttempts(studentUsername, examCode);
                        if (attempts >= 4) {
                            ExamSecurity.block(studentUsername, examCode);
                            errorDiv.innerHTML = `Anda telah mencoba 4 kali. Akses ke soal ini diblokir selama 1 jam.`;
                            errorDiv.classList.remove('hidden');
                            return;
                        }
                        
                        errorDiv.classList.add('hidden');
                        AppState.selectedExamCode = examCode;
                        UI.showExamInterface();
                    });
                }
            },

            showUserManagement() {
                const content = document.getElementById('dashboardContent');
                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-900">Manajemen Pengguna</h2><button onclick="Management.showAddUserModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200"><i class="fas fa-plus mr-2"></i>Tambah Pengguna</button></div>
                        
                        <!-- Filter Section -->
                        <div class="bg-white rounded-lg shadow p-6 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama / Username</label>
                                    <input type="text" id="filterUserName" placeholder="Cari..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                    <select id="filterUserRole" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua Role</option>
                                        <option value="admin">Admin</option>
                                        <option value="guru">Guru</option>
                                        <option value="siswa">Siswa</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                    <select id="filterUserClass" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua Kelas</option>
                                        ${AppState.classes.map(c => `<option value="${c.nama}">${c.nama}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button id="applyUserFilterBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-search mr-2"></i>Filter</button>
                                </div>
                                <div class="flex items-end">
                                    <button id="resetUserFilterBtn" class="w-full bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700"><i class="fas fa-sync mr-2"></i>Reset</button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="overflow-x-auto">
                                <table id="userManagementTable" class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Password</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <!-- User data will be rendered here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;

                document.getElementById('applyUserFilterBtn').addEventListener('click', () => this.renderUserTable());
                document.getElementById('resetUserFilterBtn').addEventListener('click', () => {
                    document.getElementById('filterUserName').value = '';
                    document.getElementById('filterUserRole').value = '';
                    document.getElementById('filterUserClass').value = '';
                    this.renderUserTable();
                });

                this.renderUserTable();
            },

            renderUserTable() {
                const nameFilter = document.getElementById('filterUserName').value.toLowerCase();
                const roleFilter = document.getElementById('filterUserRole').value;
                const classFilter = document.getElementById('filterUserClass').value;

                const filteredUsers = AppState.users.filter(user => {
                    const nameMatch = user.nama.toLowerCase().includes(nameFilter) || user.username.toLowerCase().includes(nameFilter);
                    const roleMatch = !roleFilter || user.role === roleFilter;
                    const classMatch = !classFilter || user.kelas === classFilter;
                    return nameMatch && roleMatch && classMatch;
                });

                const tableBody = document.querySelector('#userManagementTable tbody');
                tableBody.innerHTML = filteredUsers.map((user, index) => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.kelas || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.role === 'admin' ? 'bg-red-100 text-red-800' : user.role === 'guru' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${user.role.toUpperCase()}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="Management.viewUser('${user.id}')" class="text-blue-600 hover:text-blue-900 mr-3"><i class="fas fa-eye"></i></button>
                            <button onclick="Management.editUser('${user.id}')" class="text-green-600 hover:text-green-900 mr-3"><i class="fas fa-edit"></i></button>
                            <button onclick="Management.deleteUser('${user.id}')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`).join('');
            },

            showClassManagement() {
                const content = document.getElementById('dashboardContent');
                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-900">Manajemen Kelas</h2><button onclick="Management.showAddClassModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200"><i class="fas fa-plus mr-2"></i>Tambah Kelas</button></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${AppState.classes.map(cls => `
                            <div class="bg-white rounded-lg shadow hover:shadow-md transition duration-200"><div class="p-6"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold text-gray-900">${cls.nama}</h3></div><p class="text-gray-600 text-sm mb-4">${cls.deskripsi}</p><div class="flex space-x-2"><button onclick="Management.editClass('${cls.id}')" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700"><i class="fas fa-edit mr-1"></i>Edit</button><button onclick="Management.deleteClass('${cls.id}')" class="bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-700"><i class="fas fa-trash"></i></button></div></div></div>`).join('')}
                        </div></div>`;
            },

            showSubjectManagement() {
                const content = document.getElementById('dashboardContent');
                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-900">Manajemen Mata Pelajaran</h2><button onclick="Management.showAddSubjectModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200"><i class="fas fa-plus mr-2"></i>Tambah Mata Pelajaran</button></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${AppState.subjects.map(subject => `
                            <div class="bg-white rounded-lg shadow hover:shadow-md transition duration-200"><div class="p-6"><div class="flex items-center mb-4"><div class="bg-blue-100 rounded-full w-12 h-12 flex items-center justify-center"><i class="fas fa-book text-blue-600"></i></div><div class="ml-4"><h3 class="text-lg font-semibold text-gray-900">${subject.nama}</h3></div></div><p class="text-gray-600 text-sm mb-4">${subject.deskripsi}</p><div class="flex space-x-2"><button onclick="Management.editSubject('${subject.id}')" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700"><i class="fas fa-edit mr-1"></i>Edit</button><button onclick="Management.deleteSubject('${subject.id}')" class="bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-700"><i class="fas fa-trash"></i></button></div></div></div>`).join('')}
                        </div></div>`;
            },

            showQuestionManagement() {
                const content = document.getElementById('dashboardContent');
                const isTeacher = AppState.currentUser.role === 'guru';
                let classOptions = '';
                if (isTeacher) {
                    const teacherGrade = AppState.currentUser.kelas.charAt(0);
                    const availableClasses = AppState.classes.filter(c => c.nama.startsWith(teacherGrade));
                    classOptions = availableClasses.map(c => `<option value="${c.nama}">${c.nama}</option>`).join('');
                } else {
                    classOptions = AppState.classes.map(c => `<option value="${c.nama}">${c.nama}</option>`).join('');
                }

                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold text-gray-900">Manajemen Soal</h2>
                            <div class="flex flex-wrap items-center justify-start sm:justify-end gap-2 w-full sm:w-auto">
                                <button onclick="Management.showAutoGenerateModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-200"><i class="fas fa-magic mr-2"></i>Buat Otomatis</button>
                                <button onclick="Management.deleteFilteredQuestions()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200"><i class="fas fa-trash-alt mr-2"></i>Hapus</button>
                                <button onclick="Management.downloadQuestionsPDF()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200"><i class="fas fa-download mr-2"></i>Download</button>
                                <button onclick="Management.showAddQuestionModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200"><i class="fas fa-plus mr-2"></i>Tambah</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 mb-6"><div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran</label><select id="filterTahunAjaran" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua</option>${UI.getYearOptions()}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Semester</label><select id="filterSemester" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua</option>${UI.getSemesterOptions()}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label><select id="filterKelas" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua Kelas</option>${classOptions}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label><select id="filterSubject" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua Mata Pelajaran</option>${AppState.subjects.map(s => `<option value="${s.nama}">${s.nama}</option>`).join('')}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Kode Soal</label><input type="text" id="filterCode" placeholder="Masukkan kode soal" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                            <div class="flex items-end"><button id="applyFilterBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-search mr-2"></i>Filter</button></div>
                        </div></div>
                        <div id="questionsList" class="space-y-4"><div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i><p class="mt-2 text-gray-600">Memuat soal...</p></div></div></div>`;
                
                // Firebase Integration: Real-time listener for questions
                document.getElementById('applyFilterBtn').addEventListener('click', () => {
                    const tahunAjaran = document.getElementById('filterTahunAjaran').value;
                    const semester = document.getElementById('filterSemester').value;
                    const kelas = document.getElementById('filterKelas').value;
                    const mataPelajaran = document.getElementById('filterSubject').value;
                    const kode = document.getElementById('filterCode').value;

                    let query = db.collection('examQuestions');
                    
                    query.onSnapshot(snapshot => {
                        if (!AppState.currentUser) return; // FIX: Guard against null user
                        let questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                        if (AppState.currentUser.role === 'guru' && AppState.currentUser.kelas) {
                            const teacherGrade = AppState.currentUser.kelas.charAt(0);
                            questions = questions.filter(q => q.kelas && q.kelas.startsWith(teacherGrade));
                        }
                        
                        if (tahunAjaran) {
                            questions = questions.filter(q => q.tahunAjaran === tahunAjaran);
                        }
                        if (semester) {
                            questions = questions.filter(q => q.semester === semester);
                        }
                        if (kelas) {
                            questions = questions.filter(q => q.kelas === kelas);
                        }
                        if (mataPelajaran) {
                            questions = questions.filter(q => q.mataPelajaran === mataPelajaran);
                        }
                        if (kode) {
                            questions = questions.filter(q => q.kode && q.kode.toLowerCase().includes(kode.toLowerCase()));
                        }
                        Management.renderFilteredQuestions(questions);
                    }, error => console.error(error));
                });
                // Initial load
                document.getElementById('applyFilterBtn').click();
            },

            showResultManagement() {
                const content = document.getElementById('dashboardContent');
                const isTeacher = AppState.currentUser.role === 'guru';
                
                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold text-gray-900">Hasil Ujian</h2>
                            <div class="flex flex-wrap items-center justify-start sm:justify-end gap-2 w-full sm:w-auto">
                                <button onclick="Management.gradeAllWithAI()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-200"><i class="fas fa-magic mr-2"></i>Nilai AI</button>
                                <button onclick="Management.deleteFilteredResults()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200"><i class="fas fa-trash-alt mr-2"></i>Hapus</button>
                                <button onclick="Management.downloadResultsPDF()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200"><i class="fas fa-download mr-2"></i>Download PDF</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 mb-6"><div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran</label><select id="filterResultTahunAjaran" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua</option>${UI.getYearOptions()}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Semester</label><select id="filterResultSemester" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua</option>${UI.getSemesterOptions()}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Kode Soal</label><input type="text" id="filterResultCode" placeholder="Kode soal" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label><select id="filterResultSubject" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua</option>${AppState.subjects.map(s => `<option value="${s.nama}">${s.nama}</option>`).join('')}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label><select id="filterResultClass" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" ${isTeacher ? 'disabled' : ''}><option value="">Semua</option>${AppState.classes.map(c => `<option value="${c.nama}">${c.nama}</option>`).join('')}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Siswa</label><select id="filterResultStudent" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua Siswa</option></select></div>
                            <div class="flex items-end col-span-full md:col-span-1"><button id="applyResultFilterBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-search mr-2"></i>Filter</button></div>
                        </div></div>
                        <div class="bg-white rounded-lg shadow overflow-hidden"><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode Soal</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Lengkap</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. Soal</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pertanyaan</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jawaban Siswa</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th></tr></thead><tbody id="resultsTableBody" class="bg-white divide-y divide-gray-200"></tbody></table></div></div></div>`;
                
                if (isTeacher) document.getElementById('filterResultClass').value = AppState.currentUser.kelas;
                
                UI.populateStudentFilter('filterResultClass', 'filterResultStudent');

                document.getElementById('applyResultFilterBtn').addEventListener('click', async () => {
                    const tableBody = document.getElementById('resultsTableBody');
                    tableBody.innerHTML = '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat data hasil ujian...</td></tr>';

                    try {
                        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getResults`);
                        const result = await response.json();

                        if (result.status !== 'success') {
                            throw new Error(result.message || 'Gagal memuat data dari Google Sheet.');
                        }
                        
                        let allResults = result.data;
                        const tahunAjaran = document.getElementById('filterResultTahunAjaran').value;
                        const semester = document.getElementById('filterResultSemester').value;
                        const kodesoal = document.getElementById('filterResultCode').value;
                        const mataPelajaran = document.getElementById('filterResultSubject').value;
                        const kelas = document.getElementById('filterResultClass').value;
                        const namaLengkap = document.getElementById('filterResultStudent').value;

                        // Client-side filtering
                        if (tahunAjaran) allResults = allResults.filter(r => r.tahunAjaran === tahunAjaran);
                        if (semester) allResults = allResults.filter(r => r.semester === semester);
                        if (kelas) allResults = allResults.filter(r => r.kelas === kelas);
                        if (mataPelajaran) allResults = allResults.filter(r => r.mataPelajaran === mataPelajaran);
                        if (namaLengkap) allResults = allResults.filter(r => r.namaLengkap === namaLengkap);
                        if (kodesoal) allResults = allResults.filter(r => r.kodesoal.toLowerCase().includes(kodesoal.toLowerCase()));

                        Management.renderFilteredResults(allResults);

                    } catch(error) {
                        console.error('Error fetching results:', error);
                        tableBody.innerHTML = `<tr><td colspan="10" class="px-6 py-4 text-center text-red-500">Error: ${error.message}</td></tr>`;
                    }
                });
                document.getElementById('applyResultFilterBtn').click();
            },

            showGradeManagement() {
                const content = document.getElementById('dashboardContent');
                const isTeacher = AppState.currentUser.role === 'guru';

                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold text-gray-900">Daftar Nilai</h2>
                            <div class="flex flex-wrap items-center justify-start sm:justify-end gap-2 w-full sm:w-auto">
                                <button onclick="Management.deleteFilteredGrades()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200"><i class="fas fa-trash-alt mr-2"></i>Hapus</button>
                                <button onclick="Management.downloadGradesPDF()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200"><i class="fas fa-download mr-2"></i>Download PDF</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 mb-6"><div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                             <div><label class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran</label><select id="filterGradeTahunAjaran" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua</option>${UI.getYearOptions()}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Semester</label><select id="filterGradeSemester" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua</option>${UI.getSemesterOptions()}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Kode Soal</label><input type="text" id="filterGradeCode" placeholder="Kode soal" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label><select id="filterGradeSubject" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua</option>${AppState.subjects.map(s => `<option value="${s.nama}">${s.nama}</option>`).join('')}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label><select id="filterGradeClass" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" ${isTeacher ? 'disabled' : ''}><option value="">Semua</option>${AppState.classes.map(c => `<option value="${c.nama}">${c.nama}</option>`).join('')}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Siswa</label><select id="filterGradeStudent" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua Siswa</option></select></div>
                            <div class="flex items-end col-span-full md:col-span-1"><button id="applyGradeFilterBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-search mr-2"></i>Filter</button></div>
                        </div></div>
                        <div class="bg-white rounded-lg shadow overflow-hidden"><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode Soal</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu Selesai</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th></tr></thead><tbody id="gradesTableBody" class="bg-white divide-y divide-gray-200"></tbody></table></div></div></div>`;
                
                if (isTeacher) document.getElementById('filterGradeClass').value = AppState.currentUser.kelas;

                UI.populateStudentFilter('filterGradeClass', 'filterGradeStudent');

                document.getElementById('applyGradeFilterBtn').addEventListener('click', () => {
                    let query = db.collection('grades');
                    const tahunAjaran = document.getElementById('filterGradeTahunAjaran').value;
                    const semester = document.getElementById('filterGradeSemester').value;
                    const kodeSoal = document.getElementById('filterGradeCode').value;
                    const mataPelajaran = document.getElementById('filterGradeSubject').value;
                    const kelas = document.getElementById('filterGradeClass').value;
                    const namaSiswa = document.getElementById('filterGradeStudent').value;

                    query.onSnapshot(snapshot => {
                        if (!AppState.currentUser) return; // FIX: Guard against null user
                        let grades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (tahunAjaran) {
                            grades = grades.filter(g => g.tahunAjaran === tahunAjaran);
                        }
                        if (semester) {
                            grades = grades.filter(g => g.semester === semester);
                        }
                        if (kelas) {
                            grades = grades.filter(g => g.kelas === kelas);
                        }
                        if (mataPelajaran) {
                            grades = grades.filter(g => g.mataPelajaran === mataPelajaran);
                        }
                        if (namaSiswa) {
                            grades = grades.filter(g => g.namaSiswa === namaSiswa);
                        }
                        if (kodeSoal) {
                            grades = grades.filter(g => g.kodeSoal.toLowerCase().includes(kodeSoal.toLowerCase()));
                        }
                        Management.renderFilteredGrades(grades);
                    });
                });
                document.getElementById('applyGradeFilterBtn').click();
            },

            showStudentResults() {
                const content = document.getElementById('dashboardContent');
                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
                            <h2 class="text-2xl font-bold text-gray-900">Hasil Ujian Anda</h2>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran</label>
                                    <select id="filterStudentResultTahunAjaran" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua</option>
                                        ${UI.getYearOptions()}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Semester</label>
                                    <select id="filterStudentResultSemester" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua</option>
                                        ${UI.getSemesterOptions()}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                    <select id="filterStudentResultSubject" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua Mata Pelajaran</option>
                                        ${AppState.subjects.map(s => `<option value="${s.nama}">${s.nama}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button id="applyStudentResultFilterBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                        <i class="fas fa-search mr-2"></i>Filter
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode Soal</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. Soal</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pertanyaan</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jawaban Anda</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentResultsTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
                
                document.getElementById('applyStudentResultFilterBtn').addEventListener('click', async () => {
                    const studentName = AppState.currentUser.nama;
                    const tahunAjaran = document.getElementById('filterStudentResultTahunAjaran').value;
                    const semester = document.getElementById('filterStudentResultSemester').value;
                    const mataPelajaran = document.getElementById('filterStudentResultSubject').value;

                    const tableBody = document.getElementById('studentResultsTableBody');
                    tableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat hasil...</td></tr>';

                    try {
                        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getResults&namaLengkap=${encodeURIComponent(studentName)}`);
                        const result = await response.json();
                        if (result.status !== 'success') throw new Error(result.message);
                        
                        let results = result.data;
                        if (tahunAjaran) results = results.filter(r => r.tahunAjaran === tahunAjaran);
                        if (semester) results = results.filter(r => r.semester === semester);
                        if (mataPelajaran) results = results.filter(r => r.mataPelajaran === mataPelajaran);
                        
                        this.renderStudentResultsTable(results);

                    } catch(error) {
                         tableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center text-red-500">Error: ${error.message}</td></tr>`;
                    }
                });
                document.getElementById('applyStudentResultFilterBtn').click();
            },

            renderStudentResultsTable(results) {
                const resultsTableBody = document.getElementById('studentResultsTableBody');
                if (!resultsTableBody) return;
                
                results.sort((a, b) => {
                    if (a.kodesoal < b.kodesoal) return -1;
                    if (a.kodesoal > b.kodesoal) return 1;
                    return a.noSoal - b.noSoal;
                });

                resultsTableBody.innerHTML = results.length === 0 ?
                    '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Tidak ada hasil ujian yang ditemukan</td></tr>' :
                    results.map((result, index) => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.kodesoal}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.noSoal}</td>
                            <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">${result.pertanyaan}</td>
                            <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">${result.jawabanSiswa}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${result.status === 'benar' ? 'bg-green-100 text-green-800' : result.status === 'salah' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">${result.status}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.nilai}</td>
                        </tr>
                    `).join('');
            },

            showStudentGrades() {
                const content = document.getElementById('dashboardContent');
                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
                            <h2 class="text-2xl font-bold text-gray-900">Daftar Nilai Anda</h2>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran</label>
                                    <select id="filterStudentGradeTahunAjaran" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua</option>
                                        ${UI.getYearOptions()}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Semester</label>
                                    <select id="filterStudentGradeSemester" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua</option>
                                        ${UI.getSemesterOptions()}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                    <select id="filterStudentGradeSubject" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua Mata Pelajaran</option>
                                        ${AppState.subjects.map(s => `<option value="${s.nama}">${s.nama}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button id="applyStudentGradeFilterBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                        <i class="fas fa-search mr-2"></i>Filter
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode Soal</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu Selesai</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentGradesTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
                
                document.getElementById('applyStudentGradeFilterBtn').addEventListener('click', () => {
                    const tahunAjaran = document.getElementById('filterStudentGradeTahunAjaran').value;
                    const semester = document.getElementById('filterStudentGradeSemester').value;
                    const mataPelajaran = document.getElementById('filterStudentGradeSubject').value;
                    let query = db.collection('grades').where('namaSiswa', '==', AppState.currentUser.nama);

                    query.onSnapshot(snapshot => {
                        if (!AppState.currentUser) return; // FIX: Guard against null user
                        let grades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (tahunAjaran) {
                            grades = grades.filter(g => g.tahunAjaran === tahunAjaran);
                        }
                        if (semester) {
                            grades = grades.filter(g => g.semester === semester);
                        }
                        if (mataPelajaran) {
                            grades = grades.filter(g => g.mataPelajaran === mataPelajaran);
                        }
                        this.renderStudentGradesTable(grades);
                    });
                });
                document.getElementById('applyStudentGradeFilterBtn').click();
            },

            renderStudentGradesTable(grades) {
                const gradesTableBody = document.getElementById('studentGradesTableBody');
                if (!gradesTableBody) return;

                grades.sort((a, b) => (new Date(b.waktuSelesai.split(', ')[0].split('/').reverse().join('-') + ' ' + b.waktuSelesai.split(', ')[1])) - (new Date(a.waktuSelesai.split(', ')[0].split('/').reverse().join('-') + ' ' + a.waktuSelesai.split(', ')[1])));

                gradesTableBody.innerHTML = grades.length === 0 ?
                    '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Belum ada data nilai yang ditemukan</td></tr>' :
                    grades.map((grade, index) => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.kodeSoal}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.mataPelajaran}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">${grade.nilai}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${grade.grade === 'A' ? 'bg-green-100 text-green-800' : grade.grade === 'B' ? 'bg-blue-100 text-blue-800' : grade.grade === 'C' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${grade.grade}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.keterangan}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.waktuSelesai}</td>
                        </tr>
                    `).join('');
            },

            async initializeExam(examCode) {
                if (!examCode) return false;

                try {
                    // Firebase Integration: Get questions from Firestore
                    const snapshot = await db.collection('examQuestions').where('kode', '==', examCode).get();
                    if (snapshot.empty) {
                        UI.showNotification('Kode soal tidak ditemukan!', 'error');
                        return false;
                    }

                    const filteredQuestions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const typeOrder = { 'pilihan_ganda': 1, 'isian': 2, 'uraian': 3 };
                    
                    filteredQuestions.sort((a, b) => {
                        const typeA = typeOrder[a.tipe] || 99;
                        const typeB = typeOrder[b.tipe] || 99;

                        if (typeA !== typeB) {
                            return typeA - typeB; // 1. Sort by question type
                        }

                        // 2. If type is the same, sort by creation time
                        const timeA = a.createdAt ? a.createdAt.toMillis() : 0;
                        const timeB = b.createdAt ? b.createdAt.toMillis() : 0;
                        return timeA - timeB; 
                    });

                    AppState.questions = filteredQuestions.map((q, index) => ({
                        originalId: q.id,
                        id: index + 1,
                        type: q.tipe === 'pilihan_ganda' ? 'multiple' : q.tipe === 'isian' ? 'fill' : 'essay',
                        question: q.pertanyaan,
                        options: q.pilihan || [],
                        correct: q.correct,
                        correctAnswer: q.jawabanBenar || null, // Added for isian/uraian
                        gambar: q.gambar || null
                    }));
                    
                    AppState.selectedExamCode = examCode;
                    AppState.currentQuestion = 0;
                    AppState.examAnswers = {};
                    AppState.examTimeLeft = 3600;
                    
                    this.renderQuestion();
                    this.setupQuestionNavigation();
                    this.startTimer();
                    this.updateProgress();

                    // Security: Add tab visibility listener
                    document.addEventListener('visibilitychange', this.handleVisibilityChange);

                    return true;
                } catch (error) {
                    console.error("Error initializing exam: ", error);
                    UI.showNotification('Gagal memuat soal ujian!', 'error');
                    return false;
                }
            },

            renderQuestion() {
                const question = AppState.questions[AppState.currentQuestion];
                const questionContent = document.getElementById('questionContent');
                
                document.getElementById('currentQuestionNum').textContent = AppState.currentQuestion + 1;
                document.getElementById('totalQuestions').textContent = AppState.questions.length;
                
                let content = `
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-4"><h3 class="text-2xl font-bold text-gray-800">Soal No. ${AppState.currentQuestion + 1}</h3><span class="px-3 py-1 text-sm rounded-full ${question.type === 'multiple' ? 'bg-blue-100 text-blue-800' : question.type === 'fill' ? 'bg-green-100 text-green-800' : 'bg-purple-100 text-purple-800'}">${question.type === 'multiple' ? 'Pilihan Ganda' : question.type === 'fill' ? 'Isian' : 'Uraian'}</span></div>
                        <p class="text-lg text-gray-800 leading-relaxed mb-6">${question.question}</p>
                        ${question.gambar ? `<div class="my-4"><img src="${question.gambar}" class="w-full max-w-sm mx-auto rounded-lg shadow-md"></div>` : ''}
                    </div>`;
                
                if (question.type === 'multiple') {
                    content += `<div class="space-y-3">${question.options.map((option, index) => `<label class="flex items-center p-4 border-2 rounded-lg hover:bg-blue-50 hover:border-blue-300 cursor-pointer transition duration-200 ${AppState.examAnswers[AppState.currentQuestion] === index ? 'bg-blue-50 border-blue-500' : 'border-gray-200'}"><input type="radio" name="answer" value="${index}" class="mr-4 w-5 h-5 text-blue-600" ${AppState.examAnswers[AppState.currentQuestion] === index ? 'checked' : ''}><span class="text-gray-800 font-medium mr-3">${String.fromCharCode(65 + index)}.</span><span class="text-gray-800">${option}</span></label>`).join('')}</div>`;
                } else if (question.type === 'fill') {
                    content += `<div><label class="block text-sm font-medium text-gray-700 mb-3">Jawaban:</label><input type="text" name="answer" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg" placeholder="Masukkan jawaban Anda" value="${AppState.examAnswers[AppState.currentQuestion] || ''}"></div>`;
                } else if (question.type === 'essay') {
                    content += `<div><label class="block text-sm font-medium text-gray-700 mb-3">Jawaban:</label><textarea name="answer" rows="8" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg resize-none" placeholder="Tuliskan jawaban Anda dengan lengkap dan jelas">${AppState.examAnswers[AppState.currentQuestion] || ''}</textarea></div>`;
                }
                
                questionContent.innerHTML = content;
                document.getElementById('prevQuestionBtn').disabled = AppState.currentQuestion === 0;
                document.getElementById('nextQuestionBtn').innerHTML = AppState.currentQuestion === AppState.questions.length - 1 ? 'Selesai <i class="fas fa-flag-checkered ml-2"></i>' : 'Selanjutnya <i class="fas fa-chevron-right ml-2"></i>';
                
                questionContent.querySelectorAll('input[name="answer"], textarea[name="answer"]').forEach(input => {
                    input.addEventListener('change', () => {
                        if (input.type === 'radio') AppState.examAnswers[AppState.currentQuestion] = parseInt(input.value);
                        else AppState.examAnswers[AppState.currentQuestion] = input.value;
                        this.updateQuestionNavigation();
                        this.updateProgress();
                    });
                });
            },

            setupQuestionNavigation() {
                const navigationModal = document.getElementById('questionListModalContent');
                if (!navigationModal) return;
                navigationModal.innerHTML = Array.from({ length: AppState.questions.length }, (_, i) => {
                    let stateClass = 'unanswered';
                    if (i === AppState.currentQuestion) stateClass = 'current';
                    else if (AppState.examAnswers[i] !== undefined && AppState.examAnswers[i] !== '') stateClass = 'answered';
                    return `<button class="question-nav-btn w-12 h-12 rounded-full border-2 text-sm font-bold ${stateClass}" onclick="UI.goToQuestionFromModal(${i})">${i + 1}</button>`;
                }).join('');
            },

            updateQuestionNavigation() { this.setupQuestionNavigation(); },

            goToQuestion(index) {
                AppState.currentQuestion = index;
                this.renderQuestion();
                this.updateQuestionNavigation();
                this.updateProgress();
            },

            goToQuestionFromModal(index) {
                this.goToQuestion(index);
                this.hideQuestionListModal();
            },

            updateProgress() {
                const answered = Object.keys(AppState.examAnswers).filter(key => AppState.examAnswers[key] !== undefined && AppState.examAnswers[key] !== '').length;
                const total = AppState.questions.length;
                const percentage = total > 0 ? (answered / total) * 100 : 0;
                document.getElementById('progressBar').style.width = `${percentage}%`;
            },

            startTimer() {
                if (AppState.examTimer) clearInterval(AppState.examTimer);
                AppState.examTimer = setInterval(() => {
                    AppState.examTimeLeft--;
                    document.getElementById('examTimer').textContent = this.formatTime(AppState.examTimeLeft);
                    if (AppState.examTimeLeft <= 0) this.submitExam();
                }, 1000);
            },

            formatTime(seconds) {
                const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
                const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                return `${h}:${m}:${s}`;
            },

            async submitExam() {
                if (AppState.examTimer) clearInterval(AppState.examTimer);

                Swal.fire({
                    title: 'Sedang Memproses Jawaban...',
                    html: 'Mohon tunggu, jawaban Anda sedang disimpan.',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const examDetailsSnapshot = await db.collection('examQuestions').where('kode', '==', AppState.selectedExamCode).limit(1).get();
                const firstQuestionData = !examDetailsSnapshot.empty ? examDetailsSnapshot.docs[0].data() : {};
                const mataPelajaran = firstQuestionData.mataPelajaran || 'Tidak diketahui';
                const semester = firstQuestionData.semester || 'Tidak diketahui';
                const tahunAjaran = firstQuestionData.tahunAjaran || 'Tidak diketahui';

                let totalScore = 0;
                const resultsPayload = [];

                for (const [index, question] of AppState.questions.entries()) {
                    const userAnswer = AppState.examAnswers[index] !== undefined ? String(AppState.examAnswers[index]) : 'Tidak dijawab';
                    let point = 0;
                    let status = 'salah';

                    if (question.type === 'multiple') {
                        if (question.correct !== undefined && AppState.examAnswers[index] === question.correct) {
                            point = 100;
                            status = 'benar';
                        }
                    } else {
                        point = 0;
                        status = 'perlu dinilai';
                    }
                    totalScore += point;

                    resultsPayload.push({
                        kelas: AppState.currentUser.kelas,
                        kodesoal: AppState.selectedExamCode,
                        namaLengkap: AppState.currentUser.nama,
                        noSoal: index + 1,
                        pertanyaan: question.question,
                        jawabanSiswa: userAnswer,
                        status: status,
                        nilai: point,
                        correctAnswer: question.correctAnswer || '',
                        mataPelajaran: mataPelajaran,
                        semester: semester,
                        tahunAjaran: tahunAjaran,
                        timestamp: new Date().toISOString()
                    });
                }
                
                try {
                    // 1. Save exam results to Google Sheet
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'addResults', data: resultsPayload })
                    });
                    const result = await response.json();
                    if (result.status !== 'success') {
                        throw new Error(result.message || 'Gagal menyimpan hasil ke Google Sheet.');
                    }
                
                    // 2. Save final grade to Firebase (remains the same)
                    const finalScore = AppState.questions.length > 0 ? Math.round(totalScore / AppState.questions.length) : 0;
                    const grade = finalScore >= 90 ? 'A' : finalScore >= 80 ? 'B' : finalScore >= 70 ? 'C' : finalScore >= 60 ? 'D' : 'E';

                    await db.collection('grades').add({
                        kelas: AppState.currentUser.kelas,
                        namaSiswa: AppState.currentUser.nama,
                        kodeSoal: AppState.selectedExamCode,
                        mataPelajaran: mataPelajaran,
                        semester: semester,
                        tahunAjaran: tahunAjaran,
                        nilai: finalScore,
                        grade: grade,
                        keterangan: finalScore >= 70 ? 'Lulus' : 'Tidak Lulus',
                        waktuSelesai: new Date().toLocaleString('id-ID')
                    });

                    ExamSecurity.clearAttempts(AppState.currentUser.username, AppState.selectedExamCode);
                    document.removeEventListener('visibilitychange', this.handleVisibilityChange);

                    Swal.fire({
                        title: 'Ujian Selesai!',
                        html: `Terima kasih telah menyelesaikan ujian.<br>Anda akan diarahkan kembali ke halaman login.`,
                        icon: 'success',
                        confirmButtonText: 'OK',
                        allowOutsideClick: false
                    }).then(() => Auth.logout());
                } catch (error) {
                    console.error("Error submitting exam: ", error);
                    Swal.fire({
                        title: 'Error!',
                        text: 'Gagal menyimpan hasil ujian. ' + error.message,
                        icon: 'error'
                    });
                }
            },


            showNotification(message, type = 'error') {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                });
                Toast.fire({ icon: type, title: message });
            },

            getSemesterOptions(selected) {
                const semesters = [
                    "Sumatif Tengah Semester Ganjil",
                    "Sumatif Akhir Semester Ganjil",
                    "Sumatif Tengah Semester Genap",
                    "Sumatif Akhir Semester Genap"
                ];
                return semesters.map(s => `<option value="${s}" ${selected === s ? 'selected' : ''}>${s}</option>`).join('');
            },

            getYearOptions(selected) {
                const currentYear = new Date().getFullYear();
                let options = '';
                for (let i = 0; i < 10; i++) {
                    const year = currentYear + i;
                    const academicYear = `${year}/${year + 1}`;
                    options += `<option value="${academicYear}" ${selected === academicYear ? 'selected' : ''}>${academicYear}</option>`;
                }
                return options;
            },

            populateStudentFilter(classFilterId, studentFilterId) {
                const classFilterElement = document.getElementById(classFilterId);
                const studentFilterElement = document.getElementById(studentFilterId);

                const updateStudentOptions = () => {
                    const selectedClass = classFilterElement.value;
                    let filteredStudents = AppState.users.filter(u => u.role === 'siswa');

                    if (selectedClass) {
                        filteredStudents = filteredStudents.filter(u => u.kelas === selectedClass);
                    } else if (AppState.currentUser.role === 'guru') {
                        const teacherGrade = AppState.currentUser.kelas.charAt(0);
                        filteredStudents = filteredStudents.filter(u => u.kelas.startsWith(teacherGrade));
                    }

                    studentFilterElement.innerHTML = '<option value="">Semua Siswa</option>';
                    filteredStudents
                        .sort((a, b) => a.nama.localeCompare(b.nama))
                        .forEach(student => {
                            const option = document.createElement('option');
                            option.value = student.nama;
                            option.textContent = student.nama;
                            studentFilterElement.appendChild(option);
                        });
                };

                classFilterElement.addEventListener('change', updateStudentOptions);
                updateStudentOptions(); // Initial population
            },

            handleVisibilityChange() {
                if (document.hidden && AppState.currentView === 'exam') {
                    // Stop the timer immediately
                    if (AppState.examTimer) clearInterval(AppState.examTimer);
                    
                    // Remove the listener to prevent multiple triggers
                    document.removeEventListener('visibilitychange', UI.handleVisibilityChange);
                    
                    // Forcefully end the exam session and go back to the dashboard
                    Swal.fire({
                        title: 'Sesi Ujian Dihentikan!',
                        text: 'Anda meninggalkan halaman ujian. Sesi Anda telah dihentikan dan percobaan Anda telah dicatat.',
                        icon: 'warning',
                        confirmButtonText: 'OK',
                        allowOutsideClick: false
                    }).then(() => {
                        AppState.currentView = 'dashboard'; // prevent resubmission
                        UI.showDashboard();
                    });
                }
            }
        };

        // =================================================================
        // EVENT LISTENERS & INITIALIZATION
        // =================================================================
        document.addEventListener('DOMContentLoaded', async function() {
            const loginForm = document.getElementById('loginForm');
            const loginButton = loginForm.querySelector('button[type="submit"]');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginError = document.getElementById('loginError');

            // Show loading state while fetching user data
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Memuat Data...';
            usernameInput.disabled = true;
            passwordInput.disabled = true;

            const dataLoaded = await fetchUsersFromGoogleScript();

            if (dataLoaded) {
                 // Restore login form state
                loginButton.disabled = false;
                loginButton.innerHTML = 'Login';
                usernameInput.disabled = false;
                passwordInput.disabled = false;
                
                // Check for a persisted session after data is loaded
                Auth.checkSession();
            } else {
                 loginButton.innerHTML = 'Gagal Memuat';
            }


            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                
                loginError.classList.add('hidden');
                
                const result = Auth.login(username, password);
                if (result.success) UI.showDashboard();
                else {
                    loginError.textContent = result.message;
                    loginError.classList.remove('hidden');
                }
            });
            
            document.getElementById('togglePasswordVisibility').addEventListener('click', function() {
                const passwordField = document.getElementById('password');
                const icon = this.querySelector('i');
                if (passwordField.type === 'password') {
                    passwordField.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordField.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });

            document.getElementById('prevQuestionBtn').addEventListener('click', () => {
                if (AppState.currentQuestion > 0) {
                    AppState.currentQuestion--;
                    UI.renderQuestion();
                    UI.updateQuestionNavigation();
                    UI.updateProgress();
                }
            });

            document.getElementById('nextQuestionBtn').addEventListener('click', () => {
                if (AppState.currentQuestion < AppState.questions.length - 1) {
                    AppState.currentQuestion++;
                    UI.renderQuestion();
                    UI.updateQuestionNavigation();
                    UI.updateProgress();
                } else {
                    const unansweredCount = AppState.questions.length - Object.keys(AppState.examAnswers).filter(k => AppState.examAnswers[k] !== undefined && AppState.examAnswers[k] !== '').length;
                    let message = 'Apakah Anda yakin ingin mengakhiri ujian?';
                    if (unansweredCount > 0) message += `\n\nAnda memiliki ${unansweredCount} soal yang belum dikerjakan.`;
                    UI.showConfirmModal('Konfirmasi Selesai Ujian', message, () => UI.submitExam());
                }
            });

            document.getElementById('submitExamBtn').addEventListener('click', () => {
                 const unansweredCount = AppState.questions.length - Object.keys(AppState.examAnswers).filter(k => AppState.examAnswers[k] !== undefined && AppState.examAnswers[k] !== '').length;
                let message = 'Apakah Anda yakin ingin mengakhiri ujian?';
                if (unansweredCount > 0) message += `\n\nAnda memiliki ${unansweredCount} soal yang belum dikerjakan.`;
                UI.showConfirmModal('Konfirmasi Selesai Ujian', message, () => UI.submitExam());
            });
            document.getElementById('dashboardLogoutBtn').addEventListener('click', () => UI.showConfirmModal('Konfirmasi Keluar', 'Apakah Anda yakin ingin keluar?', () => Auth.logout()));
            document.getElementById('closeModalBtn').addEventListener('click', () => UI.hideModal());
            document.getElementById('managementModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) UI.hideModal(); });
            
            // Listener for Question List Modal
            document.getElementById('questionListBtn').addEventListener('click', () => UI.showQuestionListModal());
            document.getElementById('closeQuestionListBtn').addEventListener('click', () => UI.hideQuestionListModal());
            document.getElementById('questionListModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) UI.hideQuestionListModal(); });

            // Listener for the new Gemini modal
            const geminiModal = document.getElementById('geminiModal');
            if(geminiModal) {
                geminiModal.addEventListener('click', (e) => { if (e.target === e.currentTarget) UI.hideGeminiModal(); });
            }

            document.getElementById('confirmCancelBtn').addEventListener('click', () => document.getElementById('confirmModal').classList.add('hidden'));

        });

        document.addEventListener('contextmenu', (e) => { if (AppState.currentView === 'exam') e.preventDefault(); });
        document.addEventListener('keydown', (e) => {
            if (AppState.currentView === 'exam' && (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.key === 'u'))) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
